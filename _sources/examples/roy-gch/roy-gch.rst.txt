
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/roy-gch/roy-gch.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_roy-gch_roy-gch.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_roy-gch_roy-gch.py:


Generalized Convex Hull construction for the polymorphs of ROY
==============================================================

:Authors: Michele Ceriotti `@ceriottm <https://github.com/ceriottm/>`_

This notebook analyzes the structures of 264 polymorphs of ROY, from
`Beran et Al, Chemical Science (2022) <https://doi.org/10.1039/D1SC06074K>`__,
comparing the conventional density-energy convex hull with a Generalized Convex Hull
(GCH) analysis (see `Anelli et al., Phys. Rev. Materials
(2018) <https://doi.org/10.1103/PhysRevMaterials.2.103804>`__).
It uses features computed with `featomic <https://github.com/metatensor/featomic>`__
and uses the directional convex hull function from
`scikit-matter <https://github.com/lab-cosmo/scikit-matter>`__
to make the figure.

The GCH construction aims at determining structures, among a collection of
candidate configurations, that are stable or have the potential of being stabilized
by appropriate thermodynamic boundary conditions (pressure, doping, external fields,
...). It does so by using microscopic descriptors to determine the diversity of
structures, and assumes that configurations that are stable relative to other
configurations with similar descriptors are those that could be made
"locally" stable by suitable synthesis conditions.

.. GENERATED FROM PYTHON SOURCE LINES 25-40

.. code-block:: Python


    # sphinx_gallery_thumbnail_number = 3
    import bz2

    import chemiscope
    import matplotlib.tri
    import numpy as np
    from ase.io import read
    from featomic import SoapPowerSpectrum
    from matplotlib import pyplot as plt
    from metatensor import mean_over_samples
    from sklearn.decomposition import PCA
    from skmatter.sample_selection import DirectionalConvexHull









.. GENERATED FROM PYTHON SOURCE LINES 41-42

Loads the structures (that also contain properties in the ``info`` field)

.. GENERATED FROM PYTHON SOURCE LINES 42-55

.. code-block:: Python



    structures = read(
        bz2.open("data/beran_roy_structures.xyz.bz2", "rt"), ":", format="extxyz"
    )

    density = np.array([s.info["density"] for s in structures])
    energy = np.array([s.info["energy"] for s in structures])
    structype = np.array([s.info["type"] for s in structures])
    iknown = np.where(structype == "known")[0]
    iothers = np.where(structype != "known")[0]









.. GENERATED FROM PYTHON SOURCE LINES 56-65

Energy-density hull
-------------------

The Directional Convex Hull routines can be used to compute a
conventional density-energy hull (see
`Hautier (2014)
<http://doi.org/10.1007/128_2013_486>`_ for a pedagogic
introduction to the convex hull construction in the context
of atomistic simulations).

.. GENERATED FROM PYTHON SOURCE LINES 65-69

.. code-block:: Python


    dch_builder = DirectionalConvexHull(low_dim_idx=[0])
    dch_builder.fit(density.reshape(-1, 1), energy)






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <style>#sk-container-id-1 {
      /* Definition of color scheme common for light and dark mode */
      --sklearn-color-text: #000;
      --sklearn-color-text-muted: #666;
      --sklearn-color-line: gray;
      /* Definition of color scheme for unfitted estimators */
      --sklearn-color-unfitted-level-0: #fff5e6;
      --sklearn-color-unfitted-level-1: #f6e4d2;
      --sklearn-color-unfitted-level-2: #ffe0b3;
      --sklearn-color-unfitted-level-3: chocolate;
      /* Definition of color scheme for fitted estimators */
      --sklearn-color-fitted-level-0: #f0f8ff;
      --sklearn-color-fitted-level-1: #d4ebff;
      --sklearn-color-fitted-level-2: #b3dbfd;
      --sklearn-color-fitted-level-3: cornflowerblue;
    }

    #sk-container-id-1.light {
      /* Specific color for light theme */
      --sklearn-color-text-on-default-background: black;
      --sklearn-color-background: white;
      --sklearn-color-border-box: black;
      --sklearn-color-icon: #696969;
    }

    #sk-container-id-1.dark {
      --sklearn-color-text-on-default-background: white;
      --sklearn-color-background: #111;
      --sklearn-color-border-box: white;
      --sklearn-color-icon: #878787;
    }

    #sk-container-id-1 {
      color: var(--sklearn-color-text);
    }

    #sk-container-id-1 pre {
      padding: 0;
    }

    #sk-container-id-1 input.sk-hidden--visually {
      border: 0;
      clip: rect(1px 1px 1px 1px);
      clip: rect(1px, 1px, 1px, 1px);
      height: 1px;
      margin: -1px;
      overflow: hidden;
      padding: 0;
      position: absolute;
      width: 1px;
    }

    #sk-container-id-1 div.sk-dashed-wrapped {
      border: 1px dashed var(--sklearn-color-line);
      margin: 0 0.4em 0.5em 0.4em;
      box-sizing: border-box;
      padding-bottom: 0.4em;
      background-color: var(--sklearn-color-background);
    }

    #sk-container-id-1 div.sk-container {
      /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
         but bootstrap.min.css set `[hidden] { display: none !important; }`
         so we also need the `!important` here to be able to override the
         default hidden behavior on the sphinx rendered scikit-learn.org.
         See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
      display: inline-block !important;
      position: relative;
    }

    #sk-container-id-1 div.sk-text-repr-fallback {
      display: none;
    }

    div.sk-parallel-item,
    div.sk-serial,
    div.sk-item {
      /* draw centered vertical line to link estimators */
      background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
      background-size: 2px 100%;
      background-repeat: no-repeat;
      background-position: center center;
    }

    /* Parallel-specific style estimator block */

    #sk-container-id-1 div.sk-parallel-item::after {
      content: "";
      width: 100%;
      border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
      flex-grow: 1;
    }

    #sk-container-id-1 div.sk-parallel {
      display: flex;
      align-items: stretch;
      justify-content: center;
      background-color: var(--sklearn-color-background);
      position: relative;
    }

    #sk-container-id-1 div.sk-parallel-item {
      display: flex;
      flex-direction: column;
    }

    #sk-container-id-1 div.sk-parallel-item:first-child::after {
      align-self: flex-end;
      width: 50%;
    }

    #sk-container-id-1 div.sk-parallel-item:last-child::after {
      align-self: flex-start;
      width: 50%;
    }

    #sk-container-id-1 div.sk-parallel-item:only-child::after {
      width: 0;
    }

    /* Serial-specific style estimator block */

    #sk-container-id-1 div.sk-serial {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: var(--sklearn-color-background);
      padding-right: 1em;
      padding-left: 1em;
    }


    /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
    clickable and can be expanded/collapsed.
    - Pipeline and ColumnTransformer use this feature and define the default style
    - Estimators will overwrite some part of the style using the `sk-estimator` class
    */

    /* Pipeline and ColumnTransformer style (default) */

    #sk-container-id-1 div.sk-toggleable {
      /* Default theme specific background. It is overwritten whether we have a
      specific estimator or a Pipeline/ColumnTransformer */
      background-color: var(--sklearn-color-background);
    }

    /* Toggleable label */
    #sk-container-id-1 label.sk-toggleable__label {
      cursor: pointer;
      display: flex;
      width: 100%;
      margin-bottom: 0;
      padding: 0.5em;
      box-sizing: border-box;
      text-align: center;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }

    #sk-container-id-1 label.sk-toggleable__label .caption {
      font-size: 0.6rem;
      font-weight: lighter;
      color: var(--sklearn-color-text-muted);
    }

    #sk-container-id-1 label.sk-toggleable__label-arrow:before {
      /* Arrow on the left of the label */
      content: "▸";
      float: left;
      margin-right: 0.25em;
      color: var(--sklearn-color-icon);
    }

    #sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
      color: var(--sklearn-color-text);
    }

    /* Toggleable content - dropdown */

    #sk-container-id-1 div.sk-toggleable__content {
      display: none;
      text-align: left;
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-0);
    }

    #sk-container-id-1 div.sk-toggleable__content.fitted {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-0);
    }

    #sk-container-id-1 div.sk-toggleable__content pre {
      margin: 0.2em;
      border-radius: 0.25em;
      color: var(--sklearn-color-text);
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-0);
    }

    #sk-container-id-1 div.sk-toggleable__content.fitted pre {
      /* unfitted */
      background-color: var(--sklearn-color-fitted-level-0);
    }

    #sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
      /* Expand drop-down */
      display: block;
      width: 100%;
      overflow: visible;
    }

    #sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
      content: "▾";
    }

    /* Pipeline/ColumnTransformer-specific style */

    #sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
      color: var(--sklearn-color-text);
      background-color: var(--sklearn-color-unfitted-level-2);
    }

    #sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
      background-color: var(--sklearn-color-fitted-level-2);
    }

    /* Estimator-specific style */

    /* Colorize estimator box */
    #sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-2);
    }

    #sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-2);
    }

    #sk-container-id-1 div.sk-label label.sk-toggleable__label,
    #sk-container-id-1 div.sk-label label {
      /* The background is the default theme color */
      color: var(--sklearn-color-text-on-default-background);
    }

    /* On hover, darken the color of the background */
    #sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
      color: var(--sklearn-color-text);
      background-color: var(--sklearn-color-unfitted-level-2);
    }

    /* Label box, darken color on hover, fitted */
    #sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
      color: var(--sklearn-color-text);
      background-color: var(--sklearn-color-fitted-level-2);
    }

    /* Estimator label */

    #sk-container-id-1 div.sk-label label {
      font-family: monospace;
      font-weight: bold;
      line-height: 1.2em;
    }

    #sk-container-id-1 div.sk-label-container {
      text-align: center;
    }

    /* Estimator-specific */
    #sk-container-id-1 div.sk-estimator {
      font-family: monospace;
      border: 1px dotted var(--sklearn-color-border-box);
      border-radius: 0.25em;
      box-sizing: border-box;
      margin-bottom: 0.5em;
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-0);
    }

    #sk-container-id-1 div.sk-estimator.fitted {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-0);
    }

    /* on hover */
    #sk-container-id-1 div.sk-estimator:hover {
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-2);
    }

    #sk-container-id-1 div.sk-estimator.fitted:hover {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-2);
    }

    /* Specification for estimator info (e.g. "i" and "?") */

    /* Common style for "i" and "?" */

    .sk-estimator-doc-link,
    a:link.sk-estimator-doc-link,
    a:visited.sk-estimator-doc-link {
      float: right;
      font-size: smaller;
      line-height: 1em;
      font-family: monospace;
      background-color: var(--sklearn-color-unfitted-level-0);
      border-radius: 1em;
      height: 1em;
      width: 1em;
      text-decoration: none !important;
      margin-left: 0.5em;
      text-align: center;
      /* unfitted */
      border: var(--sklearn-color-unfitted-level-3) 1pt solid;
      color: var(--sklearn-color-unfitted-level-3);
    }

    .sk-estimator-doc-link.fitted,
    a:link.sk-estimator-doc-link.fitted,
    a:visited.sk-estimator-doc-link.fitted {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-0);
      border: var(--sklearn-color-fitted-level-3) 1pt solid;
      color: var(--sklearn-color-fitted-level-3);
    }

    /* On hover */
    div.sk-estimator:hover .sk-estimator-doc-link:hover,
    .sk-estimator-doc-link:hover,
    div.sk-label-container:hover .sk-estimator-doc-link:hover,
    .sk-estimator-doc-link:hover {
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-3);
      border: var(--sklearn-color-fitted-level-0) 1pt solid;
      color: var(--sklearn-color-unfitted-level-0);
      text-decoration: none;
    }

    div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
    .sk-estimator-doc-link.fitted:hover,
    div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
    .sk-estimator-doc-link.fitted:hover {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-3);
      border: var(--sklearn-color-fitted-level-0) 1pt solid;
      color: var(--sklearn-color-fitted-level-0);
      text-decoration: none;
    }

    /* Span, style for the box shown on hovering the info icon */
    .sk-estimator-doc-link span {
      display: none;
      z-index: 9999;
      position: relative;
      font-weight: normal;
      right: .2ex;
      padding: .5ex;
      margin: .5ex;
      width: min-content;
      min-width: 20ex;
      max-width: 50ex;
      color: var(--sklearn-color-text);
      box-shadow: 2pt 2pt 4pt #999;
      /* unfitted */
      background: var(--sklearn-color-unfitted-level-0);
      border: .5pt solid var(--sklearn-color-unfitted-level-3);
    }

    .sk-estimator-doc-link.fitted span {
      /* fitted */
      background: var(--sklearn-color-fitted-level-0);
      border: var(--sklearn-color-fitted-level-3);
    }

    .sk-estimator-doc-link:hover span {
      display: block;
    }

    /* "?"-specific style due to the `<a>` HTML tag */

    #sk-container-id-1 a.estimator_doc_link {
      float: right;
      font-size: 1rem;
      line-height: 1em;
      font-family: monospace;
      background-color: var(--sklearn-color-unfitted-level-0);
      border-radius: 1rem;
      height: 1rem;
      width: 1rem;
      text-decoration: none;
      /* unfitted */
      color: var(--sklearn-color-unfitted-level-1);
      border: var(--sklearn-color-unfitted-level-1) 1pt solid;
    }

    #sk-container-id-1 a.estimator_doc_link.fitted {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-0);
      border: var(--sklearn-color-fitted-level-1) 1pt solid;
      color: var(--sklearn-color-fitted-level-1);
    }

    /* On hover */
    #sk-container-id-1 a.estimator_doc_link:hover {
      /* unfitted */
      background-color: var(--sklearn-color-unfitted-level-3);
      color: var(--sklearn-color-background);
      text-decoration: none;
    }

    #sk-container-id-1 a.estimator_doc_link.fitted:hover {
      /* fitted */
      background-color: var(--sklearn-color-fitted-level-3);
    }

    .estimator-table {
        font-family: monospace;
    }

    .estimator-table summary {
        padding: .5rem;
        cursor: pointer;
    }

    .estimator-table summary::marker {
        font-size: 0.7rem;
    }

    .estimator-table details[open] {
        padding-left: 0.1rem;
        padding-right: 0.1rem;
        padding-bottom: 0.3rem;
    }

    .estimator-table .parameters-table {
        margin-left: auto !important;
        margin-right: auto !important;
        margin-top: 0;
    }

    .estimator-table .parameters-table tr:nth-child(odd) {
        background-color: #fff;
    }

    .estimator-table .parameters-table tr:nth-child(even) {
        background-color: #f6f6f6;
    }

    .estimator-table .parameters-table tr:hover {
        background-color: #e0e0e0;
    }

    .estimator-table table td {
        border: 1px solid rgba(106, 105, 104, 0.232);
    }

    /*
        `table td`is set in notebook with right text-align.
        We need to overwrite it.
    */
    .estimator-table table td.param {
        text-align: left;
        position: relative;
        padding: 0;
    }

    .user-set td {
        color:rgb(255, 94, 0);
        text-align: left !important;
    }

    .user-set td.value {
        color:rgb(255, 94, 0);
        background-color: transparent;
    }

    .default td {
        color: black;
        text-align: left !important;
    }

    .user-set td i,
    .default td i {
        color: black;
    }

    /*
        Styles for parameter documentation links
        We need styling for visited so jupyter doesn't overwrite it
    */
    a.param-doc-link,
    a.param-doc-link:link,
    a.param-doc-link:visited {
        text-decoration: underline dashed;
        text-underline-offset: .3em;
        color: inherit;
        display: block;
        padding: .5em;
    }

    /* "hack" to make the entire area of the cell containing the link clickable */
    a.param-doc-link::before {
        position: absolute;
        content: "";
        inset: 0;
    }

    .param-doc-description {
        display: none;
        position: absolute;
        z-index: 9999;
        left: 0;
        padding: .5ex;
        margin-left: 1.5em;
        color: var(--sklearn-color-text);
        box-shadow: .3em .3em .4em #999;
        width: max-content;
        text-align: left;
        max-height: 10em;
        overflow-y: auto;

        /* unfitted */
        background: var(--sklearn-color-unfitted-level-0);
        border: thin solid var(--sklearn-color-unfitted-level-3);
    }

    /* Fitted state for parameter tooltips */
    .fitted .param-doc-description {
        /* fitted */
        background: var(--sklearn-color-fitted-level-0);
        border: thin solid var(--sklearn-color-fitted-level-3);
    }

    .param-doc-link:hover .param-doc-description {
        display: block;
    }

    .copy-paste-icon {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
        background-repeat: no-repeat;
        background-size: 14px 14px;
        background-position: 0;
        display: inline-block;
        width: 14px;
        height: 14px;
        cursor: pointer;
    }
    </style><body><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DirectionalConvexHull(low_dim_idx=[0])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>DirectionalConvexHull</div></div><div><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
            <div class="estimator-table">
                <details>
                    <summary>Parameters</summary>
                    <table class="parameters-table">
                      <tbody>
                    
            <tr class="user-set">
                <td><i class="copy-paste-icon"
                     onclick="copyToClipboard('low_dim_idx',
                              this.parentElement.nextElementSibling)"
                ></i></td>
                <td class="param">low_dim_idx</td>
                <td class="value">[0]</td>
            </tr>
    

            <tr class="default">
                <td><i class="copy-paste-icon"
                     onclick="copyToClipboard('tolerance',
                              this.parentElement.nextElementSibling)"
                ></i></td>
                <td class="param">tolerance</td>
                <td class="value">1e-12</td>
            </tr>
    
                      </tbody>
                    </table>
                </details>
            </div>
        </div></div></div></div></div><script>function copyToClipboard(text, element) {
        // Get the parameter prefix from the closest toggleable content
        const toggleableContent = element.closest('.sk-toggleable__content');
        const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
        const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

        const originalStyle = element.style;
        const computedStyle = window.getComputedStyle(element);
        const originalWidth = computedStyle.width;
        const originalHTML = element.innerHTML.replace('Copied!', '');

        navigator.clipboard.writeText(fullParamName)
            .then(() => {
                element.style.width = originalWidth;
                element.style.color = 'green';
                element.innerHTML = "Copied!";

                setTimeout(() => {
                    element.innerHTML = originalHTML;
                    element.style = originalStyle;
                }, 2000);
            })
            .catch(err => {
                console.error('Failed to copy:', err);
                element.style.color = 'red';
                element.innerHTML = "Failed!";
                setTimeout(() => {
                    element.innerHTML = originalHTML;
                    element.style = originalStyle;
                }, 2000);
            });
        return false;
    }

    document.querySelectorAll('.copy-paste-icon').forEach(function(element) {
        const toggleableContent = element.closest('.sk-toggleable__content');
        const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
        const paramName = element.parentElement.nextElementSibling
            .textContent.trim().split(' ')[0];
        const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

        element.setAttribute('title', fullParamName);
    });


    /**
     * Adapted from Skrub
     * https://github.com/skrub-data/skrub/blob/403466d1d5d4dc76a7ef569b3f8228db59a31dc3/skrub/_reporting/_data/templates/report.js#L789
     * @returns "light" or "dark"
     */
    function detectTheme(element) {
        const body = document.querySelector('body');

        // Check VSCode theme
        const themeKindAttr = body.getAttribute('data-vscode-theme-kind');
        const themeNameAttr = body.getAttribute('data-vscode-theme-name');

        if (themeKindAttr && themeNameAttr) {
            const themeKind = themeKindAttr.toLowerCase();
            const themeName = themeNameAttr.toLowerCase();

            if (themeKind.includes("dark") || themeName.includes("dark")) {
                return "dark";
            }
            if (themeKind.includes("light") || themeName.includes("light")) {
                return "light";
            }
        }

        // Check Jupyter theme
        if (body.getAttribute('data-jp-theme-light') === 'false') {
            return 'dark';
        } else if (body.getAttribute('data-jp-theme-light') === 'true') {
            return 'light';
        }

        // Guess based on a parent element's color
        const color = window.getComputedStyle(element.parentNode, null).getPropertyValue('color');
        const match = color.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*$/i);
        if (match) {
            const [r, g, b] = [
                parseFloat(match[1]),
                parseFloat(match[2]),
                parseFloat(match[3])
            ];

            // https://en.wikipedia.org/wiki/HSL_and_HSV#Lightness
            const luma = 0.299 * r + 0.587 * g + 0.114 * b;

            if (luma > 180) {
                // If the text is very bright we have a dark theme
                return 'dark';
            }
            if (luma < 75) {
                // If the text is very dark we have a light theme
                return 'light';
            }
            // Otherwise fall back to the next heuristic.
        }

        // Fallback to system preference
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }


    function forceTheme(elementId) {
        const estimatorElement = document.querySelector(`#${elementId}`);
        if (estimatorElement === null) {
            console.error(`Element with id ${elementId} not found.`);
        } else {
            const theme = detectTheme(estimatorElement);
            estimatorElement.classList.add(theme);
        }
    }

    forceTheme('sk-container-id-1');</script></body>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 70-72

We can get the indices of the selection, and compute the distance from
the hull

.. GENERATED FROM PYTHON SOURCE LINES 72-77

.. code-block:: Python


    sel = dch_builder.selected_idx_
    dch_dist = dch_builder.score_samples(density.reshape(-1, 1), energy)









.. GENERATED FROM PYTHON SOURCE LINES 78-89

Hull energies
^^^^^^^^^^^^^

Structures on the hull are stable with respect to synthesis at constant
molar volume. Any other structure would lower the energy by decomposing
into a mixture of the two nearest structures along the hull. Given that
the lattice energy is an imperfect proxy for the free energy, and that
synthesis can be performed in other ways than by fixing the density,
structures that are not exactly on the hull might also be stable. One
can compute a “hull energy” as an indication of how close these
structures are to being stable.

.. GENERATED FROM PYTHON SOURCE LINES 90-105

.. code-block:: Python


    fig, ax = plt.subplots(1, 1, figsize=(6, 4))
    ax.scatter(density, energy, c=dch_dist, marker=".")
    ssel = sel[np.argsort(density[sel])]
    ax.plot(density[ssel], energy[ssel], "k--")
    ax.set_xlabel("density / g/cm$^3$")
    ax.set_ylabel("energy / kJ/mol")
    plt.show()

    print(
        f"Mean hull energy for 'known' stable structures {dch_dist[iknown].mean()} kJ/mol"
    )
    print(f"Mean hull energy for 'other' structures {dch_dist[iothers].mean()} kJ/mol")





.. image-sg:: /examples/roy-gch/images/sphx_glr_roy-gch_001.png
   :alt: roy gch
   :srcset: /examples/roy-gch/images/sphx_glr_roy-gch_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Mean hull energy for 'known' stable structures 1.816657381014075 kJ/mol
    Mean hull energy for 'other' structures 6.312730486304906 kJ/mol




.. GENERATED FROM PYTHON SOURCE LINES 106-111

Interactive visualization
^^^^^^^^^^^^^^^^^^^^^^^^^

You can also visualize the hull with ``chemiscope`` in a juptyer notebook.


.. GENERATED FROM PYTHON SOURCE LINES 111-133

.. code-block:: Python


    cs = chemiscope.show(
        structures=structures,
        properties=dict(
            energy=energy,
            density=density,
            hull_energy=dch_dist,
            structure_type=structype,
        ),
        settings={
            "map": {
                "x": {"property": "density"},
                "y": {"property": "energy"},
                "color": {"property": "hull_energy"},
                "symbol": "structure_type",
                "size": {"factor": 35},
            },
            "structure": [{"unitCell": True, "supercell": {"0": 2, "1": 2, "2": 2}}],
        },
    )
    cs



.. chemiscope:: _datasets/fig_roy-gch_001.json.gz
            :mode: default
            :warning_timeout: 2000
        


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">

    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 134-135

Save chemiscope file in a format that can be shared and viewed on `chemiscope.org`

.. GENERATED FROM PYTHON SOURCE LINES 136-138

.. code-block:: Python

    cs.save("roy_ch.json.gz")








.. GENERATED FROM PYTHON SOURCE LINES 139-151

Generalized Convex Hull
-----------------------

A GCH is a similar construction, in which generic structural descriptors
are used in lieu of composition, density or other thermodynamic
constraints. The idea is that configurations that are found close to the
GCH are locally stable with respect to structurally-similar
configurations. In other terms, one can hope to find a thermodynamic
constraint (i.e. synthesis conditions) that act differently on these
structures in comparison with the others, and may potentially stabilize
them.


.. GENERATED FROM PYTHON SOURCE LINES 154-163

Compute structural descriptors
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

A first step is to computes suitable ML descriptors. Here we have used
``featomic`` to evaluate average SOAP features for the structures.
If you don't want to install these dependencies for this example you
can also use the pre-computed features (that are part of skmatter, see
load_roy_dataset), but you can use this as a stub to apply this analysis
to other chemical systems

.. GENERATED FROM PYTHON SOURCE LINES 163-186

.. code-block:: Python


    # from skmatter.datasets import load_roy_dataset
    # features = load_roy_dataset()["features"]

    hypers = {
        "cutoff": {"radius": 4, "smoothing": {"type": "ShiftedCosine", "width": 0.5}},
        "density": {"type": "Gaussian", "width": 0.7},
        "basis": {
            "type": "TensorProduct",
            "max_angular": 4,
            "radial": {"type": "Gto", "max_radial": 5},
        },
    }
    calculator = SoapPowerSpectrum(**hypers)
    rho2i = calculator.compute(structures)
    rho2i = rho2i.keys_to_samples(["center_type"]).keys_to_properties(
        ["neighbor_1_type", "neighbor_2_type"]
    )
    rho2i_structure = mean_over_samples(rho2i, sample_names=["atom", "center_type"])
    np.savez("roy_features.npz", feats=rho2i_structure.block(0).values)

    features = rho2i_structure.block(0).values








.. GENERATED FROM PYTHON SOURCE LINES 187-193

PCA projection
^^^^^^^^^^^^^^

Computes PCA projection to generate low-dimensional descriptors that
reflect structural diversity. Any other dimensionality reduction scheme
could be used in a similar fashion.

.. GENERATED FROM PYTHON SOURCE LINES 193-206

.. code-block:: Python


    pca = PCA(n_components=4)
    pca_features = pca.fit_transform(features)

    fig, ax = plt.subplots(1, 1, figsize=(6, 4))
    scatter = ax.scatter(pca_features[:, 0], pca_features[:, 1], c=energy)
    ax.set_xlabel("PCA[1]")
    ax.set_ylabel("PCA[2]")
    cbar = fig.colorbar(scatter, ax=ax)
    cbar.set_label("energy / kJ/mol")
    plt.show()





.. image-sg:: /examples/roy-gch/images/sphx_glr_roy-gch_002.png
   :alt: roy gch
   :srcset: /examples/roy-gch/images/sphx_glr_roy-gch_002.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 207-211

Builds the Generalized Convex Hull
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Builds a convex hull on the first two PCA features

.. GENERATED FROM PYTHON SOURCE LINES 211-218

.. code-block:: Python


    dch_builder = DirectionalConvexHull(low_dim_idx=[0, 1])
    dch_builder.fit(pca_features, energy)
    sel = dch_builder.selected_idx_
    dch_dist = dch_builder.score_samples(pca_features, energy)









.. GENERATED FROM PYTHON SOURCE LINES 219-221

Generates a 3D Plot


.. GENERATED FROM PYTHON SOURCE LINES 221-234

.. code-block:: Python


    triang = matplotlib.tri.Triangulation(pca_features[sel, 0], pca_features[sel, 1])
    fig = plt.figure(figsize=(7, 5), tight_layout=True)
    ax = fig.add_subplot(projection="3d")
    ax.plot_trisurf(triang, energy[sel], color="gray")
    ax.scatter(pca_features[:, 0], pca_features[:, 1], energy, c=dch_dist)
    ax.set_xlabel("PCA[1]")
    ax.set_ylabel("PCA[2]")
    ax.set_zlabel("energy / kJ/mol\n \n", labelpad=11)
    ax.view_init(25, 110)
    plt.show()





.. image-sg:: /examples/roy-gch/images/sphx_glr_roy-gch_003.png
   :alt: roy gch
   :srcset: /examples/roy-gch/images/sphx_glr_roy-gch_003.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 235-238

The GCH construction improves the separation between the hull energies
of “known” and hypothetical polymorphs (compare with the density-energy
values above)

.. GENERATED FROM PYTHON SOURCE LINES 238-245

.. code-block:: Python


    print(
        f"Mean hull energy for 'known' stable structures {dch_dist[iknown].mean()} kJ/mol"
    )
    print(f"Mean hull energy for 'other' structures {dch_dist[iothers].mean()} kJ/mol")






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Mean hull energy for 'known' stable structures 0.853759556495856 kJ/mol
    Mean hull energy for 'other' structures 5.198870135327014 kJ/mol




.. GENERATED FROM PYTHON SOURCE LINES 246-247

Visualize in a ``chemiscope`` widget

.. GENERATED FROM PYTHON SOURCE LINES 247-304

.. code-block:: Python


    for i, f in enumerate(structures):
        for j in range(len(pca_features[i])):
            f.info["pca_" + str(j + 1)] = pca_features[i, j]
    structure_properties = chemiscope.extract_properties(structures)
    structure_properties.update({"per_atom_energy": energy, "hull_energy": dch_dist})

    # You can save a chemiscope file to disk (for viewing on chemiscope.org)

    chemiscope.write_input(
        "roy_gch.json.gz",
        structures=structures,
        properties=structure_properties,
        meta={
            "name": "GCH for ROY polymorphs",
            "description": """
    Demonstration of the Generalized Convex Hull construction for
    polymorphs of the ROY molecule. Molecules that are closest to
    the hull built on PCA-based structural descriptors and having the
    internal energy predicted by electronic-structure calculations as
    the z axis are the most thermodynamically stable. Indeed most of the
    known polymorphs of ROY are on (or very close) to this hull.
    """,
            "authors": ["Michele Ceriotti <michele.ceriotti@gmail.com>"],
            "references": [
                'A. Anelli, E. A. Engel, C. J. Pickard, and M. Ceriotti, \
                "Generalized convex hull construction for materials discovery," \
                Physical Review Materials 2(10), 103804 (2018).',
                'G. J. O. Beran, I. J. Sugden, C. Greenwell, D. H. Bowskill, \
                C. C. Pantelides, and C. S. Adjiman, "How many more polymorphs of \
                ROY remain undiscovered," Chem. Sci. 13(5), 1288–1297 (2022).',
            ],
        },
        settings={
            "map": {
                "x": {"property": "pca_1"},
                "y": {"property": "pca_2"},
                "z": {"property": "energy"},
                "symbol": "type",
                "color": {"property": "hull_energy"},
                "size": {
                    "factor": 35,
                    "mode": "linear",
                    "property": "",
                    "reverse": True,
                },
            },
            "structure": [
                {
                    "bonds": True,
                    "unitCell": True,
                    "keepOrientation": True,
                }
            ],
        },
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/runner/work/atomistic-cookbook/atomistic-cookbook/examples/roy-gch/roy-gch.py:256: UserWarning: `meta` argument is deprecated, use `metadata` instead
      chemiscope.write_input(




.. GENERATED FROM PYTHON SOURCE LINES 305-306

... and also load one as an interactive viewer

.. GENERATED FROM PYTHON SOURCE LINES 307-310

.. code-block:: Python


    chemiscope.show_input("roy_gch.json.gz")



.. chemiscope:: _datasets/fig_roy-gch_002.json.gz
            :mode: default
            :warning_timeout: 2000
        


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">

    </div>
    <br />
    <br />


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 19.987 seconds)


.. _sphx_glr_download_examples_roy-gch_roy-gch.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: roy-gch.ipynb <roy-gch.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: roy-gch.py <roy-gch.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

        :download:`Download recipe: roy-gch.zip <roy-gch.zip>`
    

.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
