<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html"><link rel="next" title="Water orientation in a pulsed electric field" href="../water-pulsed/water-pulsed.html"><link rel="prev" title="The PET-MAD universal potential" href="../pet-mad/pet-mad.html">
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/pet-mad-uq/pet-mad-uq.html">
        <link rel="prefetch" href="../../_static/cookbook-icon.svg" as="image">

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Uncertainty Quantification with PET-MAD - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input aria-label="Toggle navigation of Recipes grouped by topic" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/universal.html">Universal ML models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input aria-label="Toggle navigation of Recipes grouped by software used" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input aria-label="Toggle navigation of List of all recipes" checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-model/water-model.html">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shiftml/shiftml-example.html">Computing NMR shielding tensors using ShiftML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft-nc.html">Conservative fine-tuning for a PET model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learn-tensors-with-mcov/learn-tensors-with-mcov.html">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft.html">Fine-tuning the PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lode-linear/lode-linear.html">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-nc/pet-mad-nc.html">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metatomic-plumed/metatomic-plumed.html">ML collective variables in PLUMED with metatomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-mts-rpc/mts-rpc.html">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Uncertainty Quantification with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-pulsed/water-pulsed.html">Water orientation in a pulsed electric field</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-pet-mad-uq-pet-mad-uq-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="uncertainty-quantification-with-pet-mad">
<span id="sphx-glr-examples-pet-mad-uq-pet-mad-uq-py"></span><h1>Uncertainty Quantification with PET-MAD<a class="headerlink" href="#uncertainty-quantification-with-pet-mad" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Johannes Spies <a class="reference external" href="https://github.com/johannes-spies">&#64;johannes-spies</a></p>
</dd>
</dl>
<p>This recipe demonstrates three ways of computing errors on the outputs of
ML potential-driven simulations, using as an example the PET-MAD model and its
built-in uncertainty quantification (UQ) capabilities.</p>
<p>In particular, it demonstrates:</p>
<ol class="arabic simple">
<li><p>Estimating uncertainties for single-point calculations on a
full validation dataset.</p></li>
<li><p>Computing energies in simple functions of energy predictions,
namely the value of vacancy formation energies</p></li>
<li><p>Propagating errors from energy predictions to thermodynamic averages
computed over a constant-temperature MD simulation.</p></li>
</ol>
<p>For more information on PET-MAD, have a look at
<a class="reference external" href="https://arxiv.org/abs/2503.14118">Mazitov et al., 2025.</a>
The LLPR uncertainties are introduced in <a class="reference external" href="https://arxiv.org/abs/2403.02251">Bigi et al., 2024.</a> For more
information on dataset calibration and error propagation, see
<a class="reference external" href="https://arxiv.org/abs/2011.08828">Imabalzano et al., 2021.</a></p>
<section id="optional-adding-uq-to-a-model">
<h2>Optional: Adding UQ to a Model<a class="headerlink" href="#optional-adding-uq-to-a-model" title="Link to this heading">¶</a></h2>
<p>Models compatible with <a class="reference external" href="https://metatensor.github.io/metatomic/">metatomic</a> can be
equipped with UQ capabilities through the
<cite>LLPRUncertaintyModel</cite> wrapper included with
<a class="reference external" href="https://metatensor.github.io/metatrain/">metatrain</a>. For running this recipe, you can
use a prebuilt model (the example itself downloads a model from Hugging Face).
For adding UQ support to an existing model, have a look at
the following scaffold. For more information on loading a dataset with the
infrastructure, have a look at
<a class="reference external" href="https://metatensor.github.io/metatrain/latest/dev-docs/utils/data">this section</a>
of the documentation. The pseudocode below also shows how to create an ensemble model
from the last-layer parameters of a model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.llpr</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLPRUncertaintyModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomisticModel</span><span class="p">,</span> <span class="n">ModelMetadata</span>

<span class="c1"># You need to provide a model and datasets (wrapped in PyTorch dataloaders).</span>
<span class="n">model</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">dataloaders</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">}</span>

<span class="c1"># Wrap the model in a module capable of estimating uncertainties, estimate the</span>
<span class="c1"># inverse covariance on the training set, and calibrate the model on the validation</span>
<span class="c1"># set.</span>
<span class="n">llpr_model</span> <span class="o">=</span> <span class="n">LLPRUncertaintyModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">llpr_model</span><span class="o">.</span><span class="n">compute_covariance</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">])</span>
<span class="n">llpr_model</span><span class="o">.</span><span class="n">compute_inverse_covariance</span><span class="p">(</span><span class="n">regularizer</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">llpr_model</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span>

<span class="c1"># In the next step, we show how to enable ensembles in PET-MAD. For that, it is</span>
<span class="c1"># necessary to extract the last-layer parameters of the model. The ensemble</span>
<span class="c1"># generation expects the parameters in a flat-vector format.</span>
<span class="n">last_layer_parameters</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1"># Generate an ensemble with 128 members to compare ensemble uncertainties to LLPR</span>
<span class="c1"># scores.</span>
<span class="n">llpr_model</span><span class="o">.</span><span class="n">generate_ensemble</span><span class="p">({</span><span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">last_layer_parameters</span><span class="p">},</span> <span class="mi">128</span><span class="p">)</span>

<span class="c1"># Save the model to disk using metatomic.</span>
<span class="n">exported_model</span> <span class="o">=</span> <span class="n">AtomisticModel</span><span class="p">(</span>
    <span class="n">llpr_model</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
    <span class="n">ModelMetadata</span><span class="p">(),</span>
    <span class="n">llpr_model</span><span class="o">.</span><span class="n">capabilities</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">exported_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;models/model-with-llpr.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Link to this heading">¶</a></h2>
<p>At the bottom of the page, you’ll find a ZIP file containing the whole example. Note
that it comes with an <cite>environment.yml</cite> file specifying all dependencies required
to execute the script.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlretrieve</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ase.cell</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.ga.utilities</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrechetCellFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io.cif</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_cif</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.optimize.bfgs</span><span class="w"> </span><span class="kn">import</span> <span class="n">BFGS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipi.utils.scripting</span><span class="w"> </span><span class="kn">import</span> <span class="n">InteractiveSimulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelOutput</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch.ase_calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetatomicCalculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">read_systems</span><span class="p">,</span> <span class="n">read_targets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.data.system_to_ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">system_to_ase</span>
</pre></div>
</div>
</section>
<section id="model-loading">
<h2>Model Loading<a class="headerlink" href="#model-loading" title="Link to this heading">¶</a></h2>
<p>All examples require a PET-MAD model with ensemble and LLPR prediction. The
following
code loads a pre-trained model using the ASE-compatible calculator wrapper. Using the
calculator instead of calling the model directly conveniently hides computing
neighbor lists in the calculator.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;models/pet-mad-latest-llpr.pt&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">urlretrieve</span><span class="p">(</span>
        <span class="s2">&quot;https://huggingface.co/jospies/pet-mad-llpr/resolve/main/&quot;</span>
        <span class="s2">&quot;pet-mad-latest-llpr.pt?download=true&quot;</span><span class="p">,</span>
        <span class="s2">&quot;models/pet-mad-latest-llpr.pt&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">calculator</span> <span class="o">=</span> <span class="n">MetatomicCalculator</span><span class="p">(</span><span class="s2">&quot;models/pet-mad-latest-llpr.pt&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="uncertainties-on-a-dataset">
<h2>Uncertainties on a Dataset<a class="headerlink" href="#uncertainties-on-a-dataset" title="Link to this heading">¶</a></h2>
<p>This first example shows how to use PET-MAD to estimate uncertainties on a reference
dataset. We use a reduced version (because of limited compute power in the CI runner)
of the MAD validation set.</p>
<p>For this, we first download the correspond MAD validation dataset record from
Materials Cloud. Then, we prepare the dataset and pass it through the model. In the
final step, we visualize the predicted uncertainties and compare them to a
ground truth method.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;data/mad-val-100.xyz&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">urlretrieve</span><span class="p">(</span>
        <span class="s2">&quot;https://huggingface.co/jospies/pet-mad-llpr/resolve/main/mad-val-100.xyz&quot;</span>
        <span class="s2">&quot;?download=true&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data/mad-val-100.xyz&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Read the dataset&#39;s structures.</span>
<span class="n">systems</span> <span class="o">=</span> <span class="n">read_systems</span><span class="p">(</span><span class="s2">&quot;data/mad-val-100.xyz&quot;</span><span class="p">)</span>

<span class="c1"># Read the dataset&#39;s targets.</span>
<span class="n">target_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;read_from&quot;</span><span class="p">:</span> <span class="s2">&quot;data/mad-val-100.xyz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reader&quot;</span><span class="p">:</span> <span class="s2">&quot;ase&quot;</span><span class="p">,</span>
        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;kcal/mol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scalar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;per_atom&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;num_subtargets&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;forces&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;stress&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;virial&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">targets</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="n">read_targets</span><span class="p">(</span><span class="n">target_config</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

<span class="c1"># Wrap in a `metatrain` compatible way.</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">systems</span><span class="p">,</span> <span class="o">**</span><span class="n">targets</span><span class="p">})</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/runner/work/atomistic-cookbook/atomistic-cookbook/.nox/pet-mad-uq/lib/python3.12/site-packages/metatrain/utils/data/readers/ase.py:62: UserWarning: A conversion to `System` was requested for an `ase.Atoms` object with one or more non-zero cell vectors but where the corresponding boundary conditions are set to `False`. The corresponding cell vectors will be set to zero.
  systems = systems_to_torch(ase_atoms, dtype=torch.float64)
</pre></div>
</div>
<p>After preparation, the dataset can be passed through the model using the calculator
to obtain energy predictions and LLPR scores.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert the systems to an ASE-native `Atoms` object</span>
<span class="n">systems</span> <span class="o">=</span> <span class="p">[</span><span class="n">system_to_ase</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Request the uncertainty in the atomic energy predictions</span>
    <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">ModelOutput</span><span class="p">(),</span>  <span class="c1"># (Needed to request the uncertainties)</span>
    <span class="s2">&quot;energy_uncertainty&quot;</span><span class="p">:</span> <span class="n">ModelOutput</span><span class="p">(),</span>
<span class="p">}</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">systems</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="c1"># Extract the requested results</span>
<span class="n">predicted_energies</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">predicted_uncertainties</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_uncertainty&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
<p>Compute the true prediction error by comparing the predicted energy to the reference
value from dataset.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reference values from dataset.</span>
<span class="n">ground_truth_energies</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
    <span class="p">[</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Compute squared distance between predicted energy and reference value.</span>
<span class="n">empirical_errors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted_energies</span> <span class="o">-</span> <span class="n">ground_truth_energies</span><span class="p">)</span>
</pre></div>
</div>
<p>After gathering predicted uncertainties and computing ground truth error metrics, we
can compare them to each other. Similar to figure S4 of the PET-MAD paper, we present
the data in using a parity plot. For more information about interpreting this type of
plot, see Appendix F.7 of <a class="reference external" href="https://arxiv.org/abs/2403.02251">Bigi et al., 2024</a>.
Note that both the x- and the y-axis use a logarithmic scale, which is more suitable
for inspecting uncertainty values. Because we are using a heavily reduced dataset
(only 100 structures) from the MAD validation set, the parity plot looks very sparse.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hard-code the zoomed in region of the plot and iso-lines.</span>
<span class="n">quantile_lines</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00916</span><span class="p">,</span> <span class="mf">0.10256</span><span class="p">,</span> <span class="mf">0.4309805</span><span class="p">,</span> <span class="mf">1.71796</span><span class="p">,</span> <span class="mf">2.5348</span><span class="p">,</span> <span class="mf">3.44388</span><span class="p">]</span>
<span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="mf">2.5e-2</span><span class="p">,</span> <span class="mf">2.5</span>

<span class="c1"># Create the parity plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Parity of Uncertainties&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Errors&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Uncertainties&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>

<span class="c1"># Plot iso lines.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="p">[</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">quantile_lines</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="p">[</span><span class="n">factor</span> <span class="o">*</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">max_val</span><span class="p">],</span> <span class="s2">&quot;k:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

<span class="c1"># Add actual samples.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predicted_uncertainties</span><span class="p">,</span> <span class="n">empirical_errors</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pet-mad-uq_001.png" srcset="../../_images/sphx_glr_pet-mad-uq_001.png" alt="Parity of Uncertainties" class = "sphx-glr-single-img"/></section>
<section id="uncertainties-in-vacancy-formation-energies">
<h2>Uncertainties in Vacancy Formation Energies<a class="headerlink" href="#uncertainties-in-vacancy-formation-energies" title="Link to this heading">¶</a></h2>
<p>One can use ensemble uncertainty quantification to estimate the error in predicting
<a class="reference external" href="https://en.wikipedia.org/wiki/Vacancy_defect">vacancy formation</a>
energies, which we show in this example.</p>
<p>In this part, we use an aluminum crystal as an example system. The structure file can
be downloaded from
<a class="reference external" href="https://legacy.materialsproject.org/materials/mp-134/">Material Project</a>
as a <cite>.cif</cite> file. We’ve included such a file with the recipe.</p>
<p>The following code loads the structure, computes the energy before creating a defect,
creates a defect, runs a structural optimization, and computes the energy after the
optimization. The energy difference can be used to estimate the vacancy formation
energy.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the crystal from the Materials Project and create a supercell (not strictly</span>
<span class="c1"># necessary).</span>
<span class="n">crystal_structure</span> <span class="o">=</span> <span class="s2">&quot;data/Al_mp-134_conventional_standard.cif&quot;</span>
<span class="n">atoms</span><span class="p">:</span> <span class="n">Atoms</span> <span class="o">=</span> <span class="n">read_cif</span><span class="p">(</span><span class="n">crystal_structure</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="n">supercell</span> <span class="o">=</span> <span class="n">atoms</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">supercell</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calculator</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>  <span class="c1"># store the number of atoms</span>
</pre></div>
</div>
<p>We now compute the vacancy formation energy by keeping track of the ensemble energies
at different stages. Note that calling <cite>.get_potential_energy()</cite> on an <cite>Atoms</cite> object
triggers computing the ensemble values.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get ensemble energy before creating the vacancy</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_ensemble&quot;</span><span class="p">]</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">ModelOutput</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">}</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">supercell</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
<span class="n">bulk</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_ensemble&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Remove an atom (last atom in this case) to create a vacancy</span>
<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">supercell</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># Get ensemble energy right after creating the vacancy</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">supercell</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
<span class="n">right_after_vacancy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_ensemble&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Run structural optimization optimizing both positions and cell layout.</span>
<span class="n">ecf</span> <span class="o">=</span> <span class="n">FrechetCellFilter</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
<span class="n">bfgs</span> <span class="o">=</span> <span class="n">BFGS</span><span class="p">(</span><span class="n">ecf</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="n">bfgs</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># get ensembele energy after optimization</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">supercell</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
<span class="n">vacancy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_ensemble&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>      Step     Time          Energy          fmax
BFGS:    0 12:16:07     -122.585747        0.130144
BFGS:    1 12:16:07     -122.589012        0.122949
BFGS:    2 12:16:07     -122.620888        0.096033
BFGS:    3 12:16:08     -122.621590        0.095035
BFGS:    4 12:16:08     -122.629791        0.078909
BFGS:    5 12:16:08     -122.633263        0.069312
BFGS:    6 12:16:08     -122.635338        0.062530
BFGS:    7 12:16:08     -122.636513        0.060593
BFGS:    8 12:16:08     -122.639427        0.065046
BFGS:    9 12:16:08     -122.644005        0.058952
BFGS:   10 12:16:09     -122.649384        0.035778
</pre></div>
</div>
<p>Compute vacancy formation energy for each ensemble member.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">vacancy_formation</span> <span class="o">=</span> <span class="n">vacancy</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">*</span> <span class="n">bulk</span>
</pre></div>
</div>
<p>Put all ensemble energies in a dataframe and compute the desired statistics.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This dataframe contains each stage&#39;s energies in a single column.</span>
<span class="n">named_stages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Before creating vacancy&quot;</span><span class="p">,</span> <span class="n">bulk</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Right after creating vacancy&quot;</span><span class="p">,</span> <span class="n">right_after_vacancy</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Energy of optimized vacancy&quot;</span><span class="p">,</span> <span class="n">vacancy</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Vacancy formation energy&quot;</span><span class="p">,</span> <span class="n">vacancy_formation</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Convert the PyTorch tensors to flat NumPy vectors</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_stages</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Compute statistics (mean, variance, and standard deviation) on the ensemble energies.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">var</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">std</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
<span class="n">df</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>var</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Before creating vacancy</th>
      <td>-127.312576</td>
      <td>1.347788</td>
      <td>1.160943</td>
    </tr>
    <tr>
      <th>Right after creating vacancy</th>
      <td>-122.585754</td>
      <td>1.116813</td>
      <td>1.056794</td>
    </tr>
    <tr>
      <th>Energy of optimized vacancy</th>
      <td>-122.649384</td>
      <td>1.129493</td>
      <td>1.062776</td>
    </tr>
    <tr>
      <th>Vacancy formation energy</th>
      <td>0.684682</td>
      <td>0.011522</td>
      <td>0.107340</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="uncertainty-propagation-with-md">
<h2>Uncertainty Propagation with MD<a class="headerlink" href="#uncertainty-propagation-with-md" title="Link to this heading">¶</a></h2>
<p>This example shows how to use i-PI to propagate error estimates from an ensemble to
output observables. In this example, we use a box with period boundary conditions
housing 32 water molecules. As an observable, we inspect the <a class="reference external" href="https://en.wikipedia.org/wiki/Radial_distribution_function">Radial Distribution
Function (RDF)</a> between
hydrogen-hydrogen and oxygen-oxygen bonds.</p>
<p>First, we run a simulation with i-PI generating a trajectory and logging other
metrics. The trajectory and committee energies can be used in a subsequent
postprocessing step to obtain RDFs using ASE. These can be re-weighted to propagate
errors from the committee uncertainties to the observed RDFs.</p>
<p>Note also that we set a <cite>uncertainty_threshold</cite> option in the driver. When running
from the command line, this will output a warning every time one of the atomic energy
is estimated to have an uncertainty above that threshold (in eV/atom).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load configuration and run simulation.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/h2o-32.xml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">xml_input</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># prints the relevant sections of the input file</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xml_input</span><span class="p">[:</span><span class="mi">883</span><span class="p">][</span><span class="o">-</span><span class="mi">334</span><span class="p">:])</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">InteractiveSimulation</span><span class="p">(</span><span class="n">xml_input</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  &lt;ffdirect name=&#39;nocons&#39; pbc=&quot;true&quot;&gt;
    &lt;pes&gt;metatomic&lt;/pes&gt;
    &lt;parameters&gt;
        { template:data/h2o-32.xyz,model:models/pet-mad-latest-llpr.pt,device:cpu,
          non_conservative:False,energy_ensemble:True,
          check_consistency:False,
          uncertainty_threshold:7.0e-2
        }
    &lt;/parameters&gt;
  &lt;/ffdirect&gt;

 @system: Initializing system object
 @simulation: Initializing simulation object
@ RANDOM SEED: The seed used in this calculation was 23658
 @init_file: Initializing from file data/h2o-32.xyz. Dimension: length, units: angstrom, cell_units: automatic
 @init_file: Initializing from file data/h2o-32.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/h2o-32.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/h2o-32.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/h2o-32.xyz. Dimension: length, units: automatic, cell_units: automatic
 @initializer: Resampling velocities at temperature 300.0 kelvin
 --- begin input file content ---

  &lt;simulation verbosity=&#39;medium&#39;&gt;
    &lt;output prefix=&#39;h2o-32&#39;&gt;
      &lt;properties filename=&#39;out&#39; stride=&#39;10&#39;&gt;[ time{picosecond}, temperature{kelvin}, kinetic_md ]&lt;/properties&gt;
      &lt;trajectory filename=&#39;pos&#39; format=&#39;xyz&#39; stride=&#39;10&#39; cell_units=&#39;angstrom&#39;&gt;positions{angstrom}&lt;/trajectory&gt;
      &lt;trajectory filename=&#39;committee_pot&#39; stride=&#39;10&#39; extra_type=&#39;committee_pot&#39;&gt;extras&lt;/trajectory&gt;
      &lt;trajectory filename=&#39;atomic_error&#39; stride=&#39;10&#39; extra_type=&#39;energy_uncertainty&#39;&gt;extras&lt;/trajectory&gt;
    &lt;/output&gt;
    &lt;prng&gt;
      &lt;seed&gt;23658&lt;/seed&gt;
    &lt;/prng&gt;
    &lt;ffdirect name=&#39;nocons&#39; pbc=&#39;true&#39;&gt;
      &lt;pes&gt;metatomic&lt;/pes&gt;
      &lt;parameters&gt;{ template:data/h2o-32.xyz,model:models/pet-mad-latest-llpr.pt,device:cpu,
          non_conservative:False,energy_ensemble:True,
          check_consistency:False,
          uncertainty_threshold:7.0e-2
        }&lt;/parameters&gt;
    &lt;/ffdirect&gt;
    &lt;system&gt;
      &lt;initialize nbeads=&#39;1&#39;&gt;
        &lt;file mode=&#39;xyz&#39; units=&#39;angstrom&#39;&gt;data/h2o-32.xyz&lt;/file&gt;
        &lt;velocities mode=&#39;thermal&#39; units=&#39;kelvin&#39;&gt;300&lt;/velocities&gt;
      &lt;/initialize&gt;
      &lt;forces&gt;
        &lt;force forcefield=&#39;nocons&#39;&gt;
        &lt;/force&gt;
      &lt;/forces&gt;
      &lt;ensemble&gt;
        &lt;temperature units=&#39;kelvin&#39;&gt;300&lt;/temperature&gt;
      &lt;/ensemble&gt;
      &lt;motion mode=&#39;dynamics&#39;&gt;
        &lt;fixcom&gt;True&lt;/fixcom&gt;
        &lt;dynamics mode=&#39;nvt&#39;&gt;
          &lt;timestep units=&#39;femtosecond&#39;&gt;0.5&lt;/timestep&gt;
          &lt;thermostat mode=&#39;langevin&#39;&gt;
            &lt;tau units=&#39;femtosecond&#39;&gt;50&lt;/tau&gt;
          &lt;/thermostat&gt;
        &lt;/dynamics&gt;
      &lt;/motion&gt;
    &lt;/system&gt;
  &lt;/simulation&gt;
 ---  end input file content  ---
 @system.bind: Binding the forces
</pre></div>
</div>
<p>Run the simulation.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: To get better estimates, set this to a higher number (perhaps 10000) to</span>
<span class="c1"># run the simulation for a longer time.</span>
<span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>@simulation.run: Average timings at MD step       0. t/step: 1.11586e+00
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0700 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0700 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0703 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0704 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0705 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0705 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0704 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0704 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0703 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0702 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0702 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0702 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0701 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0700 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0700 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0702 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0704 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0706 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0707 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0709 eV/atom exceeds the selected threshold of 0.0700 eV/atom
!W! the estimated atomic energy uncertainty 0.0710 eV/atom exceeds the selected threshold of 0.0700 eV/atom
</pre></div>
</div>
<p>Load the trajectories and compute the per-frame RDFs</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;h2o-32.pos_0.xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

<span class="c1"># Our simulation should only include water molecules. (types: hydrogen=1, oxygen=8)</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>

<span class="c1"># Compute the RDF of each frame (for H-H and for O-O)</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">rdfs_hh</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rdfs_oo</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">xs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="mf">9.86592</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Compute H-H distances</span>
    <span class="n">bins</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_rdf</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">atoms</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">rdfs_hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>

    <span class="c1"># Compute O-O distances</span>
    <span class="n">bins</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_rdf</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">atoms</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">rdfs_oo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
<span class="n">rdfs_hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">rdfs_hh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rdfs_oo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">rdfs_oo</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the i-PI re-weighting utility as a post-processing step.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save RDFs such that they can be read from i-PI.</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;h2o-32_rdfs_h-h.txt&quot;</span><span class="p">,</span> <span class="n">rdfs_hh</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;h2o-32_rdfs_o-o.txt&quot;</span><span class="p">,</span> <span class="n">rdfs_oo</span><span class="p">)</span>

<span class="c1"># Run the re-weighting tool from i-PI for H-H and O-O</span>
<span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;h-h&quot;</span><span class="p">,</span> <span class="s2">&quot;o-o&quot;</span><span class="p">]:</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h2o-32_rdfs_</span><span class="si">{</span><span class="n">ty</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h2o-32_rdfs_</span><span class="si">{</span><span class="n">ty</span><span class="si">}</span><span class="s2">_reweighted.txt&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;i-pi-committee-reweight h2o-32.committee_pot_0 </span><span class="si">{</span><span class="n">infile</span><span class="si">}</span><span class="s2"> --input&quot;</span>
        <span class="s2">&quot; data/h2o-32.xml&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing command:&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Executing command:
        i-pi-committee-reweight h2o-32.committee_pot_0 h2o-32_rdfs_h-h.txt --input data/h2o-32.xml
Executing command:
        i-pi-committee-reweight h2o-32.committee_pot_0 h2o-32_rdfs_o-o.txt --input data/h2o-32.xml
</pre></div>
</div>
<p>Load and display the RDFs after re-weighting. Note that the results might not noisy
due to the small number of MD steps.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the reweighted RDFs.</span>
<span class="n">rdfs_hh_reweighted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;h2o-32_rdfs_h-h_reweighted.txt&quot;</span><span class="p">)</span>
<span class="n">rdfs_oo_reweighted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;h2o-32_rdfs_o-o_reweighted.txt&quot;</span><span class="p">)</span>

<span class="c1"># Extract columns.</span>
<span class="n">rdfs_hh_reweighted_mu</span> <span class="o">=</span> <span class="n">rdfs_hh_reweighted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">rdfs_hh_reweighted_err</span> <span class="o">=</span> <span class="n">rdfs_hh_reweighted</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">rdfs_hh_reweighted_committees</span> <span class="o">=</span> <span class="n">rdfs_hh_reweighted</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>

<span class="n">rdfs_oo_reweighted_mu</span> <span class="o">=</span> <span class="n">rdfs_oo_reweighted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">rdfs_oo_reweighted_err</span> <span class="o">=</span> <span class="n">rdfs_oo_reweighted</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">rdfs_oo_reweighted_committees</span> <span class="o">=</span> <span class="n">rdfs_oo_reweighted</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>

<span class="c1"># Display results.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mus</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">xlim</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;H-H&quot;</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rdfs_hh_reweighted_mu</span><span class="p">,</span> <span class="n">rdfs_hh_reweighted_err</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;O-O&quot;</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rdfs_oo_reweighted_mu</span><span class="p">,</span> <span class="n">rdfs_oo_reweighted_err</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">)),</span>
<span class="p">]:</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;RDF&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;H-H&quot;</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Distance&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">mus</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">z95</span> <span class="o">=</span> <span class="mf">1.96</span>
    <span class="n">rdfs_ci95</span> <span class="o">=</span> <span class="p">(</span><span class="n">mus</span> <span class="o">-</span> <span class="n">z95</span> <span class="o">*</span> <span class="n">errs</span><span class="p">,</span> <span class="n">mus</span> <span class="o">+</span> <span class="n">z95</span> <span class="o">*</span> <span class="n">errs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="o">*</span><span class="n">rdfs_ci95</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CI95&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pet-mad-uq_002.png" srcset="../../_images/sphx_glr_pet-mad-uq_002.png" alt="H-H, O-O" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (1 minutes 5.484 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-pet-mad-uq-pet-mad-uq-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c93ed741514ab32c29634738608b3e65/pet-mad-uq.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">pet-mad-uq.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/cbdb203812ffced6cafdb9de61d5aac5/pet-mad-uq.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">pet-mad-uq.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/cd302343fc5a10dab2e9c44a81189db5/pet-mad-uq.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">pet-mad-uq.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../water-pulsed/water-pulsed.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Water orientation in a pulsed electric field</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../pet-mad/pet-mad.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">The PET-MAD universal potential</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2025, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Uncertainty Quantification with PET-MAD</a><ul>
<li><a class="reference internal" href="#optional-adding-uq-to-a-model">Optional: Adding UQ to a Model</a></li>
<li><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li><a class="reference internal" href="#model-loading">Model Loading</a></li>
<li><a class="reference internal" href="#uncertainties-on-a-dataset">Uncertainties on a Dataset</a></li>
<li><a class="reference internal" href="#uncertainties-in-vacancy-formation-energies">Uncertainties in Vacancy Formation Energies</a></li>
<li><a class="reference internal" href="#uncertainty-propagation-with-md">Uncertainty Propagation with MD</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=de6070a2"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>