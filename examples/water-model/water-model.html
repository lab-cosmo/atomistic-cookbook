<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html"><link rel="next" title="Batch run of CP2K calculations" href="../batch-cp2k/reference-trajectory.html"><link rel="prev" title="A ML model for the electron density of states" href="../dos-align/dos-align.html">
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/water-model/water-model.html">
        <link rel="prefetch" href="../../_static/cookbook-icon.svg" as="image">

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"><!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>Atomistic Water Model for Molecular Dynamics - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input aria-label="Toggle navigation of Recipes grouped by topic" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/universal.html">Universal ML models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input aria-label="Toggle navigation of Recipes grouped by software used" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/eon.html">eon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/gromacs.html">GROMACS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input aria-label="Toggle navigation of List of all recipes" checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shiftml/shiftml-example.html">Computing NMR shielding tensors using ShiftML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft-nc.html">Conservative fine-tuning for a PET model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learn-tensors-with-mcov/learn-tensors-with-mcov.html">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eon-pet-neb/eon-pet-neb.html">Finding Reaction Paths with eOn and a Metatomic Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft.html">Fine-tuning the PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lode-linear/lode-linear.html">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-nc/pet-mad-nc.html">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metatomic-plumed/metatomic-plumed.html">ML collective variables in PLUMED with metatomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-mts-rpc/mts-rpc.html">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ring-polymer-instanton/rpi-rates.html">Ring Polymer Instanton Rate Theory: Tunneling Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-uq/pet-mad-uq.html">Uncertainty Quantification with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-pulsed/water-pulsed.html">Water orientation in a pulsed electric field</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-water-model-water-model-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="atomistic-water-model-for-molecular-dynamics">
<span id="sphx-glr-examples-water-model-water-model-py"></span><h1>Atomistic Water Model for Molecular Dynamics<a class="headerlink" href="#atomistic-water-model-for-molecular-dynamics" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Philip Loche <a class="reference external" href="https://github.com/picocentauri">&#64;PicoCentauri</a>,
Marcel Langer <a class="reference external" href="https://github.com/sirmarcel">&#64;sirmarcel</a> and
Michele Ceriotti <a class="reference external" href="https://github.com/ceriottm">&#64;ceriottm</a></p>
</dd>
</dl>
<p>In this example, we demonstrate how to construct a <a class="reference external" href="https://docs.metatensor.org/metatomic">metatomic model</a> for flexible three and four-point water
model, with parameters optimized for use together with quantum-nuclear-effects-aware
path integral simulations (cf. <a class="reference external" href="http://dx.doi.org/10.1063/1.3167790">Habershon et al., JCP (2009)</a>). The model also demonstrates the use of
<code class="docutils literal notranslate"><span class="pre">torch-pme</span></code>, a Torch library for long-range interactions, and uses the resulting model
to perform demonstrative molecular dynamics simulations.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sphinx_gallery_thumbnail_number = 3</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>

<span class="c1"># Simulation and visualization tools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chemiscope</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Model wrapping and execution tools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="c1"># Core atomistic libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchpme</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">LBFGS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipi.utils.parsing</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_output</span><span class="p">,</span> <span class="n">read_trajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipi.utils.scripting</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">InteractiveSimulation</span><span class="p">,</span>
    <span class="n">forcefield_xml</span><span class="p">,</span>
    <span class="n">motion_nvt_xml</span><span class="p">,</span>
    <span class="n">simulation_xml</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatensor.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">TensorBlock</span><span class="p">,</span> <span class="n">TensorMap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AtomisticModel</span><span class="p">,</span>
    <span class="n">ModelCapabilities</span><span class="p">,</span>
    <span class="n">ModelEvaluationOptions</span><span class="p">,</span>
    <span class="n">ModelMetadata</span><span class="p">,</span>
    <span class="n">ModelOutput</span><span class="p">,</span>
    <span class="n">NeighborListOptions</span><span class="p">,</span>
    <span class="n">System</span><span class="p">,</span>
    <span class="n">load_atomistic_model</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Integration with ASE calculator for metatomic models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch.ase_calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetatomicCalculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vesin.torch.metatensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">NeighborList</span>
</pre></div>
</div>
<section id="the-q-tip4p-f-model">
<h2>The q-TIP4P/F Model<a class="headerlink" href="#the-q-tip4p-f-model" title="Link to this heading">¶</a></h2>
<p>The q-TIP4P/F model uses simple (quasi)-harmonic terms to describe intra-molecular
flexibility - with the use of a quartic term being a specific feature used to describe
the covalent bond softening for a H-bonded molecule - a Lennard-Jones term describing
dispersion and repulsion between O atoms, and an electrostatic potential between
partial charges on the H atoms and the oxygen electron density. For a four-point
model, the oxygen charge is slightly displaced from the oxygen’s position, improving
properties like the <a class="reference external" href="http://dx.doi.org/10.1021/jp410865y">dielectric constant</a>. The
fourth point, referred to as <code class="docutils literal notranslate"><span class="pre">M</span></code>, is implicitly derived from the other atoms of each
water molecule.</p>
<section id="intra-molecular-interactions">
<h3>Intra-molecular interactions<a class="headerlink" href="#intra-molecular-interactions" title="Link to this heading">¶</a></h3>
<p>The molecular bond potential is usually defined as a harmonic potential
of the form</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V_\mathrm{bond}(r) = \frac{k_\mathrm{bond}}{2} (r - r_0)^2\]</div>
</div>
<p>Here, <span class="math notranslate nohighlight">\(k_\mathrm{bond}\)</span> is the force constant and <span class="math notranslate nohighlight">\(r_0\)</span> is the equilibrium
distance. Bonded terms like this require defining a <em>topology</em>, i.e. a list of
pairs of atoms that are actually bonded to each other.</p>
<p>q-TIP4P/F doesn’t use a harmonic potential but a quartic approximation of a Morse
potential, that allows describing the anharmonicity of the O-H covalent bond, and how
the mean distance changes due to zero-point fluctuations and/or hydrogen bonding.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V_\mathrm{bond}(r) = \frac{k_r}{2} [(r-r_0)^2-\alpha_r (r-r_0)^3 +
    \frac{7}{12}\alpha_r^2(r-r_0)^4]\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The harmonic coefficient is related to the coefficients in the original paper
by <span class="math notranslate nohighlight">\(k_r=2 D_r \alpha_r^2\)</span>.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bond_energy</span><span class="p">(</span>
    <span class="n">distances</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coefficient_k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coefficient_alpha</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coefficient_r0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Harmonic potential for bond terms.&quot;&quot;&quot;</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">-</span> <span class="n">coefficient_r0</span>
    <span class="n">alpha_dr</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">*</span> <span class="n">coefficient_alpha</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coefficient_k</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha_dr</span> <span class="o">+</span> <span class="n">alpha_dr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
<p>The parameters reproduce the form of a Morse potential close to the minimum, but
avoids the dissociation of the bond, due to the truncation to the quartic term. These
are the parameters used for q-TIP4P/F</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">OH_kr</span> <span class="o">=</span> <span class="mf">116.09</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">2.287</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># kcal/mol/Å**2</span>
<span class="n">OH_r0</span> <span class="o">=</span> <span class="mf">0.9419</span>  <span class="c1"># Å</span>
<span class="n">OH_alpha</span> <span class="o">=</span> <span class="mf">2.287</span>  <span class="c1"># 1/Å</span>

<span class="n">bond_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">bond_potential</span> <span class="o">=</span> <span class="n">bond_energy</span><span class="p">(</span>
    <span class="n">distances</span><span class="o">=</span><span class="n">bond_distances</span><span class="p">,</span>
    <span class="n">coefficient_k</span><span class="o">=</span><span class="n">OH_kr</span><span class="p">,</span>
    <span class="n">coefficient_alpha</span><span class="o">=</span><span class="n">OH_alpha</span><span class="p">,</span>
    <span class="n">coefficient_r0</span><span class="o">=</span><span class="n">OH_r0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Bond Potential Between Oxygen and Hydrogen&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bond_distances</span><span class="p">,</span> <span class="n">bond_potential</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">OH_r0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;equilibrium distance&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Distance / Å &quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Bond Potential / (kcal/mol)&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_water-model_001.png" srcset="../../_images/sphx_glr_water-model_001.png" alt="Bond Potential Between Oxygen and Hydrogen" class = "sphx-glr-single-img"/><p>The harmonic angle potential describe the bending of the HOH angle, and is usually
modeled as a (curvilinear) harmonic term, defined based on the angle</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V_\mathrm{angle}(\theta) = \frac{k_\mathrm{angle}}{2} (\theta - \theta_0)^2\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(k_\mathrm{angle}\)</span> is the force constant and <span class="math notranslate nohighlight">\(\theta_0\)</span> is the
equilibrium angle between the three atoms.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bend_energy</span><span class="p">(</span>
    <span class="n">angles</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">equilibrium_angle</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Harmonic potential for angular terms.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coefficient</span> <span class="o">*</span> <span class="p">(</span><span class="n">angles</span> <span class="o">-</span> <span class="n">equilibrium_angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
<p>We use the following parameters:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">HOH_angle_coefficient</span> <span class="o">=</span> <span class="mf">87.85</span>  <span class="c1"># kcal/mol/rad^2</span>
<span class="n">HOH_equilibrium_angle</span> <span class="o">=</span> <span class="mf">107.4</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>  <span class="c1"># radians</span>
</pre></div>
</div>
<p>We can plot the bend energy as a function of the angle that is, unsurprisingly,
parabolic around the equilibrium angle</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">angle_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">angle_potential</span> <span class="o">=</span> <span class="n">bend_energy</span><span class="p">(</span>
    <span class="n">angles</span><span class="o">=</span><span class="n">angle_distances</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span>
    <span class="n">coefficient</span><span class="o">=</span><span class="n">HOH_angle_coefficient</span><span class="p">,</span>
    <span class="n">equilibrium_angle</span><span class="o">=</span><span class="n">HOH_equilibrium_angle</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Harmonic Angular Potential for a Water Molecule&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angle_distances</span><span class="p">,</span> <span class="n">angle_potential</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">HOH_equilibrium_angle</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;equilibrium angle&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Angle / degrees&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Harmonic Angular Potential / (kcal/mol)&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_water-model_002.png" srcset="../../_images/sphx_glr_water-model_002.png" alt="Harmonic Angular Potential for a Water Molecule" class = "sphx-glr-single-img"/></section>
<section id="lennard-jones-potential">
<h3>Lennard-Jones Potential<a class="headerlink" href="#lennard-jones-potential" title="Link to this heading">¶</a></h3>
<p>The Lennard-Jones (LJ) potential describes the interaction between a pair of neutral
atoms or molecules, balancing dispersion forces at longer ranges and repulsive forces
at shorter ranges. The LJ potential is defined as:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V_\mathrm{LJ}(r) = 4 \epsilon \left[ \left( \frac{\sigma}{r} \right)^{12} - \left(
\frac{\sigma}{r} \right)^6 \right]\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon\)</span> is the depth of the potential well and <span class="math notranslate nohighlight">\(\sigma\)</span> the
distance at which the potential is zero. For water there is usually only an
oxygen-oxygen Lennard-Jones potential.</p>
<p>We implement the Lennard-Jones potential as a function that takes distances, along
with the parameters <code class="docutils literal notranslate"><span class="pre">sigma</span></code>, <code class="docutils literal notranslate"><span class="pre">epsilon</span></code>, and <code class="docutils literal notranslate"><span class="pre">cutoff</span></code> that indicates the distance
at which the interaction is assumed to be zero. To ensure that there is no
discontinuity an offset is included to shift the curve so it is zero at the cutoff
distance.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">lennard_jones_pair</span><span class="p">(</span>
    <span class="n">distances</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">cutoff</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shifted Lennard-Jones potential for pair terms.&quot;&quot;&quot;</span>
    <span class="n">c6</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">distances</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
    <span class="n">c12</span> <span class="o">=</span> <span class="n">c6</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">lj</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="n">c12</span> <span class="o">-</span> <span class="n">c6</span><span class="p">)</span>

    <span class="n">sigma_cutoff_6</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">sigma_cutoff_6</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_cutoff_6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lj</span> <span class="o">-</span> <span class="n">offset</span>
</pre></div>
</div>
<p>We plot this potential to visualize its behavior, using q-TIP4P/F parameters. To
highlight the offset, we use a cutoff of 5 Å instead of the usual 7 Å.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">O_sigma</span> <span class="o">=</span> <span class="mf">3.1589</span>  <span class="c1"># Å</span>
<span class="n">O_epsilon</span> <span class="o">=</span> <span class="mf">0.1852</span>  <span class="c1"># kcal/mol</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Å &lt;- cut short, to highlight offset</span>

<span class="n">lj_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="n">lj_potential</span> <span class="o">=</span> <span class="n">lennard_jones_pair</span><span class="p">(</span>
    <span class="n">distances</span><span class="o">=</span><span class="n">lj_distances</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">O_sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">O_epsilon</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Lennard-Jones Potential Between Two Oxygen Atoms&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="n">O_epsilon</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Oxygen ε&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">O_sigma</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Oxygen σ&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lj_distances</span><span class="p">,</span> <span class="n">lj_potential</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Distance / Å&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Lennard-Jones Potential / (kcal/mol)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_water-model_003.png" srcset="../../_images/sphx_glr_water-model_003.png" alt="Lennard-Jones Potential Between Two Oxygen Atoms" class = "sphx-glr-single-img"/><p>Due to our reduced cutoff the minimum of the blue line does not touch the red
horizontal line.</p>
</section>
<section id="electrostatic-potential">
<h3>Electrostatic Potential<a class="headerlink" href="#electrostatic-potential" title="Link to this heading">¶</a></h3>
<p>The long-ranged nature of electrostatic interactions makes computing them
in simulations non-trivial. For periodic systems the Coulomb energy is given by:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V_\mathrm{Coulomb} = \frac{1}{2} \sum_{i,j} \sideset{}{'}\sum_{\boldsymbol n \in
 \mathcal{Z}} \frac{1}{4\pi\epsilon_0}
 \frac{q_i q_j}{\left|\boldsymbol r_{ij} + \boldsymbol{n L}\right|}\]</div>
</div>
<p>The sum over <span class="math notranslate nohighlight">\(\boldsymbol n\)</span> takes into account the periodic images of the
charges and the prime indicates that in the case <span class="math notranslate nohighlight">\(i=j\)</span> the term <span class="math notranslate nohighlight">\(n=0\)</span> must
be omitted. Further <span class="math notranslate nohighlight">\(\boldsymbol r_{ij} = \boldsymbol r_i - \boldsymbol r_j\)</span> and
<span class="math notranslate nohighlight">\(\boldsymbol L\)</span> is the length of the (cubic)simulation box.</p>
<p>Since this sum is conditionally convergent it isn’t computable using a direct sum.
Instead the Ewald summation, published in 1921, remains a foundational method that
effectively defines how to compute the energy and forces of such systems. To further
speed the methods, mesh based algorithm suing fast Fourier transformation have been
developed, such as the Particle-Particle Particle-Mesh (P3M) algorithm. For further
details we refer to a paper by <a class="reference external" href="https://aip.scitation.org/doi/10.1063/1.477414">Deserno and Holm</a>.</p>
<p>We use a <em>Torch</em> implementation of the P3M method within the <code class="docutils literal notranslate"><span class="pre">torch-pme</span></code> package.
The core class we use is the <a class="reference external" href="https://lab-cosmo.github.io/torch-pme/latest/references/calculators/p3m.html#torchpme.P3MCalculator" title="(in torch-pme)"><code class="xref py py-class docutils literal notranslate"><span class="pre">torchpme.P3MCalculator</span></code></a> class - you can read more
and see specific examples in the <a class="reference external" href="https://lab-cosmo.github.io/torch-pme">torchpme documentation</a> As a demonstration we use two
charges in a cubic cell, computing the electrostatic energy as a function of distance</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">O_charge</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.84</span>
<span class="n">coulomb_distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10.0</span>
</pre></div>
</div>
<p>We also use the parameter-tuning functionality of <code class="docutils literal notranslate"><span class="pre">torchpme</span></code>, to provide efficient
evaluation at the desired level of accuracy. This is achieved calling
<a class="reference external" href="https://lab-cosmo.github.io/torch-pme/latest/references/tuning/tune_p3m.html#torchpme.tuning.tune_p3m" title="(in torch-pme)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torchpme.tuning.tune_p3m()</span></code></a> on a template of the target structure</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">charges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">O_charge</span><span class="p">,</span> <span class="o">-</span><span class="n">O_charge</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">positions_coul</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">neighbor_distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">4.0</span><span class="p">])</span>

<span class="n">p3m_smearing</span><span class="p">,</span> <span class="n">p3m_parameters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">tuning</span><span class="o">.</span><span class="n">tune_p3m</span><span class="p">(</span>
    <span class="n">charges</span><span class="p">,</span>
    <span class="n">cell</span><span class="p">,</span>
    <span class="n">positions_coul</span><span class="p">,</span>
    <span class="n">cutoff</span><span class="p">,</span>
    <span class="n">neighbor_indices</span><span class="p">,</span>
    <span class="n">neighbor_distances</span><span class="p">,</span>
    <span class="n">accuracy</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">p3m_prefactor</span> <span class="o">=</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">prefactors</span><span class="o">.</span><span class="n">kcalmol_A</span>
</pre></div>
</div>
<p>The hydrogen charge is derived from the oxygen charge as <span class="math notranslate nohighlight">\(q_H = -q_O/2\)</span>. The
<code class="docutils literal notranslate"><span class="pre">smearing</span></code> and <code class="docutils literal notranslate"><span class="pre">mesh_spacing</span></code> parameters are the central parameters for P3M and
are crucial to ensure the correct energy calculation. We now compute the electrostatic
energy between two point charges using the P3M algorithm.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">p3m_calculator</span> <span class="o">=</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">P3MCalculator</span><span class="p">(</span>
    <span class="n">potential</span><span class="o">=</span><span class="n">torchpme</span><span class="o">.</span><span class="n">CoulombPotential</span><span class="p">(</span><span class="n">p3m_smearing</span><span class="p">),</span>
    <span class="o">**</span><span class="n">p3m_parameters</span><span class="p">,</span>
    <span class="n">prefactor</span><span class="o">=</span><span class="n">p3m_prefactor</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For the inference, we need a neighbor list and distances which we compute
“manually”. Typically, the neighbors are provided by the simulation engine.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

<span class="n">potential</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coulomb_distances</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i_dist</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coulomb_distances</span><span class="p">):</span>
    <span class="n">positions_coul</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="n">dist</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">O_charge</span><span class="p">,</span> <span class="o">-</span><span class="n">O_charge</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">neighbor_distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">dist</span><span class="p">])</span>

    <span class="n">potential</span><span class="p">[</span><span class="n">i_dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">p3m_calculator</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
        <span class="n">positions</span><span class="o">=</span><span class="n">positions_coul</span><span class="p">,</span>
        <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
        <span class="n">charges</span><span class="o">=</span><span class="n">charges</span><span class="p">,</span>
        <span class="n">neighbor_indices</span><span class="o">=</span><span class="n">neighbor_indices</span><span class="p">,</span>
        <span class="n">neighbor_distances</span><span class="o">=</span><span class="n">neighbor_distances</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>We plot the electrostatic potential between two point charges.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Electrostatic Potential Between Two Point Charges&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coulomb_distances</span><span class="p">,</span> <span class="n">potential</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Distance / Å&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Electrostatic Potential / (kcal/mol)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_water-model_004.png" srcset="../../_images/sphx_glr_water-model_004.png" alt="Electrostatic Potential Between Two Point Charges" class = "sphx-glr-single-img"/><p>The potential shape may appear unusual due to computations within a periodic box. For
small distances, the potential behaves like <span class="math notranslate nohighlight">\(1/r\)</span>, but it increases again as
charges approach across periodic boundaries.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In most water models, Coulomb interactions within each molecule are excluded, as
intramolecular energies are already parametrized by the bond and angle interactions.
Therefore, in our model defined below we first compute the electrostatic energy of
all atoms and then subtract interactions between bonded atoms.</p>
</div>
</section>
</section>
<section id="implementation-as-a-tip4p-f-torch-module">
<h2>Implementation as a TIP4P/f <code class="docutils literal notranslate"><span class="pre">torch</span></code> module<a class="headerlink" href="#implementation-as-a-tip4p-f-torch-module" title="Link to this heading">¶</a></h2>
<p>In order to implement a Q-TIP4P/f potential in practice, we first build a class that
follows the interface of a <em>metatomic</em> model. This requires defining the atomic
structure in terms of a <code class="xref py py-class docutils literal notranslate"><span class="pre">metatomic.torch.System</span></code> object - a simple
container for positions, cell, and atomic types, that can also be enriched with one or
more <code class="xref py py-class docutils literal notranslate"><span class="pre">metatomic.torchist</span></code> objects holding neighbor
distance information. This is usually provided by the code used to perform a
simulation, but can be also computed explicitly using <code class="docutils literal notranslate"><span class="pre">ase</span></code> or <a class="reference external" href="https://luthaf.fr/vesin/latest/index.html">vesin</a>, as we do here.</p>
<p>For running our simulation we use a small waterbox containing 32 water molecules.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;data/water_32.xyz&quot;</span><span class="p">)</span>

<span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="p">[</span><span class="n">atoms</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span><span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;unitCell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span>
<span class="p">)</span>
</pre></div>
</div>
<!-- begin headers -->
<!-- Load all dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

<!-- JS scripts -->
<script src="../../_static/chemiscope.min.js"></script>
<script src="../../_static/chemiscope-sphinx.js"></script>

<!-- CSS styles -->
<link rel="stylesheet" href="../../_static/chemiscope-sphinx.css" type="text/css" />
<!-- end headers -->

<!-- Error display -->
<div id="chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba-error-display" class="chemiscope-sphinx-error">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba-error-display')">
        &times;
    </button>
</div>

<!-- Warning Display -->
<div id="chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-44ea1a5b-f868-461a-a6cd-15c76bfe19ba', '../../_datasets/7be6a9ef7392bb1bee1e52820070c3687948033449c8a26527f7f07db9185161-fig_water-model_001.json.gz', 'structure', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /><p>We transform the ase Atoms object into a metatomic system and define the
options for the neighbor list.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span>
    <span class="n">types</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()),</span>
    <span class="n">positions</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span>
    <span class="n">cell</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">array</span><span class="p">),</span>
    <span class="n">pbc</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">nlo</span> <span class="o">=</span> <span class="n">NeighborListOptions</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span> <span class="n">full_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">calculator</span> <span class="o">=</span> <span class="n">NeighborList</span><span class="p">(</span><span class="n">nlo</span><span class="p">,</span> <span class="n">length_unit</span><span class="o">=</span><span class="s2">&quot;Angstrom&quot;</span><span class="p">)</span>
<span class="n">neighbors</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">)</span>
</pre></div>
</div>
<p>Neighbor lists are stored within <code class="docutils literal notranslate"><span class="pre">metatensor</span></code> as <a class="reference external" href="https://docs.metatensor.org/latest/core/reference/python/block.html#metatensor.TensorBlock" title="(in metatensor)"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatensor.TensorBlock</span></code></a>
objects, if you’re curious</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">neighbors</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorBlock
    samples (6001): [&#39;first_atom&#39;, &#39;second_atom&#39;, &#39;cell_shift_a&#39;, &#39;cell_shift_b&#39;, &#39;cell_shift_c&#39;]
    components (3): [&#39;xyz&#39;]
    properties (1): [&#39;distance&#39;]
    gradients: None
</pre></div>
</div>
<section id="helper-functions-for-molecular-geometry">
<h3>Helper functions for molecular geometry<a class="headerlink" href="#helper-functions-for-molecular-geometry" title="Link to this heading">¶</a></h3>
<p>In order to compute the different terms in the Q-TIP4P/f potential, we need to extract
some information on the geometry of the water molecule. To keep the model class clean,
we define a helper functions that do two things.</p>
<p>First, it computes O-H covalent bond lengths and angle. We use heuristics to identify
the covalent bonds as the shortest O-H distances in a simulation. This is necessary
when using the model with an external code, that might re-order atoms internally (as
is e.g. the case for LAMMPS). The heuristics here may fail in case molecules get too
close together, or at very high temperature.</p>
<p>Second, it computes the position of the virtual “M sites”, the position of the O
charge in a TIP4P-like model. We also need distances to compute range-separated
electrostatics, which we obtain manipulating the neighbor list that is pre-attached to
the system. Thanks to the fact we rely on <code class="docutils literal notranslate"><span class="pre">torch</span></code> autodifferentiation mechanism, the
forces acting on the virtual sites will be automatically split between O and H atoms,
in a way that is consistent with the definition.</p>
<p>Forces acting on the M sites will be automatically split between O and H atoms, in a
way that is consistent with the definition.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_molecular_geometry</span><span class="p">(</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">nlo</span><span class="p">:</span> <span class="n">NeighborListOptions</span><span class="p">,</span>
    <span class="n">m_gamma</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">m_charge</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute bond distances, angles and charge site positions for each molecules.&quot;&quot;&quot;</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">)</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">types</span>

    <span class="c1"># get neighbor idx and vectors as torch tensors</span>
    <span class="n">neigh_ij</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="s2">&quot;first_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;second_atom&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
    <span class="n">neigh_dij</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># get all OH distances and their sorting order</span>
    <span class="n">oh_mask</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="n">neigh_ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">species</span><span class="p">[</span><span class="n">neigh_ij</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">oh_ij</span> <span class="o">=</span> <span class="n">neigh_ij</span><span class="p">[</span><span class="n">oh_mask</span><span class="p">]</span>
    <span class="n">oh_dij</span> <span class="o">=</span> <span class="n">neigh_dij</span><span class="p">[</span><span class="n">oh_mask</span><span class="p">]</span>
    <span class="n">oh_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">oh_dij</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">oh_sort</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">oh_dist</span><span class="p">)</span>

    <span class="c1"># gets the oxygen indices in the bonds, sorted by distance</span>
    <span class="n">oh_oidx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">oh_ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">,</span> <span class="n">oh_ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">oh_ij</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])[</span><span class="n">oh_sort</span><span class="p">]</span>
    <span class="c1"># makes sure we always consider bonds in the O-&gt;H direction</span>
    <span class="n">oh_dij</span> <span class="o">=</span> <span class="n">oh_dij</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">oh_ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># we assume that the first n_oxygen*2 bonds cover all water molecules.</span>
    <span class="c1"># if not we throw an error</span>
    <span class="n">o_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">n_oh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_idx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">oh_oidx_sort</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">oh_oidx</span><span class="p">[:</span><span class="n">n_oh</span><span class="p">])</span>

    <span class="n">oh_dij_oidx</span> <span class="o">=</span> <span class="n">oh_oidx</span><span class="p">[</span><span class="n">oh_oidx_sort</span><span class="p">]</span>  <span class="c1"># indices of the O atoms for each dOH</span>
    <span class="c1"># if each O index appears twice, this should be a vector of zeros</span>
    <span class="n">twoo_chk</span> <span class="o">=</span> <span class="n">oh_dij_oidx</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">oh_dij_oidx</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">twoo_chk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot assign OH bonds to water molecules univocally.&quot;</span><span class="p">)</span>

    <span class="c1"># finally, we compute O-&gt;H1 and O-&gt;H2 for each water molecule</span>
    <span class="n">oh_dij_sort</span> <span class="o">=</span> <span class="n">oh_dij</span><span class="p">[</span><span class="n">oh_sort</span><span class="p">[:</span><span class="n">n_oh</span><span class="p">]][</span><span class="n">oh_oidx_sort</span><span class="p">]</span>
    <span class="n">doh_1</span> <span class="o">=</span> <span class="n">oh_dij_sort</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">doh_2</span> <span class="o">=</span> <span class="n">oh_dij_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">oh_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">doh_1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">doh_2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">oh_dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Unphysical O-H bond length. Check that the molecules are entire, and &quot;</span>
            <span class="s2">&quot;atoms are listed in the expected OHH order.&quot;</span>
        <span class="p">)</span>

    <span class="n">hoh_angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">doh_1</span> <span class="o">*</span> <span class="n">doh_2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">oh_dist</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">doh_1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">oh_dist</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">doh_2</span><span class="p">)</span> <span class="p">:])</span>
    <span class="p">)</span>

    <span class="c1"># now we use this information to build the M sites</span>
    <span class="c1"># we first put the O-&gt;H vectors in the same order as the</span>
    <span class="c1"># positions. This allows us to manipulate all atoms at once later</span>
    <span class="n">oh1_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">oh1_vecs</span><span class="p">[</span><span class="n">oh_dij_oidx</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">doh_1</span>
    <span class="n">oh2_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">oh2_vecs</span><span class="p">[</span><span class="n">oh_dij_oidx</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">doh_2</span>

    <span class="c1"># we compute the vectors O-&gt;M displacing the O to the M sites</span>
    <span class="n">om_displacements</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">m_gamma</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">oh1_vecs</span> <span class="o">+</span> <span class="n">oh2_vecs</span><span class="p">)</span>

    <span class="c1"># creates a new System with the m-sites</span>
    <span class="n">m_system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span>
        <span class="n">types</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">types</span><span class="p">,</span>
        <span class="n">positions</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span> <span class="o">+</span> <span class="n">om_displacements</span><span class="p">,</span>
        <span class="n">cell</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
        <span class="n">pbc</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># adjust neighbor lists to point at the m sites rather than O atoms. this assumes</span>
    <span class="c1"># this won&#39;t have atoms cross the cutoff, which is of course only approximately</span>
    <span class="c1"># true, so one should use a slightly larger-than-usual cutoff nb - this is reshaped</span>
    <span class="c1"># to match the values in a NL tensorblock</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">)</span>
    <span class="n">i_idx</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="s2">&quot;first_atom&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">j_idx</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="s2">&quot;second_atom&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">m_nl</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
        <span class="n">nl</span><span class="o">.</span><span class="n">values</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">om_displacements</span><span class="p">[</span><span class="n">j_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">om_displacements</span><span class="p">[</span><span class="n">i_idx</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">nl</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
        <span class="n">nl</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
        <span class="n">nl</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">m_system</span><span class="o">.</span><span class="n">add_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">,</span> <span class="n">m_nl</span><span class="p">)</span>

    <span class="c1"># set charges of all atoms</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="n">m_charge</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m_charge</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Create metadata for the charges TensorBlock</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span>
        <span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">charges</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span>
        <span class="s2">&quot;charge&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">charges</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="n">charges</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[],</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span>
    <span class="p">)</span>

    <span class="n">tensor</span> <span class="o">=</span> <span class="n">TensorMap</span><span class="p">(</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">Labels</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">charges</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">m_system</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;charges&quot;</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="n">tensor</span><span class="p">)</span>

    <span class="c1"># intra-molecular distances with M sites (for self-energy removal)</span>
    <span class="n">hh_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">doh_1</span> <span class="o">-</span> <span class="n">doh_2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dmh_1</span> <span class="o">=</span> <span class="n">doh_1</span> <span class="o">-</span> <span class="n">om_displacements</span><span class="p">[</span><span class="n">oh_dij_oidx</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">dmh_2</span> <span class="o">=</span> <span class="n">doh_2</span> <span class="o">-</span> <span class="n">om_displacements</span><span class="p">[</span><span class="n">oh_dij_oidx</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">mh_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">dmh_1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">dmh_2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">oh_dist</span><span class="p">,</span> <span class="n">hoh_angles</span><span class="p">,</span> <span class="n">m_system</span><span class="p">,</span> <span class="n">mh_dist</span><span class="p">,</span> <span class="n">hh_dist</span>
</pre></div>
</div>
</section>
<section id="defining-the-model">
<h3>Defining the model<a class="headerlink" href="#defining-the-model" title="Link to this heading">¶</a></h3>
<p>Armed with these functions, the definitions of bonded and LJ potentials, and the
<a class="reference external" href="https://lab-cosmo.github.io/torch-pme/latest/references/calculators/p3m.html#torchpme.P3MCalculator" title="(in torch-pme)"><code class="xref py py-class docutils literal notranslate"><span class="pre">torchpme.P3MCalculator</span></code></a> class, we can define with relatively small effort the
actual model. We do not hard-code the specific parameters of the Q-TIP4P/f potential
(so that in principle this class can be used for classical TIP4P, and - by setting
<code class="docutils literal notranslate"><span class="pre">m_gamma</span></code> to one - a three-point water model).</p>
<p>A few points worth noting: (1) As discussed above we define a bare Coulomb potential
(that pretty much computes <span class="math notranslate nohighlight">\(1/r\)</span>) which we need to subtract the molecular “self
electrostatic interaction”; (2) units are expected to be Å for distances, kcal/mol for
energies, and radians for angles; (3) model parameters are registered as <code class="docutils literal notranslate"><span class="pre">buffers</span></code>;
(4) P3M parameters can also be given, in the format returned by
<a class="reference external" href="https://lab-cosmo.github.io/torch-pme/latest/references/tuning/tune_p3m.html#torchpme.tuning.tune_p3m" title="(in torch-pme)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torchpme.tuning.tune_p3m()</span></code></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">forward</span></code> call is a relatively straightforward combination of all the helper
functions defined further up in this file, and should be relatively easy to follow.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WaterModel</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lj_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lj_epsilon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">m_gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">m_charge</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">oh_bond_eq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">oh_bond_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">oh_bond_alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">hoh_angle_eq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">hoh_angle_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">p3m_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p3m_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># should give a ~1e-4 relative accuracy on forces</span>
            <span class="n">p3m_options</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;interpolation_nodes&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;mesh_spacing&quot;</span><span class="p">:</span> <span class="mf">1.33</span><span class="p">},</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">p3m_smearing</span><span class="p">,</span> <span class="n">p3m_parameters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">p3m_options</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p3m_calculator</span> <span class="o">=</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">metatensor</span><span class="o">.</span><span class="n">P3MCalculator</span><span class="p">(</span>
            <span class="n">potential</span><span class="o">=</span><span class="n">torchpme</span><span class="o">.</span><span class="n">CoulombPotential</span><span class="p">(</span><span class="n">p3m_smearing</span><span class="p">),</span>
            <span class="o">**</span><span class="n">p3m_parameters</span><span class="p">,</span>
            <span class="n">prefactor</span><span class="o">=</span><span class="n">torchpme</span><span class="o">.</span><span class="n">prefactors</span><span class="o">.</span><span class="n">kcalmol_A</span><span class="p">,</span>  <span class="c1"># consistent units</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coulomb</span> <span class="o">=</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">CoulombPotential</span><span class="p">()</span>

        <span class="c1"># We use a half neighborlist and allow to have pairs farther than cutoff</span>
        <span class="c1"># (`strict=False`) since this is not problematic for PME and may speed up the</span>
        <span class="c1"># computation of the neighbors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlo</span> <span class="o">=</span> <span class="n">NeighborListOptions</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">full_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cutoff</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;lj_sigma&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lj_sigma</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;lj_epsilon&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lj_epsilon</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;m_gamma&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">m_gamma</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;m_charge&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">m_charge</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;oh_bond_eq&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">oh_bond_eq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;oh_bond_k&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">oh_bond_k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;oh_bond_alpha&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">oh_bond_alpha</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;hoh_angle_eq&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hoh_angle_eq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;hoh_angle_k&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hoh_angle_k</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">requested_neighbor_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the list of neighbor list options that are needed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nlo</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_systems</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">systems</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">System</span><span class="p">],</span>
        <span class="n">selected_atoms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Labels</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="n">TensorBlock</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;only one system supported, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">system_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">systems</span><span class="p">[</span><span class="n">system_i</span><span class="p">]</span>

        <span class="c1"># select only real atoms and discard ghosts</span>
        <span class="c1"># (this is to work in codes like LAMMPS that provide a neighbor</span>
        <span class="c1"># list that also includes &quot;domain decomposition&quot; neigbhbors)</span>
        <span class="k">if</span> <span class="n">selected_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_system_mask</span> <span class="o">=</span> <span class="n">selected_atoms</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">system_i</span>
            <span class="n">current_atoms</span> <span class="o">=</span> <span class="n">selected_atoms</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;atom&quot;</span><span class="p">)</span>
            <span class="n">current_atoms</span> <span class="o">=</span> <span class="n">current_atoms</span><span class="p">[</span><span class="n">current_system_mask</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

            <span class="n">types</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">current_atoms</span><span class="p">]</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">current_atoms</span><span class="p">]</span>
            <span class="n">system_clean</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nlo</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">known_neighbor_lists</span><span class="p">():</span>
                <span class="n">system_clean</span><span class="o">.</span><span class="n">add_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">system_clean</span> <span class="o">=</span> <span class="n">system</span>
        <span class="k">return</span> <span class="n">system_clean</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlo</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">systems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">System</span><span class="p">],</span>  <span class="c1"># noqa</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelOutput</span><span class="p">],</span>  <span class="c1"># noqa</span>
        <span class="n">selected_atoms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Labels</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorMap</span><span class="p">]:</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`outputs` keys (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">) contain unsupported &quot;</span>
                <span class="s2">&quot;keys. Only &#39;energy&#39; is supported.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">per_atom</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;per-atom energies are not supported.&quot;</span><span class="p">)</span>

        <span class="n">system</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_systems</span><span class="p">(</span><span class="n">systems</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="p">)</span>

        <span class="c1"># compute non-bonded LJ energy</span>
        <span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="s2">&quot;first_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;second_atom&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">types</span>
        <span class="n">oo_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">neighbor_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">species</span><span class="p">[</span><span class="n">neighbor_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">8</span>
        <span class="p">)</span>
        <span class="n">oo_distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">neighbors</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">oo_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">energy_lj</span> <span class="o">=</span> <span class="n">lennard_jones_pair</span><span class="p">(</span>
            <span class="n">oo_distances</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj_sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj_epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">d_oh</span><span class="p">,</span> <span class="n">a_hoh</span><span class="p">,</span> <span class="n">m_system</span><span class="p">,</span> <span class="n">mh_dist</span><span class="p">,</span> <span class="n">hh_dist</span> <span class="o">=</span> <span class="n">get_molecular_geometry</span><span class="p">(</span>
            <span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_charge</span>
        <span class="p">)</span>

        <span class="c1"># intra-molecular energetics</span>
        <span class="n">e_bond</span> <span class="o">=</span> <span class="n">bond_energy</span><span class="p">(</span>
            <span class="n">d_oh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oh_bond_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oh_bond_alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oh_bond_eq</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e_bend</span> <span class="o">=</span> <span class="n">bend_energy</span><span class="p">(</span><span class="n">a_hoh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoh_angle_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoh_angle_eq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># now this is the long-range part - computed over the M-site system</span>
        <span class="c1"># m_system, mh_dist, hh_dist = get_msites(system, self.m_gamma, self.m_charge)</span>
        <span class="n">m_neighbors</span> <span class="o">=</span> <span class="n">m_system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlo</span><span class="p">)</span>

        <span class="n">potentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3m_calculator</span><span class="p">(</span><span class="n">m_system</span><span class="p">,</span> <span class="n">m_neighbors</span><span class="p">)</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="n">m_system</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;charges&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">energy_coulomb</span> <span class="o">=</span> <span class="p">(</span><span class="n">potentials</span> <span class="o">*</span> <span class="n">charges</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># this is the intra-molecular Coulomb interactions, that must be removed</span>
        <span class="c1"># to avoid double-counting</span>
        <span class="n">energy_self</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coulomb</span><span class="o">.</span><span class="n">from_dist</span><span class="p">(</span><span class="n">mh_dist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m_charge</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coulomb</span><span class="o">.</span><span class="n">from_dist</span><span class="p">(</span><span class="n">hh_dist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_charge</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mf">0.5</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_charge</span>
            <span class="o">*</span> <span class="n">torchpme</span><span class="o">.</span><span class="n">prefactors</span><span class="o">.</span><span class="n">kcalmol_A</span>
        <span class="p">)</span>

        <span class="c1"># combines all energy terms</span>
        <span class="n">energy_tot</span> <span class="o">=</span> <span class="n">e_bond</span> <span class="o">+</span> <span class="n">e_bend</span> <span class="o">+</span> <span class="n">energy_lj</span> <span class="o">+</span> <span class="n">energy_coulomb</span> <span class="o">-</span> <span class="n">energy_self</span>

        <span class="c1"># Rename property label to follow metatensor&#39;s convention for an atomistic model</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">energy_tot</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">([</span><span class="s2">&quot;energy&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">energy_tot</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>

        <span class="n">block</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_tot</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
            <span class="n">components</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Labels</span><span class="p">],</span> <span class="p">[]),</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">TensorMap</span><span class="p">(</span>
                <span class="n">Labels</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">energy_tot</span><span class="o">.</span><span class="n">device</span><span class="p">)),</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>All this class does is take a <code class="docutils literal notranslate"><span class="pre">System</span></code> and return its energy (as a
<code class="xref py py-class docutils literal notranslate"><span class="pre">metatensor.TensorMap`</span></code>).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">qtip4pf_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">cutoff</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
    <span class="n">lj_sigma</span><span class="o">=</span><span class="mf">3.1589</span><span class="p">,</span>
    <span class="n">lj_epsilon</span><span class="o">=</span><span class="mf">0.1852</span><span class="p">,</span>
    <span class="n">m_gamma</span><span class="o">=</span><span class="mf">0.73612</span><span class="p">,</span>
    <span class="n">m_charge</span><span class="o">=</span><span class="mf">1.1128</span><span class="p">,</span>
    <span class="n">oh_bond_eq</span><span class="o">=</span><span class="mf">0.9419</span><span class="p">,</span>
    <span class="n">oh_bond_k</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">116.09</span> <span class="o">*</span> <span class="mf">2.287</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">oh_bond_alpha</span><span class="o">=</span><span class="mf">2.287</span><span class="p">,</span>
    <span class="n">hoh_angle_eq</span><span class="o">=</span><span class="mf">107.4</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span>
    <span class="n">hoh_angle_k</span><span class="o">=</span><span class="mf">87.85</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">qtip4pf_model</span> <span class="o">=</span> <span class="n">WaterModel</span><span class="p">(</span>
    <span class="o">**</span><span class="n">qtip4pf_parameters</span>
    <span class="c1">#   uncomment to override default options</span>
    <span class="c1">#    p3m_options = (1.4, {&quot;interpolation_nodes&quot;: 5, &quot;mesh_spacing&quot;: 1.33}, 0)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We re-initilize the <code class="docutils literal notranslate"><span class="pre">system</span></code> to ask for gradients</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span>
    <span class="n">types</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()),</span>
    <span class="n">positions</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(),</span>
    <span class="n">cell</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">array</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(),</span>
    <span class="n">pbc</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_neighbor_list</span><span class="p">(</span><span class="n">nlo</span><span class="p">,</span> <span class="n">calculator</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>

<span class="n">energy_unit</span> <span class="o">=</span> <span class="s2">&quot;kcal/mol&quot;</span>
<span class="n">length_unit</span> <span class="o">=</span> <span class="s2">&quot;angstrom&quot;</span>

<span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">ModelOutput</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">energy_unit</span><span class="p">,</span> <span class="n">per_atom</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>

<span class="n">nrg</span> <span class="o">=</span> <span class="n">qtip4pf_model</span><span class="o">.</span><span class="n">forward</span><span class="p">([</span><span class="n">system</span><span class="p">],</span> <span class="n">outputs</span><span class="p">)</span>
<span class="n">nrg</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Energy is </span><span class="si">{</span><span class="n">nrg</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2"> kcal/mol</span>

<span class="s2">The forces on the first molecule (in kcal/mol/Å) are</span>
<span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">grad</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span>

<span class="s2">The stress is</span>
<span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">grad</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/runner/work/atomistic-cookbook/atomistic-cookbook/.nox/water-model/lib/python3.12/site-packages/torchpme/metatensor/calculator.py:95: UserWarning: custom data &#39;charges&#39; is experimental, please contact metatensor&#39;s developers to add this data as a member of the `System` class (Triggered internally at /project/metatomic-torch/src/system.cpp:866.)
  charge_tensor = system.get_data(&quot;charges&quot;)

Energy is -274.07545584268337 kcal/mol

The forces on the first molecule (in kcal/mol/Å) are
tensor([[-22.5891,  -4.0345,  16.9057],
        [ 10.1369,   0.0815,  -0.2837],
        [  1.1909,   9.2458,  -7.3839]], dtype=torch.float64)

The stress is
tensor([[ -1.1619,  15.5917, -14.0268],
        [ 18.7409,   5.3058, -16.6880],
        [-31.6888,  -8.1921, -42.9294]], dtype=torch.float64)
</pre></div>
</div>
</section>
<section id="build-and-save-an-atomisticmodel">
<h3>Build and save an <code class="docutils literal notranslate"><span class="pre">AtomisticModel</span></code><a class="headerlink" href="#build-and-save-an-atomisticmodel" title="Link to this heading">¶</a></h3>
<p>This model can be wrapped into a
<code class="xref py py-class docutils literal notranslate"><span class="pre">metatomic.torch.AtomisticModel</span></code> class, that provides
useful helpers to specify the capabilities of the model, and to save it as a
<code class="docutils literal notranslate"><span class="pre">torchscript</span></code> module.</p>
<p>Model options include a definition of its units, and a description of the quantities
it can compute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to specify that the model has infinite interaction range because of the
presence of a long-range term that means one cannot assume that forces decay to zero
beyond the cutoff.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="o">=</span> <span class="n">ModelEvaluationOptions</span><span class="p">(</span>
    <span class="n">length_unit</span><span class="o">=</span><span class="n">length_unit</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="n">model_capabilities</span> <span class="o">=</span> <span class="n">ModelCapabilities</span><span class="p">(</span>
    <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
    <span class="n">atomic_types</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
    <span class="n">interaction_range</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
    <span class="n">length_unit</span><span class="o">=</span><span class="n">length_unit</span><span class="p">,</span>
    <span class="n">supported_devices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">atomistic_model</span> <span class="o">=</span> <span class="n">AtomisticModel</span><span class="p">(</span>
    <span class="n">qtip4pf_model</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">ModelMetadata</span><span class="p">(),</span> <span class="n">model_capabilities</span>
<span class="p">)</span>

<span class="n">atomistic_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;qtip4pf-mta.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="other-water-models">
<h3>Other water models<a class="headerlink" href="#other-water-models" title="Link to this heading">¶</a></h3>
<p>The <cite>WaterModel</cite> class is flexible enough that one can also implement (and export)
other 4-point models, or even 3-point models if one sets the <cite>m_gamma</cite> parameter to
one. For instance, we can implement the (classical) SPC/Fw model (<a class="reference external" href="http://doi.org/10.1063/1.2136877">Wu et al., JCP
(2006)</a>)</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">spcf_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">cutoff</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
    <span class="n">lj_sigma</span><span class="o">=</span><span class="mf">3.16549</span><span class="p">,</span>
    <span class="n">lj_epsilon</span><span class="o">=</span><span class="mf">0.155425</span><span class="p">,</span>
    <span class="n">m_gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">m_charge</span><span class="o">=</span><span class="mf">0.82</span><span class="p">,</span>
    <span class="n">oh_bond_eq</span><span class="o">=</span><span class="mf">1.012</span><span class="p">,</span>
    <span class="n">oh_bond_k</span><span class="o">=</span><span class="mf">1059.162</span><span class="p">,</span>
    <span class="n">oh_bond_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">hoh_angle_eq</span><span class="o">=</span><span class="mf">113.24</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span>
    <span class="n">hoh_angle_k</span><span class="o">=</span><span class="mf">75.90</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">spcf_model</span> <span class="o">=</span> <span class="n">WaterModel</span><span class="p">(</span><span class="o">**</span><span class="n">spcf_parameters</span><span class="p">)</span>

<span class="n">atomistic_model</span> <span class="o">=</span> <span class="n">AtomisticModel</span><span class="p">(</span><span class="n">spcf_model</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">ModelMetadata</span><span class="p">(),</span> <span class="n">model_capabilities</span><span class="p">)</span>

<span class="n">atomistic_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;spcfw-mta.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="using-the-q-tip4p-f-model">
<h2>Using the Q-TIP4P/f model<a class="headerlink" href="#using-the-q-tip4p-f-model" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">torchscript</span></code> model can be reused with any simulation software compatible with
the <code class="docutils literal notranslate"><span class="pre">metatomic</span></code> API. Here we give a couple of examples, designed to demonstrate the
usage more than to provide realistic use cases.</p>
<section id="geometry-optimization-with-ase">
<h3>Geometry optimization with <code class="docutils literal notranslate"><span class="pre">ase</span></code><a class="headerlink" href="#geometry-optimization-with-ase" title="Link to this heading">¶</a></h3>
<p>We begin with an example based on an <code class="docutils literal notranslate"><span class="pre">ase</span></code>-compatible calculator. To this end,
<code class="docutils literal notranslate"><span class="pre">metatomic</span></code> provides a compatible
<code class="xref py py-class docutils literal notranslate"><span class="pre">metatomic.torch.MetatomicCalculator</span></code> wrapper to a model. Note how
the metadata associated with the model are used to convert energy into the units
expected by <code class="docutils literal notranslate"><span class="pre">ase</span></code> (eV and Å).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">atomistic_model</span> <span class="o">=</span> <span class="n">load_atomistic_model</span><span class="p">(</span><span class="s2">&quot;qtip4pf-mta.pt&quot;</span><span class="p">)</span>
<span class="n">mta_calculator</span> <span class="o">=</span> <span class="n">MetatomicCalculator</span><span class="p">(</span><span class="n">atomistic_model</span><span class="p">)</span>

<span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">mta_calculator</span>
<span class="n">nrg</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Energy is </span><span class="si">{</span><span class="n">nrg</span><span class="si">}</span><span class="s2"> eV, corresponding to </span><span class="si">{</span><span class="n">nrg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">23.060548</span><span class="si">}</span><span class="s2"> kcal/mol</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>the model suggested to use CUDA devices before CPU, but we are unable to find it

Energy is -11.8850679397583 eV, corresponding to -274.0761797080574 kcal/mol
</pre></div>
</div>
<p>We then use one of the built-in <code class="docutils literal notranslate"><span class="pre">ase</span></code> functions to run the structural relaxation.
The relaxation is split into short segments just to be able to visualize the
trajectory.</p>
<p><code class="docutils literal notranslate"><span class="pre">fmax</span></code> is the threshold on the maximum force component and the optimization will
stop when the threshold is reached</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">opt_trj</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">opt_nrg</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">opt_trj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">opt_nrg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">())</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">LBFGS</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="s2">&quot;lbfgs_restart.json&quot;</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">nrg_final</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>       Step     Time          Energy          fmax
LBFGS:    0 14:52:32      -11.885068        3.466991
LBFGS:    1 14:52:32      -12.927966        1.706440
LBFGS:    2 14:52:32      -13.351316        1.339505
LBFGS:    3 14:52:32      -14.188955        1.595509
LBFGS:    4 14:52:32      -14.462056        0.648458
LBFGS:    5 14:52:32      -14.683408        0.598449
       Step     Time          Energy          fmax
LBFGS:    0 14:52:32      -14.683408        0.598449
LBFGS:    1 14:52:32      -14.961548        0.829782
LBFGS:    2 14:52:32      -15.255526        0.781370
LBFGS:    3 14:52:32      -15.422122        0.612481
LBFGS:    4 14:52:32      -15.511729        0.412034
LBFGS:    5 14:52:32      -15.616795        0.654138
       Step     Time          Energy          fmax
LBFGS:    0 14:52:32      -15.616795        0.654138
LBFGS:    1 14:52:32      -15.758617        0.819069
LBFGS:    2 14:52:32      -15.908655        0.641351
LBFGS:    3 14:52:33      -16.021681        0.450615
LBFGS:    4 14:52:33      -16.081816        0.417819
LBFGS:    5 14:52:33      -16.140762        0.373983
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -16.140762        0.373983
LBFGS:    1 14:52:33      -16.227873        0.516816
LBFGS:    2 14:52:33      -16.308756        0.410013
LBFGS:    3 14:52:33      -16.372574        0.393195
LBFGS:    4 14:52:33      -16.429575        0.366466
LBFGS:    5 14:52:33      -16.498898        0.375348
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -16.498898        0.375348
LBFGS:    1 14:52:33      -16.560005        0.312216
LBFGS:    2 14:52:33      -16.603413        0.306913
LBFGS:    3 14:52:33      -16.635639        0.247767
LBFGS:    4 14:52:33      -16.677479        0.289590
LBFGS:    5 14:52:33      -16.740238        0.359782
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -16.740238        0.359782
LBFGS:    1 14:52:33      -16.812780        0.307672
LBFGS:    2 14:52:33      -16.857498        0.333332
LBFGS:    3 14:52:33      -16.883671        0.346671
LBFGS:    4 14:52:33      -16.913525        0.282525
LBFGS:    5 14:52:33      -16.957186        0.312863
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -16.957186        0.312863
LBFGS:    1 14:52:33      -17.000168        0.350250
LBFGS:    2 14:52:33      -17.030533        0.246561
LBFGS:    3 14:52:33      -17.052256        0.249763
LBFGS:    4 14:52:33      -17.078173        0.241959
LBFGS:    5 14:52:33      -17.114550        0.312431
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -17.114550        0.312431
LBFGS:    1 14:52:33      -17.151857        0.254514
LBFGS:    2 14:52:33      -17.178030        0.226625
LBFGS:    3 14:52:33      -17.198738        0.197651
LBFGS:    4 14:52:33      -17.221266        0.175383
LBFGS:    5 14:52:33      -17.245617        0.225135
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -17.245617        0.225135
LBFGS:    1 14:52:33      -17.264885        0.174624
LBFGS:    2 14:52:33      -17.281315        0.202229
LBFGS:    3 14:52:33      -17.300583        0.193813
LBFGS:    4 14:52:33      -17.328279        0.281853
LBFGS:    5 14:52:33      -17.355974        0.239413
       Step     Time          Energy          fmax
LBFGS:    0 14:52:33      -17.355974        0.239413
LBFGS:    1 14:52:33      -17.374777        0.192582
LBFGS:    2 14:52:33      -17.386635        0.163868
LBFGS:    3 14:52:33      -17.401159        0.196256
LBFGS:    4 14:52:33      -17.422926        0.324161
LBFGS:    5 14:52:34      -17.444820        0.220620
LBFGS:    6 14:52:34      -17.460108        0.259759
LBFGS:    7 14:52:34      -17.469763        0.159939
LBFGS:    8 14:52:34      -17.479248        0.189712
LBFGS:    9 14:52:34      -17.495892        0.275043
LBFGS:   10 14:52:34      -17.513594        0.244287
LBFGS:   11 14:52:34      -17.526594        0.143234
LBFGS:   12 14:52:34      -17.534555        0.128279
LBFGS:   13 14:52:34      -17.542517        0.159848
LBFGS:   14 14:52:34      -17.552977        0.174690
LBFGS:   15 14:52:34      -17.563648        0.143936
</pre></div>
</div>
<p>Use <a class="reference external" href="http://chemiscope.org">chemiscope</a> to visualize the geometry optimization
together with the convergence of the energy to a local minimum.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">structures</span><span class="o">=</span><span class="n">opt_trj</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt_trj</span><span class="p">)),</span>
        <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">opt_nrg</span> <span class="o">-</span> <span class="n">nrg_final</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span>
        <span class="n">map_settings</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;property&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">},</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;property&quot;</span><span class="p">:</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;unitCell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>


<!-- Error display -->
<div id="chsp-edbfd4c2-583e-495f-9d66-a609618e3e21-error-display" class="chemiscope-sphinx-error">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-edbfd4c2-583e-495f-9d66-a609618e3e21-error-display')">
        &times;
    </button>
</div>

<!-- Warning Display -->
<div id="chsp-edbfd4c2-583e-495f-9d66-a609618e3e21-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-edbfd4c2-583e-495f-9d66-a609618e3e21-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-edbfd4c2-583e-495f-9d66-a609618e3e21-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-edbfd4c2-583e-495f-9d66-a609618e3e21">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-edbfd4c2-583e-495f-9d66-a609618e3e21', '../../_datasets/5db813fa02560ca20994737910815d9cf1bc18c0d06da3c5ad21da5a396d3cf1-fig_water-model_002.json.gz', 'default', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /></section>
<section id="path-integral-molecular-dynamics-with-i-pi">
<h3>Path integral molecular dynamics with <code class="docutils literal notranslate"><span class="pre">i-PI</span></code><a class="headerlink" href="#path-integral-molecular-dynamics-with-i-pi" title="Link to this heading">¶</a></h3>
<p>We use <a class="reference external" href="http://ipi-code.org">i-PI</a> to perform path integral molecular-dynamics
simulations of bulk water to include nuclear quntum effects. See <a class="reference external" href="https://atomistic-cookbook.org/examples/thermostats/thermostats.html">this recipe</a> for an
introduction to constant-temperature MD using i-PI.</p>
<p>First, the <code class="docutils literal notranslate"><span class="pre">XML</span></code> input of the i-PI simulation is created using a few utility
functions. This input could also be written to file and used with the command-line
version of i-PI. We use the structure twice to generate a path integral with two
replicas: this is far from converged, see also <a class="reference external" href="https://atomistic-cookbook.org/examples/path-integrals/path-integrals.html">this recipe</a> if you
have never run path integral simulations before.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;data/water_32.xyz&quot;</span><span class="p">)</span>
<span class="n">input_xml</span> <span class="o">=</span> <span class="n">simulation_xml</span><span class="p">(</span>
    <span class="n">structures</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">],</span>
    <span class="n">forcefield</span><span class="o">=</span><span class="n">forcefield_xml</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;qtip4pf&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span>
        <span class="n">pes</span><span class="o">=</span><span class="s2">&quot;metatomic&quot;</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;qtip4pf-mta.pt&quot;</span><span class="p">,</span> <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;data/water_32.xyz&quot;</span><span class="p">},</span>
    <span class="p">),</span>
    <span class="n">motion</span><span class="o">=</span><span class="n">motion_nvt_xml</span><span class="p">(</span><span class="n">timestep</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;qtip4pf-md&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">input_xml</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;simulation verbosity=&#39;quiet&#39; safe_stride=&#39;20&#39;&gt;

&lt;ffdirect name=&#39;qtip4pf&#39;&gt;
&lt;pes&gt;metatomic&lt;/pes&gt;
&lt;parameters&gt;{model: qtip4pf-mta.pt, template: data/water_32.xyz}&lt;/parameters&gt;
&lt;/ffdirect&gt;


  &lt;output prefix=&#39;qtip4pf-md&#39;&gt;
    &lt;properties stride=&#39;2&#39; filename=&#39;out&#39;&gt;[ step, time{picosecond}, conserved{electronvolt}, temperature{kelvin}, potential{electronvolt} ]&lt;/properties&gt;
    &lt;trajectory filename=&#39;pos&#39; stride=&#39;20&#39; cell_units=&#39;angstrom&#39;&gt;positions{angstrom}&lt;/trajectory&gt;
    &lt;checkpoint stride=&#39;200&#39;&gt;
    &lt;/checkpoint&gt;
  &lt;/output&gt;
&lt;system&gt;
&lt;beads natoms=&#39;96&#39; nbeads=&#39;2&#39;&gt;
   &lt;q shape=&#39;(2, 288)&#39;&gt;
    [   7.09781133e+00,   8.90061005e+00,   1.79410598e+01,   8.70029908e+00,   8.07291001e+00,
        1.82755414e+01,   7.55512505e+00,   1.00533430e+01,   1.66069132e+01,   1.87706496e+01,
        1.67070687e+01,   6.91639762e-01,   1.91467051e+01,   1.54881953e+01,   2.11649326e+00,
        1.77029543e+01,   1.59662960e+01,  -5.97153456e-01,   6.06602086e-01,   2.81947138e+00,
        1.09528526e+01,  -5.42351398e-01,   3.76622417e+00,   9.90405463e+00,   1.49477337e+00,
        3.89472555e+00,   1.20262171e+01,   1.51839494e+01,   1.83964838e+01,   8.13905042e+00,
        1.36116973e+01,   1.84985290e+01,   9.15950253e+00,   1.63196748e+01,   1.75876811e+01,
        9.29745254e+00,   1.07015191e+01,   1.71624927e+01,   1.24721924e+00,   1.20526732e+01,
        1.83700277e+01,   1.53823707e+00,   9.85114229e+00,   1.69905276e+01,   2.93285495e+00,
        1.53634734e+01,   4.06291117e-01,   2.26956108e+00,   1.54881953e+01,  -1.22832198e-01,
        4.00243993e+00,   1.68903721e+01,  -3.04245906e-01,   1.54579597e+00,   1.54522905e+01,
        7.87070931e+00,   1.35304391e+00,   1.49193878e+01,   9.57335255e+00,   1.58736995e+00,
        1.45924651e+01,   6.73120446e+00,   2.53412273e+00,   1.19827534e+01,   6.15294827e+00,
        1.82887694e+01,   1.34794165e+01,   6.46853253e+00,   1.92544195e+01,   1.22964479e+01,
        4.53156325e+00,   1.76689393e+01,   2.57002753e-01,   1.47360843e+01,   5.17407013e+00,
       -1.13383568e-02,   1.56847268e+01,   6.77277843e+00,   5.93374004e-01,   1.30485589e+01,
        5.60492769e+00,   9.49965323e+00,   4.84336806e+00,   1.16577205e+01,   1.04653033e+01,
        6.30412636e+00,   1.18334650e+01,   1.00401149e+01,   3.83803376e+00,   1.30806842e+01,
        1.35379980e+01,   4.80368381e+00,   4.56935777e+00,   1.18070088e+01,   4.66195435e+00,
        5.03989958e+00,   1.39537377e+01,   3.17662962e+00,   3.88716664e+00,   6.30412636e+00,
        1.71039112e+01,   6.16995580e+00,   5.32524822e+00,   1.57622056e+01,   5.26666671e+00,
        5.16462150e+00,   1.85079777e+01,   6.42128938e+00,   2.78923576e+00,   2.68341110e+00,
        1.54768570e+00,   2.00310969e+00,   1.07336444e+00,   1.19241719e+00,   2.98954673e+00,
        2.85159672e+00,   3.34481524e+00,   2.30924533e+00,   9.34658542e+00,   6.08113867e+00,
        3.98921185e+00,   8.88738197e+00,   6.65561542e+00,   2.53601246e+00,   9.36548268e+00,
        4.24243515e+00,   1.28312404e+01,   1.22662123e+01,   8.48109085e+00,   1.33849301e+01,
        1.08753739e+01,   9.58847036e+00,   1.27499822e+01,   1.37817726e+01,   9.40138748e+00,
        1.76311448e+01,   6.54790103e+00,   8.37148674e+00,   1.88481284e+01,   7.47575655e+00,
        7.40394696e+00,   1.62195193e+01,   5.93940921e+00,   7.49465382e+00,   1.41427103e+01,
        8.58502579e+00,   1.20545630e+01,   1.43694775e+01,   8.40928126e+00,   1.38479131e+01,
        1.55732330e+01,   7.74409766e+00,   1.13137903e+01,   8.46597304e-01,   1.07733286e+01,
        1.55316590e+01,   1.08281307e+00,   9.14627445e+00,   1.48740343e+01,   1.36060281e+00,
        1.06788423e+01,   1.72399714e+01,   1.39083843e+00,   7.71386205e+00,   1.02990074e+00,
        1.95019736e+00,   5.94696812e+00,   9.46752789e-01,  -4.72431531e-01,   7.51733053e+00,
        8.99509636e-01,   7.99165179e+00,   4.87927286e+00,   6.73120446e+00,   8.78722649e+00,
        4.46731256e+00,   8.36014838e+00,   8.13716070e+00,   6.66317432e+00,   6.60648254e+00,
        7.08458325e+00,   1.00495635e+01,   6.78600652e+00,   6.75955035e+00,   1.05824663e+01,
        5.08336328e+00,   8.53967236e+00,   1.09830882e+01,   7.23954079e+00,   4.57313722e-01,
        1.61382611e+01,   9.81712722e+00,   4.59203449e-01,   1.78616913e+01,   1.03065663e+01,
        1.37005144e+00,   1.53105611e+01,   1.10813540e+01,   1.14611890e+01,   4.59203449e-01,
        1.54409522e+01,   1.26328192e+01,  -6.80301405e-01,   1.61741659e+01,   9.89271627e+00,
       -3.77945225e-02,   1.62251885e+01,   1.39121637e+01,   1.51726111e+01,   1.71001317e+01,
        1.26970698e+01,   1.47984453e+01,   1.57074036e+01,   1.28747041e+01,   1.48135631e+01,
        1.84380578e+01,   3.72465019e+00,   2.21286929e+00,   6.86159556e+00,   2.87238371e+00,
        2.64372685e+00,   8.45463469e+00,   5.33091740e+00,   2.98009810e+00,   6.67640240e+00,
        1.45017583e+01,   1.24816411e+01,   4.03267555e+00,   1.34983137e+01,   1.22643226e+01,
        5.51422084e+00,   1.61817248e+01,   1.26252602e+01,   4.55235024e+00,   5.23265164e+00,
        1.39537377e+01,   1.37477576e+01,   4.44652557e+00,   1.52841049e+01,   1.46415980e+01,
        4.24999406e+00,   1.23852650e+01,   1.39990911e+01,   4.25755296e+00,   5.27422562e+00,
        1.38875973e+01,   5.13627561e+00,   6.10381539e+00,   1.52614282e+01,   5.58414070e+00,
        5.04745848e+00,   1.26743931e+01,   6.90127981e+00,   1.88084441e+01,   1.75555557e+01,
        7.77433328e+00,   1.79694057e+01,   1.88651359e+01,   6.04523388e+00,   2.01047963e+01,
        1.84890804e+01,   9.94562860e+00,   1.26762829e+01,   1.43411316e+01,   8.15983741e+00,
        1.33830404e+01,   1.45641193e+01,   1.03084560e+01,   1.33357973e+01,   1.27235260e+01,
        6.62726952e+00,   1.27008493e+01,   1.92752065e+00,   7.74220794e+00,   1.38006699e+01,
        1.14706376e+00,   6.77655789e+00,   1.13081211e+01,   7.91795247e-01,   1.03084560e+01,
        1.73779215e+01,   1.11267074e+01,   1.03424711e+01,   1.81451503e+01,   1.27707692e+01,
        8.59636415e+00,   1.74572900e+01,   1.03632581e+01,   7.09781133e+00,   8.90061005e+00,
        1.79410598e+01,   8.70029908e+00,   8.07291001e+00,   1.82755414e+01,   7.55512505e+00,
        1.00533430e+01,   1.66069132e+01,   1.87706496e+01,   1.67070687e+01,   6.91639762e-01,
        1.91467051e+01,   1.54881953e+01,   2.11649326e+00,   1.77029543e+01,   1.59662960e+01,
       -5.97153456e-01,   6.06602086e-01,   2.81947138e+00,   1.09528526e+01,  -5.42351398e-01,
        3.76622417e+00,   9.90405463e+00,   1.49477337e+00,   3.89472555e+00,   1.20262171e+01,
        1.51839494e+01,   1.83964838e+01,   8.13905042e+00,   1.36116973e+01,   1.84985290e+01,
        9.15950253e+00,   1.63196748e+01,   1.75876811e+01,   9.29745254e+00,   1.07015191e+01,
        1.71624927e+01,   1.24721924e+00,   1.20526732e+01,   1.83700277e+01,   1.53823707e+00,
        9.85114229e+00,   1.69905276e+01,   2.93285495e+00,   1.53634734e+01,   4.06291117e-01,
        2.26956108e+00,   1.54881953e+01,  -1.22832198e-01,   4.00243993e+00,   1.68903721e+01,
       -3.04245906e-01,   1.54579597e+00,   1.54522905e+01,   7.87070931e+00,   1.35304391e+00,
        1.49193878e+01,   9.57335255e+00,   1.58736995e+00,   1.45924651e+01,   6.73120446e+00,
        2.53412273e+00,   1.19827534e+01,   6.15294827e+00,   1.82887694e+01,   1.34794165e+01,
        6.46853253e+00,   1.92544195e+01,   1.22964479e+01,   4.53156325e+00,   1.76689393e+01,
        2.57002753e-01,   1.47360843e+01,   5.17407013e+00,  -1.13383568e-02,   1.56847268e+01,
        6.77277843e+00,   5.93374004e-01,   1.30485589e+01,   5.60492769e+00,   9.49965323e+00,
        4.84336806e+00,   1.16577205e+01,   1.04653033e+01,   6.30412636e+00,   1.18334650e+01,
        1.00401149e+01,   3.83803376e+00,   1.30806842e+01,   1.35379980e+01,   4.80368381e+00,
        4.56935777e+00,   1.18070088e+01,   4.66195435e+00,   5.03989958e+00,   1.39537377e+01,
        3.17662962e+00,   3.88716664e+00,   6.30412636e+00,   1.71039112e+01,   6.16995580e+00,
        5.32524822e+00,   1.57622056e+01,   5.26666671e+00,   5.16462150e+00,   1.85079777e+01,
        6.42128938e+00,   2.78923576e+00,   2.68341110e+00,   1.54768570e+00,   2.00310969e+00,
        1.07336444e+00,   1.19241719e+00,   2.98954673e+00,   2.85159672e+00,   3.34481524e+00,
        2.30924533e+00,   9.34658542e+00,   6.08113867e+00,   3.98921185e+00,   8.88738197e+00,
        6.65561542e+00,   2.53601246e+00,   9.36548268e+00,   4.24243515e+00,   1.28312404e+01,
        1.22662123e+01,   8.48109085e+00,   1.33849301e+01,   1.08753739e+01,   9.58847036e+00,
        1.27499822e+01,   1.37817726e+01,   9.40138748e+00,   1.76311448e+01,   6.54790103e+00,
        8.37148674e+00,   1.88481284e+01,   7.47575655e+00,   7.40394696e+00,   1.62195193e+01,
        5.93940921e+00,   7.49465382e+00,   1.41427103e+01,   8.58502579e+00,   1.20545630e+01,
        1.43694775e+01,   8.40928126e+00,   1.38479131e+01,   1.55732330e+01,   7.74409766e+00,
        1.13137903e+01,   8.46597304e-01,   1.07733286e+01,   1.55316590e+01,   1.08281307e+00,
        9.14627445e+00,   1.48740343e+01,   1.36060281e+00,   1.06788423e+01,   1.72399714e+01,
        1.39083843e+00,   7.71386205e+00,   1.02990074e+00,   1.95019736e+00,   5.94696812e+00,
        9.46752789e-01,  -4.72431531e-01,   7.51733053e+00,   8.99509636e-01,   7.99165179e+00,
        4.87927286e+00,   6.73120446e+00,   8.78722649e+00,   4.46731256e+00,   8.36014838e+00,
        8.13716070e+00,   6.66317432e+00,   6.60648254e+00,   7.08458325e+00,   1.00495635e+01,
        6.78600652e+00,   6.75955035e+00,   1.05824663e+01,   5.08336328e+00,   8.53967236e+00,
        1.09830882e+01,   7.23954079e+00,   4.57313722e-01,   1.61382611e+01,   9.81712722e+00,
        4.59203449e-01,   1.78616913e+01,   1.03065663e+01,   1.37005144e+00,   1.53105611e+01,
        1.10813540e+01,   1.14611890e+01,   4.59203449e-01,   1.54409522e+01,   1.26328192e+01,
       -6.80301405e-01,   1.61741659e+01,   9.89271627e+00,  -3.77945225e-02,   1.62251885e+01,
        1.39121637e+01,   1.51726111e+01,   1.71001317e+01,   1.26970698e+01,   1.47984453e+01,
        1.57074036e+01,   1.28747041e+01,   1.48135631e+01,   1.84380578e+01,   3.72465019e+00,
        2.21286929e+00,   6.86159556e+00,   2.87238371e+00,   2.64372685e+00,   8.45463469e+00,
        5.33091740e+00,   2.98009810e+00,   6.67640240e+00,   1.45017583e+01,   1.24816411e+01,
        4.03267555e+00,   1.34983137e+01,   1.22643226e+01,   5.51422084e+00,   1.61817248e+01,
        1.26252602e+01,   4.55235024e+00,   5.23265164e+00,   1.39537377e+01,   1.37477576e+01,
        4.44652557e+00,   1.52841049e+01,   1.46415980e+01,   4.24999406e+00,   1.23852650e+01,
        1.39990911e+01,   4.25755296e+00,   5.27422562e+00,   1.38875973e+01,   5.13627561e+00,
        6.10381539e+00,   1.52614282e+01,   5.58414070e+00,   5.04745848e+00,   1.26743931e+01,
        6.90127981e+00,   1.88084441e+01,   1.75555557e+01,   7.77433328e+00,   1.79694057e+01,
        1.88651359e+01,   6.04523388e+00,   2.01047963e+01,   1.84890804e+01,   9.94562860e+00,
        1.26762829e+01,   1.43411316e+01,   8.15983741e+00,   1.33830404e+01,   1.45641193e+01,
        1.03084560e+01,   1.33357973e+01,   1.27235260e+01,   6.62726952e+00,   1.27008493e+01,
        1.92752065e+00,   7.74220794e+00,   1.38006699e+01,   1.14706376e+00,   6.77655789e+00,
        1.13081211e+01,   7.91795247e-01,   1.03084560e+01,   1.73779215e+01,   1.11267074e+01,
        1.03424711e+01,   1.81451503e+01,   1.27707692e+01,   8.59636415e+00,   1.74572900e+01,
        1.03632581e+01 ]
   &lt;/q&gt;
   &lt;p shape=&#39;(2, 288)&#39;&gt;
    [   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
        0.00000000e+00 ]
   &lt;/p&gt;
   &lt;m shape=&#39;(96)&#39;&gt;
    [   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,
        1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,   1.83736223e+03,
        2.91651223e+04,   1.83736223e+03,   1.83736223e+03,   2.91651223e+04,   1.83736223e+03,
        1.83736223e+03 ]
   &lt;/m&gt;
   &lt;names shape=&#39;(96)&#39;&gt;
    [ O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H, O, H, H, O,
      H, H, O, H, H,
      O, H, H, O, H,
      H ]
   &lt;/names&gt;
&lt;/beads&gt;

&lt;cell shape=&#39;(3, 3)&#39;&gt;
 [   1.93885901e+01,   0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   1.93885901e+01,
     0.00000000e+00,   0.00000000e+00,   0.00000000e+00,   1.93885901e+01 ]
&lt;/cell&gt;

&lt;initialize nbeads=&#39;2&#39;&gt;&lt;velocities mode=&#39;thermal&#39; units=&#39;ase&#39;&gt; 300 &lt;/velocities&gt;&lt;/initialize&gt;&lt;ensemble&gt;&lt;temperature units=&#39;ase&#39;&gt; 300 &lt;/temperature&gt;&lt;/ensemble&gt;
&lt;forces&gt;
&lt;force forcefield=&#39;qtip4pf&#39;&gt; &lt;/force&gt;
&lt;/forces&gt;

&lt;motion mode=&quot;dynamics&quot;&gt;
&lt;dynamics mode=&quot;nvt&quot;&gt;
&lt;timestep units=&quot;ase&quot;&gt; 0.04911347394232032 &lt;/timestep&gt;

&lt;thermostat mode=&#39;svr&#39;&gt;
    &lt;tau units=&#39;ase&#39;&gt; 0.4911347394232032 &lt;/tau&gt;
&lt;/thermostat&gt;

&lt;/dynamics&gt;
&lt;/motion&gt;

&lt;/system&gt;
&lt;/simulation&gt;
</pre></div>
</div>
<p>Then, we create an <code class="docutils literal notranslate"><span class="pre">InteractiveSimulation</span></code> object and run a short simulation (purely
for demonstrative purposes)</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">InteractiveSimulation</span><span class="p">(</span><span class="n">input_xml</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
<p>The simulation generates output files that can be parsed and visualized from Python</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;qtip4pf-md.out&quot;</span><span class="p">)</span>
<span class="n">trj</span> <span class="o">=</span> <span class="n">read_trajectory</span><span class="p">(</span><span class="s2">&quot;qtip4pf-md.pos_0.xyz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;potential&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;conserved&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;energy / ev&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_water-model_005.png" srcset="../../_images/sphx_glr_water-model_005.png" alt="water model" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7ff4393abec0&gt;
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">structures</span><span class="o">=</span><span class="n">trj</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][::</span><span class="mi">10</span><span class="p">],</span>
        <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">][::</span><span class="mi">10</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span>
        <span class="n">map_settings</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;property&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">},</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;property&quot;</span><span class="p">:</span> <span class="s2">&quot;potential&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;unitCell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>


<!-- Error display -->
<div id="chsp-69dd5155-3457-4af5-9ba2-3e44696be806-error-display" class="chemiscope-sphinx-error">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-69dd5155-3457-4af5-9ba2-3e44696be806-error-display')">
        &times;
    </button>
</div>

<!-- Warning Display -->
<div id="chsp-69dd5155-3457-4af5-9ba2-3e44696be806-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-69dd5155-3457-4af5-9ba2-3e44696be806-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-69dd5155-3457-4af5-9ba2-3e44696be806-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-69dd5155-3457-4af5-9ba2-3e44696be806">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-69dd5155-3457-4af5-9ba2-3e44696be806', '../../_datasets/66ae165f5b8ad8620a4e21a0a080208a0711b687f433125790a4b8d5534df6f4-fig_water-model_003.json.gz', 'default', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /></section>
<section id="molecular-dynamics-with-lammps">
<h3>Molecular dynamics with <code class="docutils literal notranslate"><span class="pre">LAMMPS</span></code><a class="headerlink" href="#molecular-dynamics-with-lammps" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">metatomic</span></code> model can also be run with <a class="reference external" href="https://lammps.org">LAMMPS</a>
and used to perform all kinds of atomistic simulations with it.
This only requires defining a <code class="docutils literal notranslate"><span class="pre">pair_metatomic</span></code> potential, and specifying
the mapping between LAMMPS atom types and those used in the model.</p>
<p>Note also that the <code class="docutils literal notranslate"><span class="pre">metatomic</span></code> interface takes care of converting the
model units to those used in the LAMMPS file, so it is possible to use
energies in eV even if the model outputs kcal/mol.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/spcfw.in&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="mi">16</span><span class="p">:]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>units metal  # Angstroms, eV, picoseconds
atom_style atomic
read_data water_32.data

# loads metatomic SPC/Fw model
pair_style metatomic spcfw-mta.pt
pair_coeff * * 1 8

fix 1 all nve
fix 2 all langevin 300 300 1.00 12345

run 200
</pre></div>
</div>
<p>This specific example runs a short MD trajectory, using a Langevin thermostat. Given
that this is a classical MD trajectory, we use the SPC/Fw model that is fitted to
reproduce (some) water properties even with a classical description of the nuclei.</p>
<p>We save to geometry to a LAMMPS data file and run the simulation</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;water_32.data&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;lammps-data&quot;</span><span class="p">,</span> <span class="n">masses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;lmp&quot;</span><span class="p">,</span> <span class="s2">&quot;-in&quot;</span><span class="p">,</span> <span class="s2">&quot;data/spcfw.in&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 28.208 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-water-model-water-model-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/a4db92447879533aca62378cbaaf8530/water-model.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">water-model.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/88a62c9f2989f1f6d2cf078250f56da0/water-model.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">water-model.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/40bf41d65d2118f6af75eefc4da2ac91/water-model.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">water-model.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../batch-cp2k/reference-trajectory.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Batch run of CP2K calculations</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../dos-align/dos-align.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">A ML model for the electron density of states</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2026, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Atomistic Water Model for Molecular Dynamics</a><ul>
<li><a class="reference internal" href="#the-q-tip4p-f-model">The q-TIP4P/F Model</a><ul>
<li><a class="reference internal" href="#intra-molecular-interactions">Intra-molecular interactions</a></li>
<li><a class="reference internal" href="#lennard-jones-potential">Lennard-Jones Potential</a></li>
<li><a class="reference internal" href="#electrostatic-potential">Electrostatic Potential</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-as-a-tip4p-f-torch-module">Implementation as a TIP4P/f <code class="docutils literal notranslate"><span class="pre">torch</span></code> module</a><ul>
<li><a class="reference internal" href="#helper-functions-for-molecular-geometry">Helper functions for molecular geometry</a></li>
<li><a class="reference internal" href="#defining-the-model">Defining the model</a></li>
<li><a class="reference internal" href="#build-and-save-an-atomisticmodel">Build and save an <code class="docutils literal notranslate"><span class="pre">AtomisticModel</span></code></a></li>
<li><a class="reference internal" href="#other-water-models">Other water models</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-q-tip4p-f-model">Using the Q-TIP4P/f model</a><ul>
<li><a class="reference internal" href="#geometry-optimization-with-ase">Geometry optimization with <code class="docutils literal notranslate"><span class="pre">ase</span></code></a></li>
<li><a class="reference internal" href="#path-integral-molecular-dynamics-with-i-pi">Path integral molecular dynamics with <code class="docutils literal notranslate"><span class="pre">i-PI</span></code></a></li>
<li><a class="reference internal" href="#molecular-dynamics-with-lammps">Molecular dynamics with <code class="docutils literal notranslate"><span class="pre">LAMMPS</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=01c87ff6"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>