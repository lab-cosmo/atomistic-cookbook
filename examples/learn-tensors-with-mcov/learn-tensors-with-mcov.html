<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html"><link rel="next" title="Finding Reaction Paths with eOn and a Metatomic Potential" href="../eon-pet-neb/eon-pet-neb.html"><link rel="prev" title="Equivariant linear model for polarizability" href="../polarizability/polarizability.html">
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/learn-tensors-with-mcov/learn-tensors-with-mcov.html">
        <link rel="prefetch" href="../../_static/cookbook-icon.svg" as="image">

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"><!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>Equivariant model for tensorial properties based on scalar features - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input aria-label="Toggle navigation of Recipes grouped by topic" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/universal.html">Universal ML models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input aria-label="Toggle navigation of Recipes grouped by software used" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/eon.html">eon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/gromacs.html">GROMACS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input aria-label="Toggle navigation of List of all recipes" checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-model/water-model.html">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shiftml/shiftml-example.html">Computing NMR shielding tensors using ShiftML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft-nc.html">Conservative fine-tuning for a PET model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eon-pet-neb/eon-pet-neb.html">Finding Reaction Paths with eOn and a Metatomic Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft.html">Fine-tuning the PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lode-linear/lode-linear.html">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-nc/pet-mad-nc.html">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metatomic-plumed/metatomic-plumed.html">ML collective variables in PLUMED with metatomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-mts-rpc/mts-rpc.html">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ring-polymer-instanton/rpi-rates.html">Ring Polymer Instanton Rate Theory: Tunneling Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-uq/pet-mad-uq.html">Uncertainty Quantification with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-pulsed/water-pulsed.html">Water orientation in a pulsed electric field</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-learn-tensors-with-mcov-learn-tensors-with-mcov-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="equivariant-model-for-tensorial-properties-based-on-scalar-features">
<span id="sphx-glr-examples-learn-tensors-with-mcov-learn-tensors-with-mcov-py"></span><h1>Equivariant model for tensorial properties based on scalar features<a class="headerlink" href="#equivariant-model-for-tensorial-properties-based-on-scalar-features" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Paolo Pegolo <a class="reference external" href="https://github.com/ppegolo">&#64;ppegolo</a></p>
</dd>
</dl>
<p>In this example, we demonstrate how to train a <a class="reference external" href="https://docs.metatensor.org/latest/atomistic">metatensor atomistic model</a> on dipole moments and polarizabilities
of small molecular systems, using a model that combines scalar descriptors
with equivariant tensorial components that depend in a simple way from
the molecular geometry. You may also want to read this
<a class="reference external" href="http://localhost:8000/examples/polarizability/polarizability.html">recipe for a linear polarizability model</a>,
which provides an alternative approach for tensorial learning.
The model is trained with
<a class="reference external" href="https://metatensor.github.io/metatrain/latest/index.html">metatrain</a>
and can then be used in an ASE calculator.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sphinx_gallery_thumbnail_path = &#39;../../examples/learn-tensors-with-mcov/architecture.png&#39; # noqa: E501</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>

<span class="c1"># Simulation and visualization tools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chemiscope</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">metatensor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mts</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Model wrapping and execution tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">featomic.clebsch_gordan</span><span class="w"> </span><span class="kn">import</span> <span class="n">cartesian_to_spherical</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">TensorBlock</span><span class="p">,</span> <span class="n">TensorMap</span>
</pre></div>
</div>
<section id="load-the-training-data">
<h2>Load the training data<a class="headerlink" href="#load-the-training-data" title="Link to this heading">¶</a></h2>
<p>We load a simple dataset of small molecules from the <a class="reference external" href="https://doi.org/10.1038/s41597-021-00812-2">QM7-X dataset</a> spanning the CHNO composition space.
We extract their dipole moments and polarizability tensors stored in extended XYZ
format.
We also visualize dipoles as arrows and polarizabilities as ellipsoids with
<a class="reference external" href="https://chemiscope.org/">chemiscope</a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">molecules</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;data/qm7x_reduced_100_CHNO.xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>

<span class="n">arrows</span> <span class="o">=</span> <span class="n">chemiscope</span><span class="o">.</span><span class="n">ase_vectors_to_arrows</span><span class="p">(</span><span class="n">molecules</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">arrows</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;global&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#008000&quot;</span>

<span class="n">ellipsoids</span> <span class="o">=</span> <span class="n">chemiscope</span><span class="o">.</span><span class="n">ase_tensors_to_ellipsoids</span><span class="p">(</span><span class="n">molecules</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ellipsoids</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;global&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#FF8800&quot;</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">molecules</span><span class="p">,</span>
    <span class="n">shapes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mu&quot;</span><span class="p">:</span> <span class="n">arrows</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">ellipsoids</span><span class="p">},</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span>
        <span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">]},</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">cs</span>
</pre></div>
</div>
<!-- begin headers -->
<!-- Load all dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

<!-- JS scripts -->
<script src="../../_static/chemiscope.min.js"></script>
<script src="../../_static/chemiscope-sphinx.js"></script>

<!-- CSS styles -->
<link rel="stylesheet" href="../../_static/chemiscope-sphinx.css" type="text/css" />
<!-- end headers -->

<!-- Error display -->
<div id="chsp-549e365e-9888-4c9b-88f7-190cc46eef14-error-display" class="chemiscope-sphinx-error">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-549e365e-9888-4c9b-88f7-190cc46eef14-error-display')">
        &times;
    </button>
</div>

<!-- Warning Display -->
<div id="chsp-549e365e-9888-4c9b-88f7-190cc46eef14-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-549e365e-9888-4c9b-88f7-190cc46eef14-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-549e365e-9888-4c9b-88f7-190cc46eef14-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-549e365e-9888-4c9b-88f7-190cc46eef14">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-549e365e-9888-4c9b-88f7-190cc46eef14', '../../_datasets/4358a4e6ed1457c138a89990a2d36c06bf2ef7154084ec48961721cdb546596f-fig_learn-tensors-with-mcov_001.json.gz', 'structure', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /></section>
<section id="prepare-the-target-tensors-for-training">
<h2>Prepare the target tensors for training<a class="headerlink" href="#prepare-the-target-tensors-for-training" title="Link to this heading">¶</a></h2>
<p>We first split the dataset into training, validation, and test sets.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">))</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.80</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">))</span>
<span class="n">n_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.10</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">))</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.10</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

<span class="n">train_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">val_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n_train</span> <span class="p">:</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_val</span><span class="p">]</span>
<span class="n">test_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n_train</span> <span class="o">+</span> <span class="n">n_val</span> <span class="p">:</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_val</span> <span class="o">+</span> <span class="n">n_test</span><span class="p">]</span>
</pre></div>
</div>
<p>For each split, we extract dipole moments and polarizability tensors from the extended
XYZ file and create a <a class="reference external" href="https://docs.metatensor.org/latest/torch/reference/tensor.html#metatensor.torch.TensorMap" title="(in metatensor)"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatensor.torch.TensorMap</span></code></a> containing their Cartesian
components.
Since our machine-learning model uses spherical tensors, we convert Cartesian tensors
into their irreducible spherical form via Clebsch-Gordan coupling, using
<a class="reference external" href="http://docs.metatensor.org/featomic/latest/references/api/python/clebsch-gordan.html#featomic.clebsch_gordan.cartesian_to_spherical" title="(in Featomic)"><code class="xref py py-func docutils literal notranslate"><span class="pre">featomic.clebsch_gordan.cartesian_to_spherical()</span></code></a>. What is happening under the
hood is:</p>
<ol class="arabic">
<li><p>We reorder tensor components from the Cartesian <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span>,
which correspond to the spherical <span class="math notranslate nohighlight">\(m=1,-1,0\)</span>, to the standard ordering
<span class="math notranslate nohighlight">\(m=-1,0,1\)</span>.</p></li>
<li><p>Dipoles moments (<span class="math notranslate nohighlight">\(\lambda=1\)</span>) require no further operations. For
polarizabilties we need to couple the resulting components:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\alpha_{\lambda\mu} = \sum_{m_1,m_2} C^{\lambda \mu}_{m_1 m_2} \alpha_{m_1 m_2}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(C^{\lambda m}_{m_1 m_2}\)</span> are the Clebsch-Gordan
coefficients.
Since the polarizability is a symmetric rank-2 Cartesian tensor, only the
<span class="math notranslate nohighlight">\(\lambda=0,2\)</span> components are non-zero For example, the <span class="math notranslate nohighlight">\(\lambda=0\)</span>
component is proportional to the trace of the Cartesian tensor:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\alpha_{\lambda=0} = -\frac{1}{\sqrt{3}} \left( \alpha_{xx} + \alpha_{yy} +
\alpha_{zz} \right)\]</div>
</div>
</li>
</ol>
<p>After the conversion, we save the spherical tensors into <code class="docutils literal notranslate"><span class="pre">metatensor</span></code>  sparse
format.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">,</span> <span class="n">test_indices</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
    <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">_set.xyz&quot;</span><span class="p">,</span>
        <span class="n">subset</span><span class="p">,</span>
        <span class="n">write_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create Cartesian tensormaps</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">molecule</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">])</span>
    <span class="n">cartesian_mu</span> <span class="o">=</span> <span class="n">TensorMap</span><span class="p">(</span>
        <span class="n">Labels</span><span class="o">.</span><span class="n">single</span><span class="p">(),</span>
        <span class="p">[</span>
            <span class="n">TensorBlock</span><span class="p">(</span>
                <span class="n">samples</span><span class="o">=</span><span class="n">Labels</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">Labels</span><span class="o">.</span><span class="n">single</span><span class="p">(),</span>
                <span class="n">values</span><span class="o">=</span><span class="n">mu</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">molecule</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">])</span>
    <span class="n">cartesian_alpha</span> <span class="o">=</span> <span class="n">TensorMap</span><span class="p">(</span>
        <span class="n">Labels</span><span class="o">.</span><span class="n">single</span><span class="p">(),</span>
        <span class="p">[</span>
            <span class="n">TensorBlock</span><span class="p">(</span>
                <span class="n">samples</span><span class="o">=</span><span class="n">Labels</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xyz_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">Labels</span><span class="o">.</span><span class="n">single</span><span class="p">(),</span>
                <span class="n">values</span><span class="o">=</span><span class="n">alpha</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Convert Cartesian to spherical tensormaps</span>
    <span class="n">spherical_mu</span> <span class="o">=</span> <span class="n">mts</span><span class="o">.</span><span class="n">remove_dimension</span><span class="p">(</span>
        <span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="n">cartesian_mu</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]),</span> <span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span>
    <span class="p">)</span>
    <span class="n">spherical_alpha</span> <span class="o">=</span> <span class="n">mts</span><span class="o">.</span><span class="n">remove_dimension</span><span class="p">(</span>
        <span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="n">cartesian_alpha</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;xyz_1&quot;</span><span class="p">,</span> <span class="s2">&quot;xyz_2&quot;</span><span class="p">]),</span> <span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Save the spherical tensormaps to disk, ensuring contiguous memory layout</span>
    <span class="n">mts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">_dipoles.mts&quot;</span><span class="p">,</span> <span class="n">mts</span><span class="o">.</span><span class="n">make_contiguous</span><span class="p">(</span><span class="n">spherical_mu</span><span class="p">))</span>
    <span class="n">mts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">_polarizabilities.mts&quot;</span><span class="p">,</span> <span class="n">mts</span><span class="o">.</span><span class="n">make_contiguous</span><span class="p">(</span><span class="n">spherical_alpha</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="the-lambda-mcov-model">
<h2>The <span class="math notranslate nohighlight">\(\lambda\)</span>-MCoV model<a class="headerlink" href="#the-lambda-mcov-model" title="Link to this heading">¶</a></h2>
<p>Here is a schematic representation of the <span class="math notranslate nohighlight">\(\lambda\)</span>-MCoV model which, in a
nutshell, allows us to learn a tensorial property of a system from a set of scalar
features used as linear expansion coefficients of a minimal set of basis tensors.</p>
<img alt="../../_images/architecture.png" class="align-center" src="../../_images/architecture.png" />
<p>We parametrize spherical tensors of order <span class="math notranslate nohighlight">\(\lambda\)</span> as linear combinations
of a small, fixed set of <strong>maximally coupled</strong> basis tensors. Each basis tensor is
computed from three learned <strong>vector</strong> features, and each coefficient is predicted by
a <strong>scalar</strong> function of the local atomic environment. This enforces exact
equivariance under the action of the orthogonal group O(3), while relying only on
efficient scalar networks.
The architecture is composed as follows:</p>
<section id="local-spherical-expansion">
<h3>1. Local Spherical Expansion<a class="headerlink" href="#local-spherical-expansion" title="Link to this heading">¶</a></h3>
<p>We compute atom-centered spherical expansion coefficients of the neighbor density
around atom <span class="math notranslate nohighlight">\(i\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\boldsymbol{\rho}_{z,nl} = \sum_{i \in z} R_{n,l}(r_i) \,
\boldsymbol{Y}_l(\hat{\mathbf{r}}_i)\]</div>
</div>
<p>for orders <span class="math notranslate nohighlight">\(l=1\)</span> (vector basis) up to <span class="math notranslate nohighlight">\(l=\lambda\)</span> (correction).</p>
</section>
<section id="learned-vector-basis">
<h3>2. Learned Vector Basis<a class="headerlink" href="#learned-vector-basis" title="Link to this heading">¶</a></h3>
<p>From the <span class="math notranslate nohighlight">\(l=1\)</span> coefficients, we form three global vectors by a learnable linear
layer over species <span class="math notranslate nohighlight">\(z\)</span> and radial channels <span class="math notranslate nohighlight">\(n\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{q}_\alpha = \sum_{z,n} W_{\alpha,zn}\,\boldsymbol{\rho}_{z,n1}\]</div>
</div>
</section>
<section id="maximally-coupled-tensor-basis">
<h3>3. Maximally Coupled Tensor Basis<a class="headerlink" href="#maximally-coupled-tensor-basis" title="Link to this heading">¶</a></h3>
<p>We build the <span class="math notranslate nohighlight">\(2\lambda+1\)</span> independent components by <strong>maximally coupling</strong> the
three vectors <span class="math notranslate nohighlight">\(\mathbf{q}_1,\mathbf{q}_2,\mathbf{q}_3\)</span>. Maximally coupled
tensors are defined by contracting their harmonic components to the highest total
angular momentum. For example, maximally coupling <span class="math notranslate nohighlight">\(\lambda\)</span> vectors yields:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[(\underbrace{\mathbf{a}_1 \widetilde{\otimes} \ldots \widetilde{\otimes}
\mathbf{a}_\lambda}_{\lambda\text{ times}})_{\lambda\mu} := \Big(\big(\cdots
\big((\mathbf{a}_1 \widetilde{\otimes} \mathbf{a}_2)_2 \widetilde{\otimes}
\mathbf{a}_3\big)_3\widetilde{\otimes} \cdots \widetilde{\otimes}
\mathbf{a}_{\lambda-1}\big)_{\lambda-1}\widetilde{\otimes}
\mathbf{a}_\lambda\Big)_{\lambda\mu} \phantom{:}= \sum_{m_1\ldots m_\lambda}
\mathcal{C}^{\lambda\mu}_{m_1\ldots m_\lambda}\big((\mathbf{a}_1)_{m_1} \cdot
\ldots\cdot (\mathbf{a}_\lambda)_{m_\lambda}\big),\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{C}^{\lambda\mu}_{m_1\ldots m_\lambda}\)</span> a shorthand notation for
the components of the tensor <span class="math notranslate nohighlight">\(\mathcal{C}\)</span> obtained by contracting the
Clebsch-Gordan coefficients involved in the coupling.</p>
<p>With this definition, vector components can be expressed as</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{T}_{1}(\{\mathbf{r}_i\}) = \sum_{\alpha = 1}^3 f_{\alpha}
(\{\mathbf{r}_i\})\,\mathbf{q}_{\alpha},\]</div>
</div>
<p>and <span class="math notranslate nohighlight">\(\lambda=2\)</span> components as</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{T}_{2}(\{\mathbf{r}_i\}) = \sum_{\alpha = 1}^2 f_\alpha(\{\mathbf{r}_i\})
\mathbf{q}_\alpha^{\widetilde{\otimes} 2}\,\,+ \sum_{\substack{\alpha_1,\alpha_2=
1\\\alpha_1&lt;\alpha_2}}^{3} g_{\alpha_1\alpha_2}(\{\mathbf{r}_i\})
\big(\mathbf{q}_{\alpha_1}\widetilde{\otimes} \mathbf{q}_{\alpha_2}\big)_{2}.\end{split}\]</div>
</div>
<p>More generally, for any <span class="math notranslate nohighlight">\(\lambda&gt;2\)</span> we have:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{T}_{\lambda} (\{\mathbf{r}_i\}) = \sum_{l= 0}^\lambda f_{l}
(\{\mathbf{r}_i\}) \Big(\mathbf{q}_1^{\widetilde{\otimes} l}\widetilde{\otimes}
{\mathbf{q}}_2^{\widetilde{\otimes}(\lambda-l)}\Big)_{\lambda}+
\sum_{l=0}^{\lambda-1} g_{l} (\{\mathbf{r}_i\})
\Big(\mathbf{q}^{\widetilde{\otimes} l}_1\widetilde{\otimes}
\mathbf{q}_2^{\widetilde{\otimes} (\lambda-l-1)}\widetilde{\otimes}
\mathbf{q}_3\Big)_{\lambda\mu}.\]</div>
</div>
</section>
<section id="lambda-correction-term">
<h3>4. <span class="math notranslate nohighlight">\(\lambda\)</span>-Correction Term<a class="headerlink" href="#lambda-correction-term" title="Link to this heading">¶</a></h3>
<p>Highly symmetric environments can lead to all-zero vector spherical expansion
components, which in turn would yield all-zero tensor features.
To correct this, we add a term based on the order <span class="math notranslate nohighlight">\(\lambda\)</span> spherical expansion:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{T}_\lambda^{\rm corr}(\{\mathbf{r}_i\}) \;=\;
\sum_{\beta=1}^{2\lambda+1}
h_\beta(\{\mathbf{r}_i\})\,
\sum_{z,n}W^{\rm corr}_{\beta,zn}\,\boldsymbol{\rho}_{z,n}^{l=\lambda}\]</div>
</div>
<p>with learnable scalar functions <span class="math notranslate nohighlight">\(h_\beta(\{\mathbf{r}_i\})\)</span>.</p>
</section>
<section id="scalar-network-soap-bpnn">
<h3>5. Scalar Network (SOAP-BPNN)<a class="headerlink" href="#scalar-network-soap-bpnn" title="Link to this heading">¶</a></h3>
<p>We first compute <strong>SOAP powerspectrum</strong> features:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[p_{z_1z_2,n_1 n_2,l} = \bigl(\boldsymbol{\rho}_{z_1,n_1 l} \widetilde{\otimes}
\boldsymbol{\rho}_{z_2,n_2 l}\bigr)_0\]</div>
</div>
<p>and then apply a small, per-species multi-layer perceptron to map these features to
scalar coefficients <span class="math notranslate nohighlight">\(f,g,h\)</span>.</p>
</section>
<section id="assembly-and-global-output">
<h3>6. Assembly and Global Output<a class="headerlink" href="#assembly-and-global-output" title="Link to this heading">¶</a></h3>
<p>Finally, we assemble the tensor:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{T}_\lambda(\{\mathbf{r}_i\}) = \sum_{\beta=1}^{2\lambda+1}
s_\beta(\{\mathbf{r}_i\}) \, \mathbf{B}^\lambda_\beta
(\mathbf{q}_1,\mathbf{q}_2,\mathbf{q}_3) + \mathbf{T}_\lambda^{\mathrm{corr}}
(\{\mathbf{r}_i\}),\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{B}^\lambda_\beta\)</span> is a shorthand for the basis tensors and
<span class="math notranslate nohighlight">\(s_\beta\)</span> for the scalar coefficients. For global properties we sum over all
atoms.</p>
</section>
</section>
<section id="training-and-evaluation-of-the-model">
<h2>Training and evaluation of the model<a class="headerlink" href="#training-and-evaluation-of-the-model" title="Link to this heading">¶</a></h2>
<p>Rather than implementing the <span class="math notranslate nohighlight">\(\lambda\)</span>-MCoV model from scratch, we use a
pre-defined architecture within the <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> package, using its command-line
interface.
To start training, we run</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mtt<span class="w"> </span>train<span class="w"> </span>options.yaml
</pre></div>
</div>
<p>The options file specifies the model architecture and the training parameters:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">base_precision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">architecture</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">soap_bpnn</span>
<span class="w">  </span><span class="nt">training</span><span class="p">:</span>
<span class="w">    </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">num_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">    </span><span class="nt">log_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">training_set</span><span class="p">:</span>
<span class="w">  </span><span class="nt">systems</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">training_set.xyz</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">mtt::dipole</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">training_dipoles.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">mtt::polarizability</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">training_polarizabilities.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="nt">validation_set</span><span class="p">:</span>
<span class="w">  </span><span class="nt">systems</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validation_set.xyz</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">mtt::dipole</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validation_dipoles.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">mtt::polarizability</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validation_polarizabilities.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="nt">test_set</span><span class="p">:</span>
<span class="w">  </span><span class="nt">systems</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_set.xyz</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">mtt::dipole</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_dipoles.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">mtt::polarizability</span><span class="p">:</span>
<span class="w">      </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_polarizabilities.mts</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">          </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>To execute <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> from within a script, use</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;mtt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;train&quot;</span><span class="p">,</span>
        <span class="s2">&quot;options.yaml&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>CompletedProcess(args=[&#39;mtt&#39;, &#39;train&#39;, &#39;options.yaml&#39;], returncode=0)
</pre></div>
</div>
<p>We visualize training and validation losses as functions of the epoch.
The training log is stored in CSV format in the <code class="docutils literal notranslate"><span class="pre">outputs</span></code> directory.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">train_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
    <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;outputs/*/*/train.csv&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
<span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">train_log</span><span class="p">[</span><span class="s2">&quot;Epoch&quot;</span><span class="p">],</span> <span class="n">train_log</span><span class="p">[</span><span class="s2">&quot;training_loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">train_log</span><span class="p">[</span><span class="s2">&quot;Epoch&quot;</span><span class="p">],</span> <span class="n">train_log</span><span class="p">[</span><span class="s2">&quot;validation_loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Training and validation loss&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_learn-tensors-with-mcov_001.png" srcset="../../_images/sphx_glr_learn-tensors-with-mcov_001.png" alt="Training and validation loss" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Training and validation loss&#39;)
</pre></div>
</div>
<p>We evaluate the model on the test set using the <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> command-line interface:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mtt<span class="w"> </span><span class="nb">eval</span><span class="w"> </span>model.pt<span class="w"> </span>eval.yaml<span class="w"> </span>-e<span class="w"> </span>extensions<span class="w"> </span>-o<span class="w"> </span>test_results.mts
</pre></div>
</div>
<p>The evaluation YAML file contains lists the structures and corresponding reference
quantities for the evaluation:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">systems</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_set.xyz</span>
<span class="nt">targets</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="nt">mtt::dipole</span><span class="p">:</span>
<span class="w">    </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_dipoles.mts</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">      </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">        </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">mtt::polarizability</span><span class="p">:</span>
<span class="w">    </span><span class="nt">read_from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_polarizabilities.mts</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span>
<span class="w">      </span><span class="nt">spherical</span><span class="p">:</span>
<span class="w">        </span><span class="nt">irreps</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">o3_lambda</span><span class="p">:</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nt"> o3_sigma</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>We can evaluate the model from within the script with</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;mtt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model.pt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eval.yaml&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extensions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_results.mts&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>CompletedProcess(args=[&#39;mtt&#39;, &#39;eval&#39;, &#39;model.pt&#39;, &#39;eval.yaml&#39;, &#39;-e&#39;, &#39;extensions&#39;, &#39;-o&#39;, &#39;test_results.mts&#39;], returncode=0)
</pre></div>
</div>
<p>We load the test set predictions and targets from disk and prepare them for
comparison.
Predictions are in <code class="docutils literal notranslate"><span class="pre">test_results_mtt::dipole.mts</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_results_mtt::polarizability.mts</span></code>. Targets are in <code class="docutils literal notranslate"><span class="pre">test_dipoles.mts</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_polarizabilities.mts</span></code>. We can load them using
the <a class="reference external" href="https://docs.metatensor.org/latest/core/reference/python/io.html#metatensor.load" title="(in metatensor)"><code class="xref py py-func docutils literal notranslate"><span class="pre">metatensor.load()</span></code></a> function.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_test</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">mts</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test_results_mtt::dipole.mts&quot;</span><span class="p">),</span>
    <span class="s2">&quot;polarizability&quot;</span><span class="p">:</span> <span class="n">mts</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test_results_mtt::polarizability.mts&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">target_test</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">mts</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test_dipoles.mts&quot;</span><span class="p">),</span>
    <span class="s2">&quot;polarizability&quot;</span><span class="p">:</span> <span class="n">mts</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test_polarizabilities.mts&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">test_set_molecules</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;test_set.xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">natm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">test_set_molecules</span><span class="p">])</span>
</pre></div>
</div>
<p>We create parity plots comparing predicted and target values for each target quantity
and for each <span class="math notranslate nohighlight">\(\lambda\)</span> component.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">color_per_lambda</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;C2&quot;</span><span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">prediction_test</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">prediction_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">keys</span>
        <span class="n">o3_lambda</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s2">&quot;o3_lambda&quot;</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;$\lambda=</span><span class="si">{</span><span class="n">o3_lambda</span><span class="si">}</span><span class="s2">$&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_per_lambda</span><span class="p">[</span><span class="n">o3_lambda</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Target (a.u./atom)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Prediction (a.u./atom)&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_learn-tensors-with-mcov_002.png" srcset="../../_images/sphx_glr_learn-tensors-with-mcov_002.png" alt="Dipole, Polarizability" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 23.644 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-learn-tensors-with-mcov-learn-tensors-with-mcov-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/3be46ae9dee6c3306a74c92db8c769b7/learn-tensors-with-mcov.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">learn-tensors-with-mcov.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/5edeac5d19ba0651ae3382d5facada56/learn-tensors-with-mcov.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">learn-tensors-with-mcov.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/e214c5d7b759619672f19c02dcb8ed1c/learn-tensors-with-mcov.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">learn-tensors-with-mcov.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../eon-pet-neb/eon-pet-neb.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Finding Reaction Paths with eOn and a Metatomic Potential</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../polarizability/polarizability.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Equivariant linear model for polarizability</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2026, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Equivariant model for tensorial properties based on scalar features</a><ul>
<li><a class="reference internal" href="#load-the-training-data">Load the training data</a></li>
<li><a class="reference internal" href="#prepare-the-target-tensors-for-training">Prepare the target tensors for training</a></li>
<li><a class="reference internal" href="#the-lambda-mcov-model">The <span class="math notranslate nohighlight">\(\lambda\)</span>-MCoV model</a><ul>
<li><a class="reference internal" href="#local-spherical-expansion">1. Local Spherical Expansion</a></li>
<li><a class="reference internal" href="#learned-vector-basis">2. Learned Vector Basis</a></li>
<li><a class="reference internal" href="#maximally-coupled-tensor-basis">3. Maximally Coupled Tensor Basis</a></li>
<li><a class="reference internal" href="#lambda-correction-term">4. <span class="math notranslate nohighlight">\(\lambda\)</span>-Correction Term</a></li>
<li><a class="reference internal" href="#scalar-network-soap-bpnn">5. Scalar Network (SOAP-BPNN)</a></li>
<li><a class="reference internal" href="#assembly-and-global-output">6. Assembly and Global Output</a></li>
</ul>
</li>
<li><a class="reference internal" href="#training-and-evaluation-of-the-model">Training and evaluation of the model</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=01c87ff6"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>