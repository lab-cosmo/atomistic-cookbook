<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html"><link rel="next" title="PCA/PCovR Visualization of a training dataset for a potential" href="../gaas-map/gaas-map.html"><link rel="prev" title="ML collective variables in PLUMED with metatomic" href="../metatomic-plumed/metatomic-plumed.html">
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/pi-mts-rpc/mts-rpc.html">
        <link rel="prefetch" href="../../_static/cookbook-icon.svg" as="image">

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"><!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>Multiple time stepping and ring-polymer contraction - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input aria-label="Toggle navigation of Recipes grouped by topic" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/universal.html">Universal ML models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input aria-label="Toggle navigation of Recipes grouped by software used" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/eon.html">eon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/gromacs.html">GROMACS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input aria-label="Toggle navigation of List of all recipes" checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-model/water-model.html">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shiftml/shiftml-example.html">Computing NMR shielding tensors using ShiftML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft-nc.html">Conservative fine-tuning for a PET model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learn-tensors-with-mcov/learn-tensors-with-mcov.html">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eon-pet-neb/eon-pet-neb.html">Finding Reaction Paths with eOn and a Metatomic Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft.html">Fine-tuning the PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lode-linear/lode-linear.html">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-nc/pet-mad-nc.html">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metatomic-plumed/metatomic-plumed.html">ML collective variables in PLUMED with metatomic</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ring-polymer-instanton/rpi-rates.html">Ring Polymer Instanton Rate Theory: Tunneling Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-uq/pet-mad-uq.html">Uncertainty Quantification with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-pulsed/water-pulsed.html">Water orientation in a pulsed electric field</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-pi-mts-rpc-mts-rpc-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="multiple-time-stepping-and-ring-polymer-contraction">
<span id="sphx-glr-examples-pi-mts-rpc-mts-rpc-py"></span><h1>Multiple time stepping and ring-polymer contraction<a class="headerlink" href="#multiple-time-stepping-and-ring-polymer-contraction" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Davide Tisi <a class="reference external" href="https://github.com/DavideTisi">&#64;DavideTisi</a> and
Michele Ceriotti <a class="reference external" href="https://github.com/ceriottm">&#64;ceriottm</a></p>
</dd>
</dl>
<p>This notebook provides an introduction to multiple time stepping and
ring polymer contraction, two closely-related techniques,
that are geared towards reducing the cost of calculations by separating
slowly-varying (and computationally-expensive) components of the potential
energy from the fast-varying (and hopefully cheaper) ones.</p>
<p>The first, <cite>multiple time stepping</cite> or MTS, is a well-established technique
to avoid evaluating the slowly-varying components at every time step of a MD simulation.
It was first introduced in
<a class="reference external" href="https://doi.org/10.1063/1.463137">M. Tuckerman, B. J. Berne, and G. J. Martyna,
JCP 97(3), 1990 (1992)</a>
and can be applied to classical simulations,
typically to avoid the evaluation of long-range electrostatics in classical
empirical potentials.</p>
<p>The second, named <cite>ring polymer contraction</cite>, was first introduced in
<a class="reference external" href="https://doi.org/10.1063/1.2953308">T. E. Markland and D. E. Manolopoulos, JCP 129(2),
024105 (2008)</a> and
can be seen as performing a similar simplification <cite>in imaginary time</cite>,
evaluating the expensive part of the potential on a smaller number
of PI replicas.</p>
<p>The techniques can be combined, which reduces even further the
computational effort, which is the case we demonstrate in this
notebook. This dual approach was introduced in
<a class="reference external" href="(https://doi.org/10.1063/1.4941091">V. Kapil, J. VandeVondele, and M. Ceriotti, JCP 144(5),
054111 (2016)</a>
and <a class="reference external" href="https://doi.org/10.1063/1.4941093">O. Marsalek and T. E. Markland, JCP 144(5),
(2016)</a>.
It is worth stressing that MTS and/or RPC can also be used very conveniently
together with machine-learning potentials
(see e.g. <a class="reference external" href="https://doi.org/10.1063/1.4971438">V. Kapil, J. Behler, and M. Ceriotti, JCP 145(23),
234103 (2016</a> or
<a class="reference external" href="http://doi.org/10.1021/acs.jctc.0c00362">K. Rossi et al., JCTC 16(8), 5139 (2020)</a>
for early applications).</p>
<p>If you need an introduction to path integral simulations,
or to the use of <a class="reference external" href="http://ipi-code.org">i-PI</a>, which is the
software which will be used to perform simulations, you can see
<a class="reference external" href="https://atomistic-cookbook.org/examples/path-integrals/path-integrals.html">this introductory recipe</a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">chemiscope</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="c1"># sphinx_gallery_thumbnail_number = 2</span>
</pre></div>
</div>
<section id="multiple-time-stepping-in-real-and-imaginary-time">
<h2>Multiple time stepping in real and imaginary time<a class="headerlink" href="#multiple-time-stepping-in-real-and-imaginary-time" title="Link to this heading">¶</a></h2>
<p>The core underlying assumption in these techniques is that the potential
can be decomposed into a short-range/fast-varying/computationally-cheap
part <span class="math notranslate nohighlight">\(V_\mathrm{sr}\)</span> and a long-range/slow-varying/computationally-expensive
part <span class="math notranslate nohighlight">\(V_\mathrm{lr}\)</span>.  This is usually written as
<span class="math notranslate nohighlight">\(V=V_\mathrm{sr} +V_\mathrm{lr}\)</span>, although in many cases <span class="math notranslate nohighlight">\(V_\mathrm{sr}\)</span>
is a cheap approximation of the potential, and <span class="math notranslate nohighlight">\(V_\mathrm{lr}\)</span>
is taken to be the difference between this potential and the full one.</p>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/pimd-mts-pots.png"><img alt="../../_images/pimd-mts-pots.png" src="../../_images/pimd-mts-pots.png" style="width: 500px;" />
</a>
<figcaption>
<p><span class="caption-text">A smooth and rough potential components combine to form the total potential
energy function used in a simulation.</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The way this is realized in practice is by splitting the propagation of
Hamilton’s equations into an inner loop that uses the fast/cheap force,
and an outer loop that applies the slow force, using a larger time step
(and therefore giving a larger “kick”).</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
&amp;p \leftarrow p + f_\mathrm{lr} \, dt/2 \\
&amp;\left.
\begin{split}
&amp;p \leftarrow p + f_\mathrm{sr} \, dt/2M \\
&amp;q \leftarrow q + p \, dt/M \\
&amp;p \leftarrow p + f_\mathrm{sr} \, dt/2M \\
\end{split}
\right\} M\ \mathrm{times}\\
&amp;p \leftarrow p + f_\mathrm{lr} \, dt/2 \\
\end{split}\end{split}\]</div>
</div>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/pimd-mts-integrator.png"><img alt="../../_images/pimd-mts-integrator.png" src="../../_images/pimd-mts-integrator.png" style="width: 500px;" />
</a>
<figcaption>
<p><span class="caption-text">Schematic representation of the application of slow and fast
forces in a multiple time step molecular dynamics algorithm</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>This approach can (and usually is) complemented by aggressive
thermostatting, which helps stabilize the dynamics in the
limit of large <span class="math notranslate nohighlight">\(M\)</span>.
For a detailed discussion on how thermostatting aids
in this context, see:
<a class="reference external" href="https://doi.org/10.1063/1.3518369">J. A. Morrone, T. E. Markland, M. Ceriotti, and B. J. Berne,
JCP 134(1), 14103 (2011)</a></p>
<p>The idea behind ring-polymer contraction is very similar:
it is unnecessary to evaluate on a very fine-grained discretization
of the path integral components of the potential that are slowly-varying.</p>
<a class="reference internal image-reference" href="../../_images/pimd-mts-rpc.png"><img alt="../../_images/pimd-mts-rpc.png" class="align-center" src="../../_images/pimd-mts-rpc.png" style="width: 500px;" />
</a>
<p>As shown in the figure below, ring-polymer contraction
is realized by computing a Fourier interpolation of the bead positions,
<span class="math notranslate nohighlight">\(\tilde{\mathbf{q}}^{(k)}\)</span>, and then evaluating the total potential
that enters the ring-polymer Hamiltonian as</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V(\mathbf{q}) = \sum_{k=1}^P V_\mathrm{sr}(\mathbf{q}^{(k)}) + \frac{P}{P'}
  \sum_{k=1}^{P'} V_\mathrm{lr}(\tilde{\mathbf{q}}^{(k)})\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(P'\)</span> indicate the full
and contracted discretizations of the path.</p>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="../../_images/rpc-4.png"><img alt="../../_images/rpc-4.png" src="../../_images/rpc-4.png" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-text">An example of the successive degrees of contraction of a ring polymer
containing 16 beads (gray), interpolated down to 8 and 4.</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="a-reference-calculation-using-piglet">
<h2>A reference calculation using PIGLET<a class="headerlink" href="#a-reference-calculation-using-piglet" title="Link to this heading">¶</a></h2>
<p>First, let’s run a reference calculation without RPC or MTS.
These calculations will be performed using the q-TIP4P/f water model
(<a class="reference external" href="https://doi.org/10.1063/1.3167790">S. Habershon, T. E. Markland, and D. E. Manolopoulos, JCP 131(2),
24501 (2009)</a>)
that contains a Morse-potential anharmonic intra-molecular potential,
and an inter-molecular potential based on a Lennard-Jones term and a 4-point
electrostatic model (the venerable TIP4P idea).
It is fitted to reproduce experimental properties of water
<cite>when performing PIMD calculations</cite>
and it captures nicely several subtle effects while being cheap and easy-to-implement.
The input for this run is <cite>h2o_pimd.xml</cite>, and we will use the
<cite>-m qtip4pf</cite> option of <cite>i-pi-driver</cite> to compute the appropriate potential.
To make simulations run quickly, we use a small box containing only 32
water molecules, and use a <cite>PIGLET</cite> thermostat that yields converged
quantum properties with only 8 beads (cf.
<a class="reference external" href="https://doi.org/10.1103/PhysRevLett.109.100604">M. Ceriotti and D. E. Manolopoulos, Phys. Rev. Lett. 109(10), 100604
(2012)</a>,
and also this <a class="reference external" href="https://atomistic-cookbook.org/examples/path-integrals/path-integrals.html#accelerating-pimd-with-a-piglet-thermostat">introduction to the PIGLET method</a>).
For simplicity, we use the constant-volume <cite>NVT</cite> ensemble, but you can easily
modify the input to perform constant-pressure simulations.</p>
<p>The important parts of the simulation
- which we will modify to run a RPC/MTS simulation -
are the definition of the forcefield socket</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open and read the XML file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/h2o_pimd.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf&#39; pbc=&#39;false&#39;&gt;
    &lt;address&gt;qtip4pf&lt;/address&gt;
&lt;/ffsocket&gt;
</pre></div>
</div>
<p>The important parts of the simulation
- which we will modify to run a RPC/MTS simulation -
are the definition of the forcefield socket,
with the corresponding force definition</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[...]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  &lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf&#39; pbc=&#39;false&#39;&gt;
      &lt;address&gt;qtip4pf&lt;/address&gt;
  &lt;/ffsocket&gt;

[...]

    &lt;forces&gt;
      &lt;force forcefield=&#39;qtip4pf&#39;/&gt;
    &lt;/forces&gt;
</pre></div>
</div>
<p>… the definition of the number of beads</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;initialize nbeads=&#39;8&#39;&gt;
</pre></div>
</div>
<p>… and the time step</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;timestep units=&#39;femtosecond&#39;&gt; 0.5 &lt;/timestep&gt;
</pre></div>
</div>
<p>The <cite>&lt;thermostat&gt;</cite> section contains PIGLET parameters generated using the
<a class="reference external" href="https://gle4md.org">GLE4MD website</a>
.</p>
<section id="installing-the-python-driver">
<h3>Installing the Python driver<a class="headerlink" href="#installing-the-python-driver" title="Link to this heading">¶</a></h3>
<p>i-PI comes with a FORTRAN driver, which however has to be installed
from source. We use a utility function to compile it. Note that this requires
a functioning build system with <cite>gfortran</cite> and <cite>make</cite>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ipi</span><span class="o">.</span><span class="n">install_driver</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="launch-the-i-pi-simulation">
<h3>Launch the i-PI simulation<a class="headerlink" href="#launch-the-i-pi-simulation" title="Link to this heading">¶</a></h3>
<p>We are going to launch i-PI from here, and put it in background
and detach the processes from the
jupyter instance, so we can continue with the notebook.
On the the command line, this amounts to launching</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>i-pi<span class="w"> </span>data/h2o_pimd.xml<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.pimd<span class="w"> </span><span class="p">&amp;</span>
sleep<span class="w"> </span><span class="m">5</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf<span class="w"> </span>-m<span class="w"> </span>qtip4pf<span class="w"> </span>-v<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver.<span class="nv">$i</span><span class="w"> </span><span class="p">&amp;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>From a Python script, one can launch both i-PI and the driver
using the <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> module:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ipi_process</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;pimd.out&quot;</span><span class="p">):</span>
    <span class="n">ipi_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi&quot;</span><span class="p">,</span> <span class="s2">&quot;data/h2o_pimd.xml&quot;</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># wait for i-PI to start</span>
    <span class="n">lmp_process</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>If you run this in a notebook, you can go ahead and start loading
output files <em>before</em> i-PI and the driver have finished running, by
skipping this cell</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ipi_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ipi_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">lmp_process</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="multiple-time-stepping">
<h2>Multiple time stepping<a class="headerlink" href="#multiple-time-stepping" title="Link to this heading">¶</a></h2>
<p>Let’s now run a classical MD simulation, with and without multiple time stepping.
We use very conservative parameters and a weak thermostat, to be able to see the
difference in time scales between the full and short-range parts of the potential.
Let’s first run a classical MD for reference. The input file is <cite>data/h2o_md.xml</cite>,
nothing exciting to see there.
The bash command this time would be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>i-pi<span class="w"> </span>data/h2o_md.xml<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.md<span class="w"> </span><span class="p">&amp;</span>
sleep<span class="w"> </span><span class="m">5</span>
i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf-md<span class="w"> </span>-m<span class="w"> </span>qtip4pf<span class="w"> </span>-v<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver.<span class="nv">$i</span><span class="w"> </span><span class="p">&amp;</span>
</pre></div>
</div>
<p>From Python:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ipi_process</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;md.out&quot;</span><span class="p">):</span>
    <span class="n">ipi_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi&quot;</span><span class="p">,</span> <span class="s2">&quot;data/h2o_md.xml&quot;</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># wait for i-PI to start</span>
    <span class="n">lmp_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-md&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>If you run this in a notebook, you can go ahead and start loading
output files <em>before</em> i-PI and the driver have finished running, by
skipping this cell</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ipi_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ipi_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">lmp_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s have a look at <cite>h2o_mts.xml</cite>, that provides the parameters
of the MTS calculation. We define two <cite>ffsocket</cite> sections:
one will be used with the <cite>qtip4pf</cite> driver and the other with <cite>qtip4pf-sr</cite>.
Note the different names of the sockets (that have to match the <cite>-a</cite>
option in the invocation of the driver) and the internal labels that
will be referred to in the <cite>&lt;forces&gt;</cite> section.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/h2o_mts.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">13</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf&#39; pbc=&#39;false&#39;&gt;
    &lt;address&gt;qtip4pf-mts-full&lt;/address&gt;
&lt;/ffsocket&gt;
&lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf-sr&#39; pbc=&#39;false&#39;&gt;
    &lt;address&gt;qtip4pf-mts-sr&lt;/address&gt;
&lt;/ffsocket&gt;
</pre></div>
</div>
<p>Each <cite>&lt;force&gt;</cite> block contains a <cite>&lt;mts_weights&gt;</cite> section.
This provides a list of weights that determine which force
components are active at each level of the MTS hierarchy.
These weights indicate that the smooth part (full minus short-range)
is active in the outer loop, and the short-range part is active in the inner
loop. Note that the implementation is smart enough to reuse the short-range
potential computed in the inner loop, multiplying it with a weight of -1 to
compute <span class="math notranslate nohighlight">\(V_\mathrm{lr}=V-V_\mathrm{sr}\)</span>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">26</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;forces&gt;
  &lt;force forcefield=&#39;qtip4pf&#39;&gt;
    &lt;mts_weights&gt;[1,0]&lt;/mts_weights&gt;
  &lt;/force&gt;
  &lt;force forcefield=&#39;qtip4pf-sr&#39;&gt;
    &lt;mts_weights&gt;[-1,1]&lt;/mts_weights&gt;
  &lt;/force&gt;
&lt;/forces&gt;
</pre></div>
</div>
<p>It remains to specify the MTS setup. We use an outer time step of 2 fs
(four times the typical time step for room temperature water)
and a splitting with <cite>M=4</cite>, so the fast forces are computed every 0.5 fs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">33</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;timestep units=&#39;femtosecond&#39;&gt; 2.0 &lt;/timestep&gt;
&lt;nmts&gt;[1,4]&lt;/nmts&gt;
</pre></div>
</div>
<p>One final detail, is that we print out the two components of the potential.
This is achieved adding <cite>pot_component{units}(idx)</cite> to the <cite>&lt;properties&gt;</cite> field.
The index corresponds to the order by which the <cite>&lt;force&gt;</cite>
components are specified in the <cite>&lt;forces&gt;</cite> list.
NB: the time step in i-PI is the outer time step,
so it is not possible to access directly the value of
the potential for intermediate inner steps</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;properties filename=&#39;out&#39; stride=&#39;1&#39;&gt; [step, time{picosecond}, conserved{electronvolt}, temperature{kelvin}, potential{electronvolt}, kinetic_md{electronvolt}, pressure_md{megapascal}, pot_component{electronvolt}(0), pot_component{electronvolt}(1) ] &lt;/properties&gt;
</pre></div>
</div>
<p>Let’s get the simulation going. Notice that we need two drivers,
computing the short and full potentials,
connected to the proper <cite>&lt;ffsocket&gt;</cite> on the i-PI side
The correct <cite>bash</cite> command are:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>i-pi<span class="w"> </span>data/h2o_mts.xml<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.mts<span class="w"> </span><span class="p">&amp;</span>
sleep<span class="w"> </span><span class="m">5</span>
i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf-mts-full<span class="w"> </span>-m<span class="w"> </span>qtip4pf<span class="w">  </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver.full<span class="w"> </span><span class="p">&amp;</span>
i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf-mts-sr<span class="w"> </span>-m<span class="w"> </span>qtip4pf-sr<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver.sr<span class="w"> </span><span class="p">&amp;</span>
<span class="nb">wait</span>
</pre></div>
</div>
<p>that involve launching both short-range and full potential models.
Similarly, in Python:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ipi_process</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;mts.out&quot;</span><span class="p">):</span>
    <span class="n">ipi_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi&quot;</span><span class="p">,</span> <span class="s2">&quot;data/h2o_mts.xml&quot;</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># wait for i-PI to start</span>
    <span class="n">lmp_process0</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-mts-full&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lmp_process1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-mts-sr&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-sr&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>If you run this in a notebook, you can go ahead and start loading
output files <em>before</em> i-PI and the drivers have finished running, by
skipping this cell</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ipi_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ipi_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">lmp_process0</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">lmp_process1</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<section id="analysis-of-results">
<h3>Analysis of results<a class="headerlink" href="#analysis-of-results" title="Link to this heading">¶</a></h3>
<p>After having finished to run all simulation (might take a few minutes)
we can load the outputs</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">md_output</span><span class="p">,</span> <span class="n">md_desc</span> <span class="o">=</span> <span class="n">ipi</span><span class="o">.</span><span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;md.out&quot;</span><span class="p">)</span>
<span class="n">mts_output</span><span class="p">,</span> <span class="n">mts_desc</span> <span class="o">=</span> <span class="n">ipi</span><span class="o">.</span><span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;mts.out&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can start looking at the behavior of the two components of the potential.
Even though this is hardly the best slow/fast mode splitting (usually
one also includes the Lennard-Jones and short-range Coulomb components
in <span class="math notranslate nohighlight">\(V_\mathrm{sr}\)</span>)
it is clear that the intra-molecular potential varies faster than
the non-bonded components.
Running the whole simulation with a 2 fs time step would lead to major
instabilities in the trajectory.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(0)&quot;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">]</span>
    <span class="o">-</span> <span class="p">(</span><span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(0)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">])[</span><span class="mi">50</span><span class="p">],</span>
    <span class="s2">&quot;b-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{lr}</span><span class="s2">$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">][</span><span class="mi">50</span><span class="p">],</span>
    <span class="s2">&quot;r-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{sr}</span><span class="s2">$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$U$ / eV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_mts-rpc_001.png" srcset="../../_images/sphx_glr_mts-rpc_001.png" alt="mts rpc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7fdd5c6744d0&gt;
</pre></div>
</div>
<p>This can be made clearer by computing the autocorrelation function,
and seeing that the long-range term is that showing a slow decay, while
the short-range one decays quickly to zero, rapidly oscillating</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a simple wrapper to np.correlate to evaluate the autocorrelation function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">autocorrelate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the autocorrelation function of a trajectory.</span>
<span class="sd">    It can be given the exact average as a parameter&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">xbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xbar</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">acf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xbar</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xbar</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acf</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span> <span class="o">/</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">xbar</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xbar</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>


<span class="n">acf_vsr</span> <span class="o">=</span> <span class="n">autocorrelate</span><span class="p">(</span><span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">][</span><span class="mi">50</span><span class="p">:])</span>
<span class="n">acf_vlr</span> <span class="o">=</span> <span class="n">autocorrelate</span><span class="p">(</span>
    <span class="p">(</span><span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(0)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">])[</span><span class="mi">50</span><span class="p">:]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">acf_vsr</span><span class="p">)],</span>
    <span class="n">acf_vsr</span><span class="p">,</span>
    <span class="s2">&quot;r-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{sr}</span><span class="s2">$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">acf_vlr</span><span class="p">)],</span>
    <span class="n">acf_vlr</span><span class="p">,</span>
    <span class="s2">&quot;b-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{lr}</span><span class="s2">$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$c_</span><span class="si">{VV}</span><span class="s2">$&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_mts-rpc_002.png" srcset="../../_images/sphx_glr_mts-rpc_002.png" alt="mts rpc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(18.567, 0.5, &#39;$c_{VV}$&#39;)
</pre></div>
</div>
<p>The equilibration is slow due to the weak thermostat, but the two
trajectories both equilibrate to 300 K. The difference in potential
energy is not significant, because of the slow convergence of
the potential energy in liquid water.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MTS&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;c.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;U / eV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">mts_output</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MTS&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span> <span class="s2">&quot;m.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;T / K&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_mts-rpc_003.png" srcset="../../_images/sphx_glr_mts-rpc_003.png" alt="mts rpc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7fdd5c78ba50&gt;
</pre></div>
</div>
</section>
</section>
<section id="rpc-mts-simulation">
<h2>RPC/MTS simulation<a class="headerlink" href="#rpc-mts-simulation" title="Link to this heading">¶</a></h2>
<p>Now let’s get to the full beast. The input for the RCP/MTS simulation is
<cite>h2o_rpc-mts.xml</cite>. The setup is rather subtle,
because we will use the F90 driver that implements the full
q-TIP4P/f potential (with <cite>-m qtip4pf</cite>) and the intra-molecular part
(with <cite>-m qtip4pf-sr</cite>). This means that we will have to compute
the slowly-varying part as <span class="math notranslate nohighlight">\(V_\mathrm{full}-V_\mathrm{sr}\)</span>.
Let’s look at the key sections in the input file. Much as for the
MTS setup, the simulation includes two <cite>ffsocket</cite> sections
- one will be used with the <cite>qtip4pf</cite> driver and the other with <cite>qtip4pf-sr</cite>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open and read the XML file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/h2o_rpc-mts.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">13</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf&#39; pbc=&#39;false&#39;&gt;
    &lt;address&gt;qtip4pf-full&lt;/address&gt;
&lt;/ffsocket&gt;
&lt;ffsocket mode=&#39;unix&#39; name=&#39;qtip4pf-sr&#39; pbc=&#39;false&#39;&gt;
    &lt;address&gt;qtip4pf-sr&lt;/address&gt;
&lt;/ffsocket&gt;
</pre></div>
</div>
<p>The <cite>&lt;forces&gt;</cite> section is where the magic happens.
There are three components here.
The first computes a full <cite>qtip4pf</cite> potential,
and is computed on a contraction to 2 beads, as
indicated by the <cite>nbeads=’2’</cite> attribute.
A second component is also evaluated on a
contracted ring polymer, and is used to subtract
the short-range component to leave the (smoother) long-range part.
This is achieved linking to the <cite>qtip4pf-sr</cite> forcefield,
and using the attribute <cite>weight=’-1’</cite> to subtract the
term from the total potential.
Finally, there is another <cite>qtip4pf-sr</cite> component,
that is evaluated on the full <cite>nbeads=’8’</cite> ring polymer.
The result is a RPC setup in which the smooth
(Lennard-Jones + Coulomb) part of the potential
is contracted on 2 replicas, and the fast part is
computed on 8 replicas, which (thanks to the use of
a PIGLET thermostat) is enough to achieve a good
degree of convergence for water at 300 K.</p>
<p>Each <cite>&lt;force&gt;</cite> block also contains a <cite>&lt;mts_weights&gt;</cite> section,
which is different from that used for the MTS simulation, because
we now have a separate force component to subtract from the full
potential, which is computed on the contracted ring polymer.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">29</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;forces&gt;
  &lt;force forcefield=&#39;qtip4pf&#39; nbeads=&#39;2&#39;&gt;
     &lt;mts_weights&gt;[1,0]&lt;/mts_weights&gt;
  &lt;/force&gt;
  &lt;force forcefield=&#39;qtip4pf-sr&#39; nbeads=&#39;2&#39; weight=&#39;-1&#39;&gt;
     &lt;mts_weights&gt;[1,0]&lt;/mts_weights&gt;
  &lt;/force&gt;
  &lt;force forcefield=&#39;qtip4pf-sr&#39; nbeads=&#39;8&#39;&gt;
     &lt;mts_weights&gt;[0,1]&lt;/mts_weights&gt;
  &lt;/force&gt;
&lt;/forces&gt;
</pre></div>
</div>
<p>It remains to specify the MTS setup. In this case,
we use an outer time step of 1 fs (twice the typical
time step for room temperature water) and a splitting
with <cite>M=2</cite>, so the fast forces are computed every 0.5
fs. Compared to the classical MTS setup, we need a
finer-grained integration because of the ring-polymer
dynamics and because of the use of PIGLET, that requires
a short time step to integrate accurately the Generalized
Langevin equation. Still, even this splitting reduces by a
factor of 2 the evaluations of the long-range potential.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">34</span><span class="p">:</span><span class="mi">36</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;timestep units=&#39;femtosecond&#39;&gt; 1.0 &lt;/timestep&gt;
&lt;nmts&gt;[1,2]&lt;/nmts&gt;
</pre></div>
</div>
<p>Finally, we are ready to run! We launch i-PI, and then
execute two instances of the full potential
(using <cite>-m qtip4pf</cite> and the correct socket address)
and four instances of the short-range component,
that is evaluated on the full ring polymer.
This will take some time…
The correct <cite>bash</cite> commands are:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>i-pi<span class="w"> </span>h2o_rpc-mts.xml<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.rpc-mts<span class="w"> </span><span class="p">&amp;</span>
sleep<span class="w"> </span><span class="m">5</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span>i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf-full<span class="w"> </span>-m<span class="w"> </span>qtip4pf<span class="w"> </span>-v<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver-full.<span class="nv">$i</span><span class="w"> </span><span class="p">&amp;</span>
<span class="k">done</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">4</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span>i-pi-driver<span class="w"> </span>-u<span class="w"> </span>-a<span class="w"> </span>qtip4pf-sr<span class="w"> </span>-m<span class="w"> </span>qtip4pf-sr<span class="w"> </span>-v<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>log.driver-sr.<span class="nv">$i</span><span class="w"> </span><span class="p">&amp;</span>
<span class="k">done</span>
<span class="nb">wait</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ipi_process</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;rpc-mts.out&quot;</span><span class="p">):</span>
    <span class="n">ipi_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi&quot;</span><span class="p">,</span> <span class="s2">&quot;data/h2o_rpc-mts.xml&quot;</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># wait for i-PI to start</span>
    <span class="n">lmp_process0</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-full&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">lmp_process1</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;i-pi-driver&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-sr&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;qtip4pf-sr&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>If you run this in a notebook, you can go ahead and start loading
output files <em>before</em> i-PI and the drivers have finished running, by
skipping this cell</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ipi_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ipi_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">lmp_process0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">lmp_process0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">lmp_process1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<section id="id1">
<h3>Analysis of results<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>Let’s read the results from the reference and RPC/MTS
simulations and analyze them</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">pimd_output</span><span class="p">,</span> <span class="n">pimd_desc</span> <span class="o">=</span> <span class="n">ipi</span><span class="o">.</span><span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;pimd.out&quot;</span><span class="p">)</span>
<span class="n">rpcmts_output</span><span class="p">,</span> <span class="n">rpcmts_desc</span> <span class="o">=</span> <span class="n">ipi</span><span class="o">.</span><span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;rpc-mts.out&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s start looking at the long-range/contracted and short-range components
of the potential. Here the long-range part is the sum of the first two components
of the potential, since the second enters with a negative weight.
We don’t see a clear time-scale separation here, because of the very
aggressive PIGLET thermostat, that adds noise on top of the physical dynamics.
This is not a major issue, because it only affects the dynamics of the momenta,
but it means we cannot easily check for time scale separation
when using advanced thermostatting schemes.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
    <span class="p">(</span><span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(0)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">])</span>
    <span class="o">-</span> <span class="p">(</span><span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(0)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(1)&quot;</span><span class="p">])[</span><span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;b-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_{\mathrm</span><span class="si">{lr}</span><span class="s2">}$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
    <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(2)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;pot_component(2)&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;r-&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V_{\mathrm</span><span class="si">{sr}</span><span class="s2">}$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;U / eV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_mts-rpc_004.png" srcset="../../_images/sphx_glr_mts-rpc_004.png" alt="mts rpc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7fdd5c867f90&gt;
</pre></div>
</div>
<p>Simulations reach equilibrium faster than for the (weakly thermostatted)
classical simulation, and even though the agreement between PIMD and the
RPC+MTS run is not perfect, it is very good,
in comparison with the major discrepancy between classical and quantum averages.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pimd_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pimd_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PIMD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;m.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RPC-MTS&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;U / eV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">md_output</span><span class="p">[</span><span class="s2">&quot;kinetic_md&quot;</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pimd_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pimd_output</span><span class="p">[</span><span class="s2">&quot;kinetic_cv&quot;</span><span class="p">],</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PIMD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;kinetic_cv&quot;</span><span class="p">],</span> <span class="s2">&quot;m.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RPC-MTS&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;K / eV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_mts-rpc_005.png" srcset="../../_images/sphx_glr_mts-rpc_005.png" alt="mts rpc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7fdd5c751c10&gt;
</pre></div>
</div>
<p>RPC+MTS simulations generate
a distribution of structures at the highest path integral
resolution, and can be used to compute all sorts of
structural properties.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># loads structures, discarding unused atom properties</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;.*residuenumbers array.*&quot;</span><span class="p">)</span>
<span class="n">pi_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ipi</span><span class="o">.</span><span class="n">read_trajectory</span><span class="p">(</span><span class="s2">&quot;rpc-mts.pos_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.xyz&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
<span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx_f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pi_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pi_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx_f</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">pi_frames</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idx_f</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">f</span><span class="o">.</span><span class="n">arrays</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="s2">&quot;numbers&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">numbers</span><span class="p">}</span>
    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">structures</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][::</span><span class="mi">25</span><span class="p">],</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;ps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">][::</span><span class="mi">25</span><span class="p">],</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">rpcmts_output</span><span class="p">[</span><span class="s2">&quot;kinetic_cv&quot;</span><span class="p">][::</span><span class="mi">25</span><span class="p">],</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span>
        <span class="n">map_color</span><span class="o">=</span><span class="s2">&quot;U&quot;</span><span class="p">,</span>
        <span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;unitCell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<!-- begin headers -->
<!-- Load all dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

<!-- JS scripts -->
<script src="../../_static/chemiscope.min.js"></script>
<script src="../../_static/chemiscope-sphinx.js"></script>

<!-- CSS styles -->
<link rel="stylesheet" href="../../_static/chemiscope-sphinx.css" type="text/css" />
<!-- end headers -->

<!-- Error display -->
<div id="chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7-error-display" class="chemiscope-sphinx-error">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7-error-display')">
        &times;
    </button>
</div>

<!-- Warning Display -->
<div id="chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-f72115a5-4d4d-4002-a663-ad3b8c3293e7', '../../_datasets/168135e986c4add95852cddd24bccf0a06ac18002c3c3877c9f62120a3af1c35-fig_mts-rpc_001.json.gz', 'default', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (5 minutes 3.121 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-pi-mts-rpc-mts-rpc-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ecf3f0c862585110e82f591b4cf57eee/mts-rpc.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">mts-rpc.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ef9b190e8966c0ff6b18487e9472ae23/mts-rpc.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">mts-rpc.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4b5afdbd5bdb77214af297633a102c64/mts-rpc.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">mts-rpc.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../gaas-map/gaas-map.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">PCA/PCovR Visualization of a training dataset for a potential</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../metatomic-plumed/metatomic-plumed.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">ML collective variables in PLUMED with metatomic</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2026, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Multiple time stepping and ring-polymer contraction</a><ul>
<li><a class="reference internal" href="#multiple-time-stepping-in-real-and-imaginary-time">Multiple time stepping in real and imaginary time</a></li>
<li><a class="reference internal" href="#a-reference-calculation-using-piglet">A reference calculation using PIGLET</a><ul>
<li><a class="reference internal" href="#installing-the-python-driver">Installing the Python driver</a></li>
<li><a class="reference internal" href="#launch-the-i-pi-simulation">Launch the i-PI simulation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiple-time-stepping">Multiple time stepping</a><ul>
<li><a class="reference internal" href="#analysis-of-results">Analysis of results</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rpc-mts-simulation">RPC/MTS simulation</a><ul>
<li><a class="reference internal" href="#id1">Analysis of results</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=01c87ff6"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>