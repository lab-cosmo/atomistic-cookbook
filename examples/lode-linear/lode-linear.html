<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html"><link rel="next" title="Long-stride trajectories with a universal FlashMD model" href="../flashmd/flashmd-demo.html"><link rel="prev" title="Local Prediction Rigidity analysis" href="../lpr/lpr.html">
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/lode-linear/lode-linear.html">
        <link rel="prefetch" href="../../_static/cookbook-icon.svg" as="image">

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"><!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>Long-distance Equivariants: a tutorial - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input aria-label="Toggle navigation of Recipes grouped by topic" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/universal.html">Universal ML models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input aria-label="Toggle navigation of Recipes grouped by software used" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/eon.html">eon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/gromacs.html">GROMACS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input aria-label="Toggle navigation of List of all recipes" checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-model/water-model.html">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shiftml/shiftml-example.html">Computing NMR shielding tensors using ShiftML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft-nc.html">Conservative fine-tuning for a PET model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learn-tensors-with-mcov/learn-tensors-with-mcov.html">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eon-pet-neb/eon-pet-neb.html">Finding Reaction Paths with eOn and a Metatomic Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-finetuning/pet-ft.html">Fine-tuning the PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-nc/pet-mad-nc.html">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metatomic-plumed/metatomic-plumed.html">ML collective variables in PLUMED with metatomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-mts-rpc/mts-rpc.html">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ring-polymer-instanton/rpi-rates.html">Ring Polymer Instanton Rate Theory: Tunneling Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad-uq/pet-mad-uq.html">Uncertainty Quantification with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-pulsed/water-pulsed.html">Water orientation in a pulsed electric field</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-lode-linear-lode-linear-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="long-distance-equivariants-a-tutorial">
<span id="sphx-glr-examples-lode-linear-lode-linear-py"></span><h1>Long-distance Equivariants: a tutorial<a class="headerlink" href="#long-distance-equivariants-a-tutorial" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Philip Loche <a class="reference external" href="https://github.com/PicoCentauri/">&#64;PicoCentauri</a>,
Kevin Huguenin-Dumittan <a class="reference external" href="https://github.com/kvhuguenin">&#64;kvhuguenin</a></p>
</dd>
</dl>
<p>This tutorial explains how Long range equivariant descriptors can be constructed using
featomic and the resulting descriptors be used to construct a linear model with
equisolve</p>
<p>First, import all the necessary packages</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">metatensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">equisolve.numpy.models.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">equisolve.utils.convert</span><span class="w"> </span><span class="kn">import</span> <span class="n">ase_to_tensormap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">featomic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicComposition</span><span class="p">,</span> <span class="n">LodeSphericalExpansion</span><span class="p">,</span> <span class="n">SphericalExpansion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">featomic.clebsch_gordan</span><span class="w"> </span><span class="kn">import</span> <span class="n">PowerSpectrum</span>
</pre></div>
</div>
<section id="step-0-prepare-data-set">
<h2>Step 0: Prepare Data Set<a class="headerlink" href="#step-0-prepare-data-set" title="Link to this heading">¶</a></h2>
<section id="get-structures">
<h3>Get structures<a class="headerlink" href="#get-structures" title="Link to this heading">¶</a></h3>
<p>We take a small subset of the dimer dataset from <a class="reference external" href="https://pubs.rsc.org/en/content/articlelanding/2021/sc/d0sc04934d">A. Grisafi et al.,
2021</a>
for which we additionally calculated the forces. Each structure in the
dataset contains two small organic molecules which are extended along a
certain direction in the subsequent structures.</p>
<p>For speeding up the calculations we already selected the first 130
<a class="reference download internal" download="" href="../../_downloads/4cc6d7251cc20e13dd91e533c7271a6a/charge-charge.xyz"><code class="xref download docutils literal notranslate"><span class="pre">structures</span></code></a> of the charge-charge molecule
pairs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">frames</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;charge-charge.xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="convert-target-properties-to-metatensor-format">
<h3>Convert target properties to metatensor format<a class="headerlink" href="#convert-target-properties-to-metatensor-format" title="Link to this heading">¶</a></h3>
<p>If we want to train models using the
<a class="reference external" href="https://github.com/lab-cosmo/equisolve">equisolve</a> package, we need to
convert the target properties (in this case, the energies and forces)
into the appropriate format #justequistorethings</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">ase_to_tensormap</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">forces</span><span class="o">=</span><span class="s2">&quot;forces&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>rename to match new label conventions</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">yg</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span>
<span class="n">yb</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">TensorBlock</span><span class="p">(</span>
    <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span>
    <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
    <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">yb</span><span class="o">.</span><span class="n">add_gradient</span><span class="p">(</span>
    <span class="s2">&quot;positions&quot;</span><span class="p">,</span>
    <span class="n">metatensor</span><span class="o">.</span><span class="n">TensorBlock</span><span class="p">(</span>
        <span class="n">yg</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">yg</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span>
        <span class="p">[</span><span class="n">yg</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;xyz&quot;</span><span class="p">)],</span>
        <span class="n">yg</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">TensorMap</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="p">[</span><span class="n">yb</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="step-1-compute-short-range-and-lode-features">
<h2>Step 1: Compute short-range and LODE features<a class="headerlink" href="#step-1-compute-short-range-and-lode-features" title="Link to this heading">¶</a></h2>
<p>Define hypers and get the expansion coefficients <span class="math notranslate nohighlight">\(\langle anlm | \rho_i \rangle\)</span>
and <span class="math notranslate nohighlight">\(\langle anlm | V_i \rangle\)</span></p>
<p>The short-range and long-range descriptors have very similar hyperparameters. We
highlight the differences below.</p>
<p>We first define the hyperparameters for the short-range (SR) part. These will be used
to create SOAP features.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">SR_HYPERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;smoothing&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ShiftedCosine&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}},</span>
    <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
    <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TensorProduct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_angular&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;radial&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Gto&quot;</span><span class="p">,</span> <span class="s2">&quot;max_radial&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And next the hyperparaters for the LODE / long-range (LR) part</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">LR_HYPERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SmearedPowerLaw&quot;</span><span class="p">,</span> <span class="s2">&quot;smearing&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;exponent&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TensorProduct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_angular&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;radial&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Gto&quot;</span><span class="p">,</span> <span class="s2">&quot;max_radial&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We then use the above defined hyperparaters to define the per atom short range (sr)
and long range (sr) descriptors.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">calculator_sr</span> <span class="o">=</span> <span class="n">SphericalExpansion</span><span class="p">(</span><span class="o">**</span><span class="n">SR_HYPERS</span><span class="p">)</span>
<span class="n">calculator_lr</span> <span class="o">=</span> <span class="n">LodeSphericalExpansion</span><span class="p">(</span><span class="o">**</span><span class="n">LR_HYPERS</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that LODE requires periodic systems. Therefore, if the data set does not come
with periodic boundary conditions by default you can not use the data set and you will
face an error if you try to compute the features.</p>
<p>As you notices the calculation of the long range features takes significant more time
compared to the sr features.</p>
<p>Taking a look at the output we find that the resulting
<a class="reference external" href="https://docs.metatensor.org/latest/core/reference/python/tensor.html#metatensor.TensorMap" title="(in metatensor)"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatensor.TensorMap</span></code></a> are quite similar in their structure. The short range
<a class="reference external" href="https://docs.metatensor.org/latest/core/reference/python/tensor.html#metatensor.TensorMap" title="(in metatensor)"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatensor.TensorMap</span></code></a> contains more blocks due to the higher
<code class="docutils literal notranslate"><span class="pre">max_angular</span></code> parameter we chose above.</p>
<section id="generate-the-rotational-invariants-power-spectra">
<h3>Generate the rotational invariants (power spectra)<a class="headerlink" href="#generate-the-rotational-invariants-power-spectra" title="Link to this heading">¶</a></h3>
<p>Rotationally invariant features can be obtained by taking two of the calculators that
were defines above.</p>
<p>For the short-range part, we use the SOAP vector which is obtained by computing the
invariant combinations of the form <span class="math notranslate nohighlight">\(\rho \otimes \rho\)</span>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ps_calculator_sr</span> <span class="o">=</span> <span class="n">PowerSpectrum</span><span class="p">(</span><span class="n">calculator_sr</span><span class="p">,</span> <span class="n">calculator_sr</span><span class="p">)</span>
<span class="n">ps_sr</span> <span class="o">=</span> <span class="n">ps_calculator_sr</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">gradients</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>We calculate gradients with respect to pistions by providing the
<code class="docutils literal notranslate"><span class="pre">gradients=[&quot;positions&quot;]</span></code> option to the
<a class="reference external" href="http://docs.metatensor.org/featomic/latest/references/api/python/calculators.html#featomic.calculators.CalculatorBase.compute" title="(in Featomic)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">featomic.calculators.CalculatorBase.compute()</span></code></a> method.</p>
<p>For the long-range part, we combine the long-range descriptor <span class="math notranslate nohighlight">\(V\)</span> with one a
short-range density <span class="math notranslate nohighlight">\(\rho\)</span> to get <span class="math notranslate nohighlight">\(\rho \otimes V\)</span> features.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ps_calculator_lr</span> <span class="o">=</span> <span class="n">PowerSpectrum</span><span class="p">(</span><span class="n">calculator_sr</span><span class="p">,</span> <span class="n">calculator_lr</span><span class="p">)</span>
<span class="n">ps_lr</span> <span class="o">=</span> <span class="n">ps_calculator_lr</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">systems</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">gradients</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="step-2-building-a-simple-linear-sr-lr-model-with-energy-baselining">
<h2>Step 2: Building a Simple Linear SR + LR Model with energy baselining<a class="headerlink" href="#step-2-building-a-simple-linear-sr-lr-model-with-energy-baselining" title="Link to this heading">¶</a></h2>
<section id="preprocessing-model-dependent">
<h3>Preprocessing (model dependent)<a class="headerlink" href="#preprocessing-model-dependent" title="Link to this heading">¶</a></h3>
<p>For our current model, we do not wish to treat the individual center and
neighbor species separately. Thus, we move the <code class="docutils literal notranslate"><span class="pre">&quot;center_type&quot;</span></code> key
into the <code class="docutils literal notranslate"><span class="pre">atom</span></code> dimension, over which we will later sum over.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ps_sr</span> <span class="o">=</span> <span class="n">ps_sr</span><span class="o">.</span><span class="n">keys_to_samples</span><span class="p">(</span><span class="s2">&quot;center_type&quot;</span><span class="p">)</span>
<span class="n">ps_lr</span> <span class="o">=</span> <span class="n">ps_lr</span><span class="o">.</span><span class="n">keys_to_samples</span><span class="p">(</span><span class="s2">&quot;center_type&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For linear models only: Sum features up over atoms in the same
structure.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_names_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;center_type&quot;</span><span class="p">]</span>

<span class="n">ps_sr</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">sum_over_samples</span><span class="p">(</span><span class="n">ps_sr</span><span class="p">,</span> <span class="n">sample_names</span><span class="o">=</span><span class="n">sample_names_to_sum</span><span class="p">)</span>
<span class="n">ps_lr</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">sum_over_samples</span><span class="p">(</span><span class="n">ps_lr</span><span class="p">,</span> <span class="n">sample_names</span><span class="o">=</span><span class="n">sample_names_to_sum</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="initialize-tensormaps-for-energy-baselining">
<h3>Initialize tensormaps for energy baselining<a class="headerlink" href="#initialize-tensormaps-for-energy-baselining" title="Link to this heading">¶</a></h3>
<p>We add a simple extra descriptor <a class="reference external" href="http://docs.metatensor.org/featomic/latest/references/api/python/calculators.html#featomic.AtomicComposition" title="(in Featomic)"><code class="xref py py-class docutils literal notranslate"><span class="pre">featomic.AtomicComposition</span></code></a> that stores
how many atoms of each chemical species are contained in the structures. This is used
for energy baselining.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">calculator_co</span> <span class="o">=</span> <span class="n">AtomicComposition</span><span class="p">(</span><span class="n">per_system</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">descriptor_co</span> <span class="o">=</span> <span class="n">calculator_co</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">gradients</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">])</span>

<span class="n">co</span> <span class="o">=</span> <span class="n">descriptor_co</span><span class="o">.</span><span class="n">keys_to_properties</span><span class="p">([</span><span class="s2">&quot;center_type&quot;</span><span class="p">])</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">sum_over_samples</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">sample_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://docs.metatensor.org/featomic/latest/references/api/python/calculators.html#featomic.AtomicComposition" title="(in Featomic)"><code class="xref py py-class docutils literal notranslate"><span class="pre">featomic.AtomicComposition</span></code></a> calculator also allows to directly perform
the the sum over center atoms by using the following lines.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">descriptor_co</span> <span class="o">=</span> <span class="n">AtomicComposition</span><span class="p">(</span><span class="n">per_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">compute_args</span><span class="p">)</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">descriptor_co</span><span class="o">.</span><span class="n">keys_to_properties</span><span class="p">([</span><span class="s2">&quot;center_type&quot;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="stack-all-the-features-together-for-linear-model">
<h3>Stack all the features together for linear model<a class="headerlink" href="#stack-all-the-features-together-for-linear-model" title="Link to this heading">¶</a></h3>
<p>A linear model on SR + LR features can be thought of as a linear model
built on a feature vector that is simply the concatenation of the SR and
LR features.</p>
<p>Furthermore, energy baselining can be performed by concatenating the information about
chemical species as well. There is an metatensor function called
<a class="reference external" href="https://docs.metatensor.org/latest/operations/reference/manipulation/join.html#metatensor.join" title="(in metatensor)"><code class="xref py py-func docutils literal notranslate"><span class="pre">metatensor.join()</span></code></a> for this purpose. Formally, we can write for the SR
model.</p>
<p>X_sr: <span class="math notranslate nohighlight">\(1 \oplus \left(\rho \otimes \rho\right)\)</span></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_sr</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">co</span><span class="p">,</span> <span class="n">ps_sr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;properties&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We used the <code class="docutils literal notranslate"><span class="pre">axis=&quot;properties&quot;</span></code> parameter since we want to concatenate along the
features/properties dimensions.</p>
<p>For the long range model we can formerly write</p>
<p>X_lr: <span class="math notranslate nohighlight">\(1 \oplus \left(\rho \otimes \rho\right) \oplus \left(\rho \otimes
V\right)\)</span></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_lr</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">co</span><span class="p">,</span> <span class="n">ps_sr</span><span class="p">,</span> <span class="n">ps_lr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;properties&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The features are now ready! Let us now perform some actual learning. Below we
initialize two instances of the <code class="xref py py-class docutils literal notranslate"><span class="pre">equisolve.numpy.models.linear_model.Ridge</span></code>
class. <code class="xref py py-class docutils literal notranslate"><span class="pre">equisolve.numpy.models.linear_model.Ridge</span></code> will perform a regression
with respect to <code class="docutils literal notranslate"><span class="pre">&quot;values&quot;</span></code> (energies) and <code class="docutils literal notranslate"><span class="pre">&quot;positions&quot;</span></code> gradients (forces).</p>
<p>If you only want a fit with respect to energies you can remove the gradients with
<code class="docutils literal notranslate"><span class="pre">metatensor.remove_gradients()</span></code></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">clf_sr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">clf_lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="split-training-and-target-data-into-train-and-test-dat">
<h2>Split training and target data into train and test dat<a class="headerlink" href="#split-training-and-target-data-into-train-and-test-dat" title="Link to this heading">¶</a></h2>
<p>Split the training and the test data by the distance <span class="math notranslate nohighlight">\(r_{\rm
train}=6\,\mathrm{Å}\)</span> between the center of mass of the two molecules. A structure
with a <span class="math notranslate nohighlight">\(r_{\rm train}&lt;6 {\rm Å}\)</span> is used for training.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">r_cut</span> <span class="o">=</span> <span class="mf">6.0</span>
</pre></div>
</div>
<p>We calculate the indices from the dataset by list comprehension. The center of mass
distance is stored in the <code class="docutils literal notranslate"><span class="pre">&quot;distance&quot;&quot;</span></code> attribute.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">idx_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r_cut</span><span class="p">]</span>
<span class="n">idx_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r_cut</span><span class="p">]</span>
</pre></div>
</div>
<p>For doing the split we define two <code class="docutils literal notranslate"><span class="pre">Labels</span></code> instances and combine them in a
<code class="xref py py-class docutils literal notranslate"><span class="pre">List</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">samples_train</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">Labels</span><span class="p">([</span><span class="s2">&quot;system&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">idx_train</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">samples_test</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">Labels</span><span class="p">([</span><span class="s2">&quot;system&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">idx_test</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">grouped_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples_train</span><span class="p">,</span> <span class="n">samples_test</span><span class="p">]</span>
</pre></div>
</div>
<p>That we use as input to the <a class="reference external" href="https://docs.metatensor.org/latest/operations/reference/manipulation/split.html#metatensor.split" title="(in metatensor)"><code class="xref py py-func docutils literal notranslate"><span class="pre">metatensor.split()</span></code></a> function</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_sr_train</span><span class="p">,</span> <span class="n">X_sr_test</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
    <span class="n">X_sr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="n">grouped_labels</span>
<span class="p">)</span>

<span class="n">X_lr_train</span><span class="p">,</span> <span class="n">X_lr_test</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
    <span class="n">X_lr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="n">grouped_labels</span>
<span class="p">)</span>

<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="n">grouped_labels</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fit-the-model">
<h2>Fit the model<a class="headerlink" href="#fit-the-model" title="Link to this heading">¶</a></h2>
<p>For this model, we use a very simple regularization scheme where all features are
regularized in the same way (the amount being controlled by the parameter <code class="docutils literal notranslate"><span class="pre">alpha</span></code>).
For more advanced regularization schemes (regularizing energies and forces differently
and/or the SR and LR parts differently), see further down.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">clf_sr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_sr_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<span class="n">clf_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_lr_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;equisolve.numpy.models.linear_model.NumpyRidge object at 0x7f0541567790&gt;
</pre></div>
</div>
</section>
<section id="evaluation">
<h2>Evaluation<a class="headerlink" href="#evaluation" title="Link to this heading">¶</a></h2>
<p>For evaluating the model we calculate the RMSEs using the <code class="docutils literal notranslate"><span class="pre">score()</span></code> method. With the
<code class="docutils literal notranslate"><span class="pre">parameter_key</span></code> parameter we select which RMSE should be calculated.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;SR: RMSE energies = &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clf_sr</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_sr_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">parameter_key</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;SR: RMSE forces = &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clf_sr</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_sr_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">parameter_key</span><span class="o">=</span><span class="s1">&#39;positions&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV/Å&quot;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;LR: RMSE energies = &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clf_lr</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_lr_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">parameter_key</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;LR: RMSE forces = &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clf_lr</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_lr_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">parameter_key</span><span class="o">=</span><span class="s1">&#39;positions&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV/Å&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>SR: RMSE energies = 0.557 eV
SR: RMSE forces = 0.188 eV/Å
LR: RMSE energies = 0.272 eV
LR: RMSE forces = 0.155 eV/Å
</pre></div>
</div>
<p>We find that the RMSE of the energy and the force of the LR model is smaller compared
to the SR model. From this we conclude that the LR model performs better for the
selection of the dataset.</p>
<p>We additionally, can plot of the binding energy as a function of the distance. For the
plot we select some properties from the dataset</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">])</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">])</span>
<span class="n">monomer_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;energyA&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;energyB&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">])</span>
</pre></div>
</div>
<p>and select only the indices corresponding to our test set.</p>
<p>Next we calculate the predicted SR and LR <code class="docutils literal notranslate"><span class="pre">TensorMaps</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">y_sr_pred</span> <span class="o">=</span> <span class="n">clf_sr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_sr</span><span class="p">)</span>
<span class="n">y_lr_pred</span> <span class="o">=</span> <span class="n">clf_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_lr</span><span class="p">)</span>
</pre></div>
</div>
<p>And, finally perform the plot.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">dist</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">monomer_energies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;target data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">dist</span><span class="p">,</span>
    <span class="n">y_sr_pred</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">monomer_energies</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;short range model&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">dist</span><span class="p">,</span>
    <span class="n">y_lr_pred</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">monomer_energies</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;long range model&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;center of mass distance in Å&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E - E_\mathrm</span><span class="si">{monomer}</span><span class="s2">$ in eV&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_cut</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$r_\mathrm</span><span class="si">{train}</span><span class="s2">$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_lode-linear_001.png" srcset="../../_images/sphx_glr_lode-linear_001.png" alt="lode linear" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 10.011 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-lode-linear-lode-linear-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/87860011d67b243cba3a72df0fa64d08/lode-linear.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">lode-linear.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/89f739150c737d83b9f5bb306c62ba22/lode-linear.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">lode-linear.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/597d3fbd5c13b3195d61c3c1381648e5/lode-linear.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">lode-linear.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../flashmd/flashmd-demo.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Long-stride trajectories with a universal FlashMD model</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../lpr/lpr.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Local Prediction Rigidity analysis</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2026, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Long-distance Equivariants: a tutorial</a><ul>
<li><a class="reference internal" href="#step-0-prepare-data-set">Step 0: Prepare Data Set</a><ul>
<li><a class="reference internal" href="#get-structures">Get structures</a></li>
<li><a class="reference internal" href="#convert-target-properties-to-metatensor-format">Convert target properties to metatensor format</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-1-compute-short-range-and-lode-features">Step 1: Compute short-range and LODE features</a><ul>
<li><a class="reference internal" href="#generate-the-rotational-invariants-power-spectra">Generate the rotational invariants (power spectra)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-building-a-simple-linear-sr-lr-model-with-energy-baselining">Step 2: Building a Simple Linear SR + LR Model with energy baselining</a><ul>
<li><a class="reference internal" href="#preprocessing-model-dependent">Preprocessing (model dependent)</a></li>
<li><a class="reference internal" href="#initialize-tensormaps-for-energy-baselining">Initialize tensormaps for energy baselining</a></li>
<li><a class="reference internal" href="#stack-all-the-features-together-for-linear-model">Stack all the features together for linear model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#split-training-and-target-data-into-train-and-test-dat">Split training and target data into train and test dat</a></li>
<li><a class="reference internal" href="#fit-the-model">Fit the model</a></li>
<li><a class="reference internal" href="#evaluation">Evaluation</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=01c87ff6"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>